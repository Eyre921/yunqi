# 后端架构

<cite>
**本文档引用文件**  
- [auth.ts](file://src/lib/auth.ts)
- [middleware.ts](file://middleware.ts)
- [prisma.ts](file://src/lib/prisma.ts)
- [db-utils.ts](file://src/lib/db-utils.ts)
- [serialize.ts](file://src/lib/serialize.ts)
- [works/route.ts](file://src/app/api/works/route.ts)
- [admin/works/route.ts](file://src/app/api/admin/works/route.ts)
- [user/works/route.ts](file://src/app/api/user/works/route.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档旨在全面阐述基于 Next.js API 路由的后端架构设计，重点说明认证、管理接口与作品功能的模块化实现。通过分析中间件、认证机制、数据库访问模式及 RESTful 接口设计，为后端开发提供清晰的设计准则与最佳实践。

## 项目结构
项目采用标准的 Next.js App Router 结构，API 路由集中于 `src/app/api` 目录下，按功能划分为 `auth`、`admin`、`user` 和 `works` 等子模块。这种组织方式实现了职责分离，提升了代码可维护性。

```mermaid
graph TB
subgraph "API 路由"
A[/api/auth/.../]
B[/api/admin/.../]
C[/api/user/.../]
D[/api/works/.../]
end
subgraph "核心库"
E[auth.ts]
F[prisma.ts]
G[serialize.ts]
H[middleware.ts]
end
A --> E
B --> E
C --> E
D --> E
B --> F
C --> F
D --> F
A --> H
B --> H
C --> H
D --> H
```

**Diagram sources**
- [src/app/api](file://src/app/api)
- [middleware.ts](file://middleware.ts#L1-L50)

**Section sources**
- [middleware.ts](file://middleware.ts#L1-L50)
- [src/app/api](file://src/app/api)

## 核心组件
后端核心由认证系统、API 路由、Prisma 数据访问层和序列化工具构成。`auth.ts` 统一处理身份验证，`prisma.ts` 提供数据库连接实例，`serialize.ts` 确保安全的 JSON 序列化，共同支撑各 API 模块的运行。

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L1-L71)
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)
- [serialize.ts](file://src/lib/serialize.ts#L1-L52)

## 架构概览
系统采用分层架构，客户端请求经由中间件进行全局拦截与身份验证，随后路由至对应的 API 处理函数。所有数据操作通过 Prisma Client 与数据库交互，并使用统一的序列化函数处理响应数据。

```mermaid
graph TB
Client[客户端] --> Middleware[middleware.ts]
Middleware --> AuthCheck{认证检查}
AuthCheck --> |通过| APIRoute[API 路由]
AuthCheck --> |失败| Redirect[重定向]
APIRoute --> Prisma[prisma.ts]
Prisma --> DB[(数据库)]
APIRoute --> Serialize[serialize.ts]
Serialize --> Response[JSON 响应]
```

**Diagram sources**
- [middleware.ts](file://middleware.ts#L1-L50)
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)
- [serialize.ts](file://src/lib/serialize.ts#L1-L52)

## 详细组件分析

### 认证系统分析
认证系统基于 NextAuth.js 实现，采用 JWT 令牌策略，通过凭证提供者（Credentials Provider）验证用户邮箱与密码。用户角色信息被注入 JWT 令牌，用于后续的权限控制。

```mermaid
classDiagram
class authOptions {
+adapter : PrismaAdapter
+providers : CredentialsProvider[]
+session : {strategy : 'jwt'}
+callbacks : {jwt(), session()}
+pages : {signIn : '/auth/signin'}
+secret : string
}
class CredentialsProvider {
+name : 'credentials'
+credentials : {email, password}
+authorize(credentials) : User | null
}
class jwtCallback {
+jwt({token, user}) : JWT
+session({session, token}) : Session
}
authOptions --> CredentialsProvider : 包含
authOptions --> jwtCallback : 使用回调
```

**Diagram sources**
- [auth.ts](file://src/lib/auth.ts#L1-L71)

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L1-L71)

### 中间件请求流程分析
中间件实现全局请求拦截，根据用户认证状态和角色进行访问控制与重定向。管理员访问管理页面需具备 ADMIN 角色，普通用户访问认证页面后将被重定向至首页。

```mermaid
flowchart TD
Start([请求进入]) --> AuthCheck["检查认证状态"]
AuthCheck --> IsAuth{"已认证?"}
IsAuth --> |否| RedirectLogin["重定向到登录页"]
IsAuth --> |是| PageType["判断页面类型"]
PageType --> IsAuthPage{"认证页面?"}
IsAuthPage --> |是| RoleCheck["检查用户角色"]
RoleCheck --> IsAdmin{"管理员?"}
IsAdmin --> |是| RedirectAdmin["重定向到管理页面"]
IsAdmin --> |否| RedirectHome["重定向到首页"]
PageType --> IsAdminPage{"管理页面?"}
IsAdminPage --> |是| CheckAdminRole["验证管理员权限"]
CheckAdminRole --> |无权限| RedirectHome
PageType --> IsProfilePage{"个人中心?"}
IsProfilePage --> |未认证| RedirectLogin
PageType --> IsUploadPage{"上传页面?"}
IsUploadPage --> |游客可访问| Continue["继续请求"]
RedirectLogin --> End([响应])
RedirectHome --> End
RedirectAdmin --> End
Continue --> End
```

**Diagram sources**
- [middleware.ts](file://middleware.ts#L1-L50)

**Section sources**
- [middleware.ts](file://middleware.ts#L1-L50)

### 作品列表获取流程分析
用户获取作品列表的请求流程展示了从 API 路由到数据库查询再到响应序列化的完整链条。该流程遵循 RESTful 设计原则，并包含统一的错误处理机制。

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API路由
participant Auth as 认证中间件
participant Prisma as Prisma Client
participant DB as 数据库
participant Serialize as 序列化工具
Client->>API : GET /api/works
API->>Auth : 请求拦截
Auth-->>API : 认证通过
API->>Prisma : 查询作品列表
Prisma->>DB : 执行SQL查询
DB-->>Prisma : 返回数据
Prisma-->>API : 返回作品列表
API->>Serialize : 序列化响应数据
Serialize-->>API : 返回安全JSON
API-->>Client : 返回200 OK + 数据
```

**Diagram sources**
- [works/route.ts](file://src/app/api/works/route.ts#L1-L207)
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)
- [serialize.ts](file://src/lib/serialize.ts#L1-L52)

**Section sources**
- [works/route.ts](file://src/app/api/works/route.ts#L1-L207)

## 依赖分析
后端组件间依赖关系清晰，API 路由依赖认证和数据库访问服务，中间件依赖认证配置，所有数据操作最终通过 Prisma Client 与数据库交互。

```mermaid
graph TD
A[API路由] --> B[auth.ts]
A --> C[prisma.ts]
A --> D[serialize.ts]
E[middleware.ts] --> B
B --> C
C --> F[(数据库)]
```

**Diagram sources**
- [package.json](file://package.json)
- [middleware.ts](file://middleware.ts#L1-L50)

**Section sources**
- [package.json](file://package.json)
- [middleware.ts](file://middleware.ts#L1-L50)

## 性能考虑
- 使用 Prisma Client 单例模式减少数据库连接开销
- 在查询中合理使用 `include` 和 `select` 以减少数据传输量
- 通过分页（pagination）避免一次性加载过多数据
- 利用 `Promise.all` 并行执行独立的数据库查询

## 故障排除指南
- **认证失败**：检查 `authOptions` 配置及环境变量 `NEXTAUTH_SECRET`
- **数据库连接错误**：确认 `DATABASE_URL` 配置正确
- **类型错误**：如 `withAuth` 函数类型不匹配，确保 `context` 参数为可选
- **上传功能异常**：检查 `uploadConfig` 表是否存在且配置正确

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L1-L71)
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)
- [src/nextjs15-type-fixes-report.md](file://src/nextjs15-type-fixes-report.md)

## 结论
本项目通过 Next.js API 路由构建了结构清晰、职责分明的后端服务。采用 NextAuth.js 实现安全的认证机制，结合中间件进行全局访问控制，利用 Prisma 提供高效的数据访问，并通过统一的序列化和错误处理规范确保 API 的一致性与可靠性。该架构为后续功能扩展提供了坚实的基础。