# 数据库集成

<cite>
**本文档引用文件**  
- [prisma.ts](file://src/lib/prisma.ts)
- [db-utils.ts](file://src/lib/db-utils.ts)
- [schema.prisma](file://prisma/schema.prisma)
- [seed.ts](file://prisma/seed.ts)
- [route.ts](file://src/app/api/online-counter/route.ts)
</cite>

## 目录
1. [引言](#引言)
2. [Prisma客户端初始化与连接管理](#prisma客户端初始化与连接管理)
3. [核心数据模型与关系](#核心数据模型与关系)
4. [数据库迁移与版本控制](#数据库迁移与版本控制)
5. [通用数据库查询工具](#通用数据库查询工具)
6. [数据初始化与种子数据](#数据初始化与种子数据)
7. [高效查询实践与性能优化](#高效查询实践与性能优化)
8. [异常处理与连接池配置](#异常处理与连接池配置)
9. [总结](#总结)

## 引言

本项目采用Prisma ORM作为全栈应用的核心数据库集成方案，提供类型安全、直观易用的数据访问接口。Prisma不仅简化了数据库操作，还通过其强大的迁移系统和类型生成机制，确保开发与生产环境的一致性。本文档详细阐述Prisma在项目中的关键作用，涵盖客户端初始化、数据模型设计、迁移管理、工具封装、性能优化及异常处理等核心方面。

## Prisma客户端初始化与连接管理

为避免在开发环境下因热重载导致的数据库连接泄漏，项目采用全局单例模式初始化`PrismaClient`。通过将Prisma实例挂载到全局对象`globalThis`上，确保在Node.js运行时中仅存在一个客户端实例。

在生产环境中，每次请求都会创建新的Prisma客户端实例；而在开发环境中，利用热重载特性复用已创建的实例，从而避免连接数持续增长。连接字符串通过环境变量`DATABASE_URL`注入，支持连接池参数配置（如`connection_limit`），实现资源的高效利用。

```mermaid
flowchart TD
A[应用启动] --> B{环境判断}
B --> |开发环境| C[检查全局实例]
C --> D{实例存在?}
D --> |是| E[复用全局Prisma实例]
D --> |否| F[创建新实例并挂载到global]
B --> |生产环境| G[每次请求创建新实例]
E --> H[返回PrismaClient]
F --> H
G --> H
```

**Diagram sources**  
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)

**Section sources**  
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)

## 核心数据模型与关系

`schema.prisma`文件定义了系统的实体模型及其关系，采用清晰的DSL语法描述数据库结构。主要模型包括用户（User）、作品（Work）、平台配置（PlatformConfig）、上传配置（UploadConfig）和在线人数配置（OnlineCounterConfig）等。

### 主要实体关系说明

- **User 与 Work**：一对多关系，一个用户可上传多个作品，使用可选外键`userId`关联。
- **User 与 UploadConfig / OnlineCounterConfig**：一对多关系，通过显式`@relation`命名管理创建者关联。
- **WorkStatus 枚举**：定义作品的审核状态（待审核、已通过、已拒绝），确保数据一致性。
- **软删除机制**：`Work`模型中的`isDeleted`字段用于逻辑删除，避免数据丢失。

```mermaid
erDiagram
USER ||--o{ WORK : "上传"
USER ||--o{ UploadConfig : "创建"
USER ||--o{ OnlineCounterConfig : "创建"
PlatformConfig ||--|| USER : "拥有"
USER {
String id PK
String email UK
String name
Role role
DateTime createdAt
DateTime updatedAt
}
WORK {
String id PK
String name
String title
String author
WorkStatus status
Int likeCount
Int viewCount
Boolean isDeleted
DateTime createdAt
DateTime approvedAt
String userId FK
}
UploadConfig {
String id PK
Boolean isEnabled
DateTime startTime
DateTime endTime
Int maxUploadsPerUser
Int maxFileSize
String[] allowedFormats
String createdBy FK
DateTime createdAt
DateTime updatedAt
}
OnlineCounterConfig {
String id PK
Int currentCount
Int baseCount
Int maxCount
Float growthRate
Boolean isEnabled
String displayText
DateTime lastUpdated
String createdBy FK
DateTime createdAt
DateTime updatedAt
}
PlatformConfig {
String id PK
String title
DateTime createdAt
DateTime updatedAt
}
enum Role {
USER
ADMIN
}
enum WorkStatus {
PENDING
APPROVED
REJECTED
}
```

**Diagram sources**  
- [schema.prisma](file://prisma/schema.prisma#L30-L168)

**Section sources**  
- [schema.prisma](file://prisma/schema.prisma#L30-L168)

## 数据库迁移与版本控制

项目使用Prisma Migrate进行数据库版本管理，确保开发、测试与生产环境的数据库结构一致。每次数据模型变更后，通过`prisma migrate dev`命令生成迁移脚本，自动创建对应的SQL文件并更新数据库。

迁移文件存储在`prisma/migrations/`目录下，按时间戳命名，包含完整的SQL语句。该机制支持团队协作开发，所有成员可通过`prisma migrate deploy`同步最新数据库结构，避免手动修改导致的不一致问题。

当前迁移历史包括：
- 添加作品精选标记字段
- 增加在线人数配置模型
- 添加平台配置模型
- 补充缺失字段（如`rejectReason`）

## 通用数据库查询工具

`db-utils.ts`封装了一系列常用的数据库操作函数，提升API开发效率，减少重复代码。这些工具函数基于Prisma客户端构建，提供语义化接口。

### 主要工具函数

| 函数名 | 功能描述 | 查询条件 |
|--------|--------|--------|
| `getPopularWorks` | 获取热门作品（按点赞、浏览、创建时间排序） | 状态为APPROVED且未删除 |
| `getLatestWorks` | 获取最新通过的作品 | 按审核时间倒序 |
| `incrementViewCount` | 增加作品浏览数 | 使用`update`原子操作 |
| `incrementLikeCount` | 增加作品点赞数 | 使用`increment`操作 |
| `getWorkStats` | 获取作品统计信息（总数、各状态数量） | 并行执行多个`count`查询 |

这些工具函数被多个API路由复用，如作品列表、用户中心、管理后台等，确保数据访问逻辑的一致性。

```mermaid
flowchart LR
A[API路由] --> B[调用db-utils函数]
B --> C[执行Prisma查询]
C --> D[返回数据]
B --> |getPopularWorks| E[排序: 点赞↓, 浏览↓, 创建时间↓]
B --> |incrementViewCount| F[原子更新viewCount]
B --> |getWorkStats| G[并行count查询]
```

**Diagram sources**  
- [db-utils.ts](file://src/lib/db-utils.ts#L1-L67)

**Section sources**  
- [db-utils.ts](file://src/lib/db-utils.ts#L1-L67)

## 数据初始化与种子数据

`seed.ts`脚本用于初始化数据库种子数据，支持开发环境快速搭建和测试场景准备。脚本通过`PrismaClient`插入预设的用户和作品数据，包含不同角色、状态和关联关系。

### 种子数据特点

- 创建管理员与普通用户账号（含加密密码）
- 插入多件作品，涵盖“已通过”、“待审核”、“已拒绝”三种状态
- 随机生成大量测试作品，模拟真实数据分布
- 支持幂等操作：使用`upsert`避免重复插入
- 输出统计信息与测试账号，便于开发调试

种子数据通过`npx prisma db seed`命令执行，也可在CI/CD流程中用于初始化测试数据库。

**Section sources**  
- [seed.ts](file://prisma/seed.ts#L1-L318)

## 高效查询实践与性能优化

项目遵循Prisma最佳实践，确保数据库查询高效稳定。

### 分页加载示例（作品列表）

```ts
prisma.work.findMany({
  where: { status: 'APPROVED', isDeleted: false },
  orderBy: { approvedAt: 'desc' },
  skip: (page - 1) * pageSize,
  take: pageSize,
  include: { user: true } // 仅在需要时关联用户信息
});
```

### 聚合统计查询

```ts
Promise.all([
  prisma.work.count({ where: { status: 'APPROVED' } }),
  prisma.work.count({ where: { status: 'PENDING' } })
]); // 并行执行，提升效率
```

### 性能调优建议

1. **索引优化**：在高频查询字段（如`status`, `createdAt`, `userId`）上创建数据库索引。
2. **避免N+1查询**：使用`include`或`select`一次性获取关联数据，而非循环查询。
3. **字段选择**：使用`select`仅获取必要字段，减少数据传输量。
4. **批量操作**：使用`createMany`、`updateMany`等批量方法提升性能。
5. **连接池配置**：在`DATABASE_URL`中设置`connection_limit`以控制最大连接数。

## 异常处理与连接池配置

### 异常处理模式

项目统一捕获`PrismaClientKnownRequestError`处理数据库层面的错误，如记录不存在（P2025）、唯一约束冲突等。在API路由中通过`instanceof`判断错误类型，返回结构化错误响应。

```ts
if (error instanceof PrismaClientKnownRequestError) {
  return NextResponse.json({
    success: false,
    error: '数据库操作失败',
    code: 'DATABASE_ERROR'
  }, { status: 500 });
}
```

此模式确保前端能准确识别错误类型，提升用户体验与调试效率。

### 连接池配置

连接池通过数据库连接字符串配置，例如：

```
postgresql://user:password@localhost:5432/db?connection_limit=10&pool_timeout=20
```

合理设置连接数上限和超时时间，防止数据库连接耗尽，尤其在高并发场景下至关重要。

**Section sources**  
- [route.ts](file://src/app/api/online-counter/route.ts#L3-L188)
- [prisma.ts](file://src/lib/prisma.ts#L1-L20)

## 总结

本项目通过Prisma ORM实现了高效、安全、可维护的数据库集成。从单例客户端管理到数据模型设计，从自动化迁移到工具函数封装，形成了完整的数据访问体系。结合合理的性能优化与异常处理机制，确保了系统在高并发场景下的稳定性与可扩展性。未来可进一步引入Prisma Accelerate或Query Engine日志监控，持续提升数据库性能。