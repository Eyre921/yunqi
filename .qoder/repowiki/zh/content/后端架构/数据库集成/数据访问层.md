# 数据访问层

<cite>
**本文档引用的文件**
- [prisma.ts](file://src/lib/prisma.ts)
- [db-utils.ts](file://src/lib/db-utils.ts)
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts)
- [works/[id]/like/route.ts](file://src/app/api/works/[id]/like/route.ts)
- [works/[id]/view/route.ts](file://src/app/api/works/[id]/view/route.ts)
- [works/[id]/route.ts](file://src/app/api/works/[id]/route.ts)
- [admin/works/[id]/approve/route.ts](file://src/app/api/admin/works/[id]/approve/route.ts)
- [user/profile/route.ts](file://src/app/api/user/profile/route.ts)
</cite>

## 目录
1. [引言](#引言)
2. [Prisma客户端初始化与连接管理](#prisma客户端初始化与连接管理)
3. [数据库操作辅助函数](#数据库操作辅助函数)
4. [API路由中的数据库操作实践](#api路由中的数据库操作实践)
5. [异常处理策略](#异常处理策略)
6. [连接池配置与性能调优](#连接池配置与性能调优)
7. [事务与日志记录](#事务与日志记录)
8. [结论](#结论)

## 引言
本文档详细阐述了数字化作品互动展示平台的数据访问层设计与实现。重点介绍Prisma ORM在Next.js应用中的初始化机制、连接管理策略、通用数据库操作封装以及在API路由中的安全使用方法。文档还涵盖了异常处理、性能优化和事务管理等关键主题，为开发者提供全面的数据库访问指导。

## Prisma客户端初始化与连接管理

为了防止在Next.js开发模式下因热重载导致的Prisma客户端实例重复创建和数据库连接泄漏问题，项目采用了全局单例模式来管理PrismaClient实例。

```mermaid
flowchart TD
A[应用启动] --> B{环境判断}
B --> |开发环境| C[检查全局对象是否存在prisma实例]
B --> |生产环境| D[直接创建新实例]
C --> E{存在实例?}
E --> |是| F[复用现有实例]
E --> |否| G[创建新实例并存入全局对象]
F --> H[返回prisma实例]
G --> H
D --> H
```

**图示来源**
- [prisma.ts](file://src/lib/prisma.ts#L0-L19)

**本节来源**
- [prisma.ts](file://src/lib/prisma.ts#L0-L19)

## 数据库操作辅助函数

项目在`db-utils.ts`中封装了一系列通用的数据库操作辅助函数，提升API路由开发效率，避免重复代码。

### 热门作品获取
```mermaid
flowchart TD
A[调用getPopularWorks] --> B[构建Prisma查询]
B --> C[筛选条件: status=APPROVED, isDeleted=false]
C --> D[排序: likeCount降序, viewCount降序, createdAt降序]
D --> E[限制返回数量]
E --> F[执行查询并返回结果]
```

### 最新作品获取
```mermaid
flowchart TD
A[调用getLatestWorks] --> B[构建Prisma查询]
B --> C[筛选条件: status=APPROVED, isDeleted=false]
C --> D[排序: approvedAt降序]
D --> E[限制返回数量]
E --> F[执行查询并返回结果]
```

### 作品统计信息
```mermaid
flowchart TD
A[调用getWorkStats] --> B[并行执行四个count查询]
B --> C1[统计总数]
B --> C2[统计待审核数]
B --> C3[统计已通过数]
B --> C4[统计已拒绝数]
C1 --> D[聚合结果]
C2 --> D
C3 --> D
C4 --> D
D --> E[返回统计对象]
```

**图示来源**
- [db-utils.ts](file://src/lib/db-utils.ts#L4-L67)

**本节来源**
- [db-utils.ts](file://src/lib/db-utils.ts#L4-L67)

## API路由中的数据库操作实践

### 增删改查操作示例

#### 创建操作
在用户注册API中，使用`prisma.user.create`创建新用户：
- [register/route.ts](file://src/app/api/register/route.ts#L39-L53)

#### 读取操作
在获取作品详情API中，使用`prisma.work.findUnique`获取单个作品：
- [works/[id]/route.ts](file://src/app/api/works/[id]/route.ts#L217-L229)

#### 更新操作
在点赞API中，使用`prisma.work.update`原子性地增加点赞数：
- [works/[id]/like/route.ts](file://src/works/[id]/like/route.ts#L35-L45)

#### 删除操作
在删除作品API中，使用`prisma.work.delete`从数据库移除记录：
- [works/[id]/route.ts](file://src/app/api/works/[id]/route.ts#L313-L318)

### 连接管理最佳实践
所有数据库操作都通过单例的`prisma`实例进行，无需手动创建或释放连接。Prisma会自动管理连接池，开发者只需关注业务逻辑。

**本节来源**
- [works/[id]/like/route.ts](file://src/app/api/works/[id]/like/route.ts#L17-L20)
- [works/[id]/view/route.ts](file://src/app/api/works/[id]/view/route.ts#L17-L20)
- [works/[id]/route.ts](file://src/app/api/works/[id]/route.ts#L118-L120)

## 异常处理策略

### PrismaClientKnownRequestError处理
项目在多个API路由中捕获`PrismaClientKnownRequestError`并映射为业务逻辑响应。

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API路由
participant Prisma as PrismaClient
Client->>API : 发送请求
API->>Prisma : 执行数据库操作
alt 操作成功
Prisma-->>API : 返回数据
API-->>Client : 200 OK + 数据
else 操作失败
Prisma-->>API : 抛出PrismaClientKnownRequestError
API->>API : 捕获异常并判断类型
API-->>Client : 500 Internal Server Error + 错误信息
end
```

在在线人数API中，明确捕获并处理数据库错误：
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts#L85-L89)

在用户信息更新API中，处理邮箱冲突的特殊情况：
- [user/profile/route.ts](file://src/app/api/user/profile/route.ts#L177-L194)

**图示来源**
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts#L3-L188)
- [user/profile/route.ts](file://src/app/api/user/profile/route.ts#L217-L235)

**本节来源**
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts#L85-L89)
- [user/profile/route.ts](file://src/app/api/user/profile/route.ts#L177-L194)

## 连接池配置与性能调优

### 连接池配置
Prisma的连接池配置通过数据库连接字符串中的参数进行控制，而非在代码中配置。例如：
```
postgresql://user:password@localhost:5432/db?connection_limit=10
```

### 性能优化实践
1. **批量操作**：使用`Promise.all`并行执行多个count查询
   - [db-utils.ts](file://src/lib/db-utils.ts#L58-L67)

2. **字段选择**：使用`select`选项只获取必要字段，减少数据传输量
   - [works/[id]/like/route.ts](file://src/app/api/works/[id]/like/route.ts#L17-L20)

3. **原生查询**：对于复杂统计，使用`$queryRaw`执行原生SQL
   - [admin/stats/route.ts](file://src/app/api/admin/stats/route.ts#L53-L63)

**本节来源**
- [db-utils.ts](file://src/lib/db-utils.ts#L58-L67)
- [admin/stats/route.ts](file://src/app/api/admin/stats/route.ts#L53-L63)

## 事务与日志记录

### 事务管理
虽然当前代码示例中未直接展示事务使用，但Prisma提供了`$transaction`方法用于确保多个数据库操作的原子性。建议在需要保证数据一致性的场景（如余额变更、库存扣减）中使用事务。

### 错误日志记录
项目在所有API路由中都实现了统一的错误日志记录：
- 使用`console.error`记录详细的错误信息
- 在开发环境中返回详细的错误详情
- 在生产环境中仅返回通用错误信息，避免敏感信息泄露

日志记录模式在多个API路由中保持一致：
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts#L81-L83)
- [works/[id]/like/route.ts](file://src/app/api/works/[id]/like/route.ts#L60-L62)

**本节来源**
- [online-counter/route.ts](file://src/app/api/online-counter/route.ts#L81-L83)
- [works/[id]/like/route.ts](file://src/app/api/works/[id]/like/route.ts#L60-L62)

## 结论
本项目通过精心设计的数据访问层，实现了高效、安全、可维护的数据库操作。Prisma客户端的单例模式有效解决了Next.js开发环境下的连接泄漏问题，而`db-utils.ts`中的辅助函数则大大提升了开发效率。统一的异常处理策略和性能优化实践确保了系统的稳定性和响应速度。未来可进一步引入事务管理来增强数据一致性保障。