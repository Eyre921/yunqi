# 迁移与种子数据

<cite>
**本文档引用的文件**   
- [seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)
- [20250831084947_add_featured_field\migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [20250905143157_add_online_counter_config\migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [20250905150839_add_platform_config\migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [20250917050212_add_missing_fields\migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)
</cite>

## 目录
1. [迁移管理](#迁移管理)
2. [种子数据管理](#种子数据管理)
3. [最佳实践](#最佳实践)

## 迁移管理

Prisma Migrate 是本项目中用于数据库版本控制的核心工具。每次数据库模式变更都会生成一个带有时间戳的迁移文件，存储在 `prisma/migrations` 目录下。这些迁移文件包含纯 SQL 脚本，确保了数据库变更的可追溯性和可重复性。

首次迁移 `20250831084947_add_featured_field` 创建了所有核心数据库表，包括 `users`、`works`、`accounts` 等。该迁移脚本定义了 `Role` 和 `WorkStatus` 枚举类型，并建立了表之间的外键关系，例如 `works` 表通过 `userId` 字段关联到 `users` 表。后续的迁移文件则基于此基础进行增量修改。

`20250905143157_add_online_counter_config` 迁移引入了 `online_counter_configs` 表，用于管理在线计数器的配置。该表包含 `currentCount`、`baseCount`、`growthRate` 等字段，支持动态调整计数器的行为。`20250905150839_add_platform_config` 迁移创建了 `platform_configs` 表，用于存储平台的全局配置，如页面标题。最新的 `20250917050212_add_missing_fields` 迁移通过 `ALTER TABLE` 语句为 `works` 表添加了 `fileSize`、`imagePath`、`mimeType`、`ossKey`、`ossUrl` 和 `tags` 等缺失字段，以支持更完善的文件管理和元数据存储。

在生产环境中应用这些变更时，应使用 `prisma migrate deploy` 命令。该命令会安全地将迁移历史与数据库状态进行比对，并仅应用尚未执行的迁移，确保生产数据库的稳定性和一致性。

**Section sources**
- [20250831084947_add_featured_field\migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [20250905143157_add_online_counter_config\migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [20250905150839_add_platform_config\migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [20250917050212_add_missing_fields\migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)

## 种子数据管理

`prisma/seed.ts` 文件负责初始化数据库的种子数据。该脚本首先创建一组测试用户，包括管理员账号（`admin@yunqi.com`）和普通用户账号（如 `user1@yunqi.com`），并为每个用户生成加密的密码。随后，脚本创建了多个作品数据，涵盖“已通过”、“待审核”和“已拒绝”三种状态，以模拟真实的应用场景。

种子数据的构建逻辑非常清晰。脚本使用 `prisma.user.upsert()` 和 `prisma.work.create()` 方法来创建或更新记录。对于作品数据，脚本不仅填充了基本的标题、描述和作者信息，还根据状态设置了 `approvedAt` 或 `rejectedAt` 时间戳以及 `rejectReason`。为了生成大规模的测试数据，脚本使用循环和随机函数批量创建了50个作品，其中70%的状态为“已通过”，20%为“待审核”，10%为“已拒绝”，从而构建了一个具有真实分布的数据集。

种子任务可以通过 `package.json` 中定义的 `db:seed` 脚本自动化执行。运行 `npm run db:seed` 命令会调用 `tsx prisma/seed.ts`，执行整个种子数据初始化流程。该脚本在开发和测试环境中非常有用，可以快速将数据库恢复到一个已知的、包含丰富测试数据的状态。

**Section sources**
- [seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)

## 最佳实践

在进行数据库迁移时，应遵循以下最佳实践以确保数据安全和流程顺畅。首先，在执行任何迁移之前，务必备份数据库。其次，将迁移检查集成到 CI/CD 流程中，可以在代码合并前自动验证迁移脚本的正确性，防止引入破坏性变更。应避免在迁移脚本中编写复杂的业务逻辑，迁移应专注于模式变更，而数据处理应放在独立的种子或数据迁移脚本中。

对于大规模测试场景，可以扩展 `seed.ts` 脚本以支持更复杂的数据生成逻辑。例如，可以引入自定义的数据生成工具来创建具有特定关联关系或符合特定分布规律的测试数据。此外，可以将种子数据的生成过程参数化，允许通过命令行参数控制生成的数据量和类型，从而更灵活地满足不同测试需求。

**Section sources**
- [seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)