# 数据库迁移与种子数据

<cite>
**本文档引用的文件**
- [migration_lock.toml](file://prisma/migrations/migration_lock.toml)
- [seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)
- [add_featured_field/migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)
- [README.md](file://README.md)
</cite>

## 目录
1. [引言](#引言)
2. [数据库迁移机制](#数据库迁移机制)
3. [迁移脚本分析](#迁移脚本分析)
4. [种子数据管理](#种子数据管理)
5. [生产环境最佳实践](#生产环境最佳实践)
6. [结论](#结论)

## 引言
本文档详细说明了数字化作品互动展示平台的数据库迁移与种子数据管理机制。通过Prisma ORM实现数据库模式的演进和数据初始化，确保开发、测试和生产环境的数据一致性。文档涵盖了迁移命令的使用、迁移锁定机制、现有迁移脚本的结构分析、种子数据的编写规范以及生产环境的最佳实践。

## 数据库迁移机制

### 迁移命令详解
项目使用Prisma Migrate进行数据库模式管理，主要涉及两个核心命令：

- `npx prisma migrate dev`：用于开发环境的数据库迁移。该命令会根据Prisma Schema的变更创建新的迁移文件，并将其应用到数据库中。在开发过程中，当修改数据模型时，运行此命令可同步数据库结构。

- `npx prisma migrate deploy`：用于生产环境的数据库部署。该命令会应用所有未执行的迁移，确保生产数据库与最新的模式定义保持一致。与开发命令不同，部署命令不会创建新的迁移文件。

**Section sources**
- [README.md](file://README.md#L73-L73)

### 迁移锁定机制
`migration_lock.toml`文件是Prisma迁移系统的关键组成部分，用于确保迁移历史的一致性。该文件记录了当前使用的数据库提供程序，防止在不同数据库类型之间意外迁移。

```toml
# 请勿手动编辑此文件
# 应将其添加到版本控制系统中（如Git）
provider = "postgresql"
```

该文件的主要作用包括：
- **一致性保障**：确保所有开发人员使用相同的数据库提供程序
- **版本控制**：作为迁移历史的一部分进行版本管理
- **冲突预防**：防止因数据库类型不匹配导致的迁移错误

**Diagram sources**
- [migration_lock.toml](file://prisma/migrations/migration_lock.toml#L1-L3)

**Section sources**
- [migration_lock.toml](file://prisma/migrations/migration_lock.toml#L1-L3)

## 迁移脚本分析

### featured字段添加迁移
`20250831084947_add_featured_field`迁移脚本是项目最早的数据库迁移，包含了完整的数据库模式定义。该迁移创建了核心数据表，包括用户、作品、账户和会话等。

关键特性：
- 创建`Role`和`WorkStatus`枚举类型
- 定义`users`、`works`、`accounts`等核心表
- 在`works`表中添加`featured`布尔字段，默认值为false
- 建立表间外键关系

```sql
-- CreateTable
CREATE TABLE "works" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "author" TEXT NOT NULL,
    "prompt" TEXT,
    "imageUrl" TEXT NOT NULL,
    "status" "WorkStatus" NOT NULL DEFAULT 'PENDING',
    "featured" BOOLEAN NOT NULL DEFAULT false,
    -- 其他字段...
);
```

**Diagram sources**
- [add_featured_field/migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql#L1-L123)

**Section sources**
- [add_featured_field/migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql#L1-L123)

### online_counter_config添加迁移
`20250905143157_add_online_counter_config`迁移脚本引入了在线计数器配置功能，支持动态显示平台活跃用户数。

主要变更：
- 创建`online_counter_configs`表
- 定义计数器的当前值、基础值、最大值等参数
- 设置默认的显示文本"人正在云栖大会创作"

```sql
-- CreateTable
CREATE TABLE "online_counter_configs" (
    "id" TEXT NOT NULL,
    "currentCount" INTEGER NOT NULL DEFAULT 1075,
    "baseCount" INTEGER NOT NULL DEFAULT 1000,
    "maxCount" INTEGER NOT NULL DEFAULT 2000,
    "growthRate" DOUBLE PRECISION NOT NULL DEFAULT 0.5,
    "isEnabled" BOOLEAN NOT NULL DEFAULT true,
    "displayText" TEXT NOT NULL DEFAULT '人正在云栖大会创作',
    -- 其他字段...
);
```

**Diagram sources**
- [add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql#L1-L20)

**Section sources**
- [add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql#L1-L20)

### platform_config添加迁移
`20250905150839_add_platform_config`迁移脚本添加了平台配置表，用于存储全局平台设置。

核心功能：
- 创建`platform_configs`表
- 存储平台标题等基本信息
- 支持未来扩展更多平台级配置

```sql
-- CreateTable
CREATE TABLE "platform_configs" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL DEFAULT 'Qoder和通义灵码 AI Coding 作品秀',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
);
```

**Diagram sources**
- [add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql#L1-L10)

**Section sources**
- [add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql#L1-L10)

### 缺失字段补充迁移
`20250917050212_add_missing_fields`迁移脚本通过`ALTER TABLE`语句为现有表添加了缺失的字段，体现了数据库模式的渐进式演进。

新增字段：
- `fileSize`：记录文件大小
- `imagePath`：存储图片路径
- `mimeType`：记录MIME类型
- `ossKey`和`ossUrl`：支持对象存储集成
- `tags`：支持作品标签功能

```sql
-- AlterTable
ALTER TABLE "works" ADD COLUMN     "fileSize" BIGINT,
ADD COLUMN     "imagePath" TEXT,
ADD COLUMN     "mimeType" TEXT,
ADD COLUMN     "ossKey" TEXT,
ADD COLUMN     "ossUrl" TEXT,
ADD COLUMN     "tags" TEXT[] DEFAULT ARRAY[]::TEXT[];
```

**Diagram sources**
- [add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql#L1-L8)

**Section sources**
- [add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql#L1-L8)

## 种子数据管理

### 种子数据编写规范
`seed.ts`文件定义了数据库初始化数据的生成逻辑，遵循以下规范：

- **异步操作顺序**：使用`async/await`确保操作的顺序执行
- **数据依赖处理**：先创建用户，再创建依赖用户ID的作品
- **环境判断逻辑**：使用`upsert`操作避免重复数据

```typescript
// 创建用户账号
const createdUsers = [];
for (const userData of users) {
  const hashedPassword = await bcrypt.hash(userData.password, 12);
  
  const user = await prisma.user.upsert({
    where: { email: userData.email },
    update: {
      name: userData.name,
      role: userData.role,
      password: hashedPassword,
    },
    create: {
      email: userData.email,
      name: userData.name,
      role: userData.role,
      password: hashedPassword,
    },
  });
  
  createdUsers.push(user);
}
```

**Section sources**
- [seed.ts](file://prisma/seed.ts#L1-L319)

### 种子数据执行流程
种子数据的执行流程包括：

1. 清理现有数据（可选）
2. 创建测试用户账号
3. 创建详细的作品数据
4. 批量生成更多测试作品
5. 输出统计信息和测试账号

```typescript
// 统计信息
const totalUsers = await prisma.user.count();
const totalWorks = await prisma.work.count();
const approvedWorks = await prisma.work.count({ where: { status: WorkStatus.APPROVED } });

console.log('\n=== 数据库种子数据初始化完成 ===');
console.log(`总用户数: ${totalUsers}`);
console.log(`总作品数: ${totalWorks}`);
console.log(`  - 已通过: ${approvedWorks}`);
```

**Section sources**
- [seed.ts](file://prisma/seed.ts#L282-L318)

### package.json中的种子脚本配置
`package.json`文件中配置了种子数据的执行脚本，确保安全执行：

```json
{
  "scripts": {
    "db:seed": "tsx prisma/seed.ts"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

执行命令：
```bash
npx prisma db seed
```

**Section sources**
- [package.json](file://package.json#L1-L61)

## 生产环境最佳实践

### 迁移回滚策略
生产环境的迁移回滚需要谨慎操作：

1. **备份数据库**：在执行任何迁移前进行完整备份
2. **测试回滚**：在预发布环境验证回滚流程
3. **使用迁移历史**：通过`prisma migrate status`检查迁移状态
4. **逐步回滚**：按逆序逐个应用回滚迁移

### 冲突解决方法
处理迁移冲突的推荐方法：

- **开发环境**：使用`prisma migrate reset`重置数据库
- **团队协作**：确保所有成员同步最新的迁移文件
- **分支管理**：在功能分支上创建迁移，合并前解决冲突
- **代码审查**：对迁移文件进行严格的代码审查

### 生产环境迁移建议
1. **预检查**：使用`prisma migrate status`验证迁移状态
2. **维护窗口**：在低峰期执行数据库迁移
3. **监控**：迁移后监控应用性能和错误日志
4. **回退计划**：准备完整的回退方案
5. **验证**：迁移后验证关键功能的正常运行

## 结论
本指南详细阐述了数字化作品互动展示平台的数据库迁移与种子数据管理机制。通过Prisma Migrate实现安全、可靠的数据库模式演进，利用结构化的种子数据确保开发环境的一致性。遵循本文档的最佳实践，可以有效管理数据库变更，保障数据完整性，支持项目的持续发展。