# 快速上手

<cite>
**本文档中引用的文件**   
- [package.json](file://package.json)
- [prisma/seed.ts](file://prisma/seed.ts)
- [run-oss-test.js](file://run-oss-test.js)
- [src/lib/oss.ts](file://src/lib/oss.ts)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts)
- [next.config.ts](file://next.config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [克隆仓库并安装依赖](#克隆仓库并安装依赖)
4. [配置环境变量](#配置环境变量)
5. [数据库初始化](#数据库初始化)
6. [启动开发服务器](#启动开发服务器)
7. [运行测试脚本验证OSS连接](#运行测试脚本验证oss连接)
8. [常见问题排查](#常见问题排查)
9. [完整功能体验流程](#完整功能体验流程)
10. [结论](#结论)

## 简介
本文档为开发者提供从零开始搭建本地开发环境的完整指南。目标是在30分钟内完成环境配置，确保新成员能够快速投入开发。涵盖环境准备、依赖安装、数据库初始化、服务启动、OSS连接测试及完整功能流程验证。

## 环境准备
在开始之前，请确保您的开发机器已安装以下基础环境：

- **Node.js**: 版本 18 或更高（推荐使用 LTS 版本）
- **包管理工具**: `npm` 或 `pnpm`（建议使用 pnpm 以提升依赖管理效率）
- **PostgreSQL 数据库**: 本地安装或使用 Docker 启动

验证命令：
```bash
node --version
npm --version
pg_ctl --version
```

**Section sources**
- [package.json](file://package.json)

## 克隆仓库并安装依赖
1. 克隆项目仓库：
```bash
git clone https://github.com/your-org/yunqi.git
cd yunqi
```

2. 安装项目依赖：
```bash
npm install
# 或使用 pnpm
pnpm install
```

该步骤将根据 `package.json` 文件安装所有必要的依赖项，包括 Next.js、Prisma、ali-oss 等核心库。

**Section sources**
- [package.json](file://package.json)

## 配置环境变量
项目使用 `.env` 文件管理环境变量。请创建 `.env.local` 文件，并填写以下关键配置：

```env
DATABASE_URL=postgresql://username:password@localhost:5432/yunqi_dev
ALI_OSS_REGION=oss-cn-hangzhou
ALI_OSS_ACCESS_KEY_ID=your-access-key-id
ALI_OSS_ACCESS_KEY_SECRET=your-access-key-secret
ALI_OSS_BUCKET=your-bucket-name
ALI_OSS_ENDPOINT=https://your-bucket.oss-cn-hangzhou.aliyuncs.com
NEXTAUTH_SECRET=generate-a-random-string-here
```

### 环境变量说明：
- **DATABASE_URL**: PostgreSQL 数据库连接字符串，格式为 `postgresql://用户:密码@主机:端口/数据库名`
- **ALI_OSS_REGION**: 阿里云 OSS 区域代码（如 `oss-cn-hangzhou`）
- **ALI_OSS_ACCESS_KEY_ID / SECRET**: 阿里云访问密钥对
- **ALI_OSS_BUCKET**: 存储空间名称
- **ALI_OSS_ENDPOINT**: 自定义或默认的 OSS 访问域名
- **NEXTAUTH_SECRET**: NextAuth.js 用于签名 JWT 和加密会话的密钥，可通过 `openssl rand -base64 32` 生成

**Section sources**
- [package.json](file://package.json)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [src/lib/oss.ts](file://src/lib/oss.ts)

## 数据库初始化
使用 Prisma 进行数据库迁移和种子数据填充：

1. 执行数据库迁移：
```bash
npx prisma migrate dev --name init
```

2. 初始化种子数据：
```bash
npm run db:seed
# 或直接执行
npx tsx prisma/seed.ts
```

此脚本将创建管理员和普通用户账号，并填充测试作品数据，便于后续功能验证。

**Section sources**
- [prisma/seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)

## 启动开发服务器
启动本地开发服务器：
```bash
npm run dev
```

服务启动后，默认监听 `http://localhost:3000`。您可以通过访问健康检查接口验证服务状态：

```bash
curl http://localhost:3000/api/health
```

预期返回：
```json
{
  "success": true,
  "message": "API服务正常",
  "timestamp": "2025-09-20T10:00:00.000Z",
  "database": "connected"
}
```

**Section sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts)
- [package.json](file://package.json)

## 运行测试脚本验证OSS连接
运行内置的 OSS 连接测试脚本，验证阿里云对象存储配置是否正确：

```bash
npm run test:oss
# 或直接执行
node run-oss-test.js
```

该脚本将依次执行以下操作：
- 验证环境变量完整性
- 创建测试文件并上传
- 下载验证内容
- 生成签名 URL
- 删除测试文件

若所有步骤均显示 ✅，则表示 OSS 配置成功。

**Section sources**
- [run-oss-test.js](file://run-oss-test.js)
- [src/lib/oss.ts](file://src/lib/oss.ts)

## 常见问题排查
### 数据库连接失败
- **问题**: `PrismaClientInitializationError: Can't reach database server`
- **解决方案**:
  1. 检查 PostgreSQL 服务是否已启动：`pg_ctl status`
  2. 验证 `DATABASE_URL` 中的用户名、密码、端口是否正确
  3. 确保数据库已创建：`createdb yunqi_dev`

### 数据库迁移错误
- **问题**: `Migration failed on the database`
- **解决方案**:
  1. 清理本地迁移历史（仅开发环境）：
     ```bash
     rm -rf prisma/migrations
     npx prisma migrate dev --name init
     ```
  2. 检查数据库用户权限是否足够

### OSS连接失败
- **问题**: `AccessDenied` 或 `NoSuchBucket`
- **解决方案**:
  1. 检查 `ALI_OSS_ACCESS_KEY_ID` 和 `SECRET` 是否具有对应 Bucket 的读写权限
  2. 验证 `ALI_OSS_BUCKET` 名称是否准确无误
  3. 确认 `ALI_OSS_REGION` 与 Bucket 所在区域一致

**Section sources**
- [prisma/seed.ts](file://prisma/seed.ts)
- [run-oss-test.js](file://run-oss-test.js)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)

## 完整功能体验流程
1. 访问应用首页：`http://localhost:3000`
2. 使用测试账号登录：
   - 管理员：`admin@yunqi.com / 123456`
   - 普通用户：`user1@yunqi.com / 123456`
3. 上传一个测试作品：
   - 点击“上传”按钮
   - 选择本地图片文件
   - 填写作品信息并提交
4. 验证功能：
   - 作品是否成功显示在个人主页
   - 是否可通过 OSS 签名 URL 访问
   - 管理员能否在后台审核该作品

通过以上流程，您已完整体验平台核心功能。

**Section sources**
- [src/app/page.tsx](file://src/app/page.tsx)
- [src/app/upload/page.tsx](file://src/app/upload/page.tsx)
- [src/app/api/upload/route.ts](file://src/app/api/upload/route.ts)

## 结论
本文档提供了从环境准备到功能验证的完整开发环境搭建流程。按照步骤操作，开发者可在30分钟内完成本地环境配置，并通过测试脚本和实际操作验证系统各组件正常运行。建议将此流程纳入新成员入职文档，提升团队开发效率。