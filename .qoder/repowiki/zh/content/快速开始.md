# 快速开始

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [package.json](file://package.json)
- [prisma/seed.ts](file://prisma/seed.ts)
- [next.config.ts](file://next.config.ts)
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [src/lib/oss.ts](file://src/lib/oss.ts)
- [src/lib/auth.ts](file://src/lib/auth.ts)
- [ecosystem.config.js](file://ecosystem.config.js)
- [verify-database.ts](file://verify-database.ts)
- [src/数字化作品互动展示平台 - 开发文档.md](file://src/数字化作品互动展示平台 - 开发文档.md)
- [src/测试脚本登陆方式.md](file://src/测试脚本登陆方式.md)
- [src/nextjs15-type-fixes-report.md](file://src/nextjs15-type-fixes-report.md)
</cite>

## 目录
1. [简介](#简介)
2. [环境要求](#环境要求)
3. [初始化步骤](#初始化步骤)
4. [配置环境变量](#配置环境变量)
5. [数据库设置](#数据库设置)
6. [启动开发服务器](#启动开发服务器)
7. [构建生产版本](#构建生产版本)
8. [常见问题排查](#常见问题排查)
9. [附录](#附录)

## 简介

本指南旨在帮助新开发者快速搭建本地开发环境，成功运行“数字化作品互动展示平台”项目。通过逐步说明克隆仓库、安装依赖、配置环境、运行数据库迁移和种子数据等操作，确保您能在10分钟内完成本地实例的初始化。

## 环境要求

在开始之前，请确保您的开发环境满足以下要求：

- **Node.js**: 18.0 或更高版本
- **npm**: 包管理工具（建议使用最新稳定版）
- **PostgreSQL**: 数据库服务（本地或远程均可）
- **Git**: 版本控制工具

您可以通过以下命令验证环境是否正确安装：

```bash
node --version
npm --version
git --version
```

## 初始化步骤

### 1. 克隆项目仓库

首先，使用 Git 克隆项目到本地：

```bash
git clone <repository-url>
cd yunqi
```

### 2. 安装项目依赖

运行以下命令安装所有必要的 npm 依赖包：

```bash
npm install
```

该命令将根据 `package.json` 文件自动下载并配置所有依赖项。

**Section sources**
- [package.json](file://package.json)

## 配置环境变量

### 创建环境配置文件

项目使用 `.env.local` 文件存储环境变量。请复制示例文件并进行编辑：

```bash
cp .env.example .env.local
```

> **注意**：`.env.example` 文件未在当前上下文中找到，但根据 `README.md` 指示，应存在此模板文件。若无，请手动创建 `.env.local` 并参考以下内容填写。

### 必需的环境变量

请在 `.env.local` 中配置以下关键变量：

```env
# 数据库连接
DATABASE_URL="postgresql://username:password@localhost:5432/yunqi"

# NextAuth 配置
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"

# 文件上传路径
UPLOAD_DIR="./public/uploads"

# OSS 对象存储配置（如启用）
ALI_OSS_REGION="your-region"
ALI_OSS_ACCESS_KEY_ID="your-access-key-id"
ALI_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
ALI_OSS_BUCKET="your-bucket-name"
ALI_OSS_ENDPOINT="https://your-endpoint"
```

**Section sources**
- [README.md](file://README.md#L70-L90)
- [src/lib/oss.ts](file://src/lib/oss.ts#L6-L10)

## 数据库设置

### 运行数据库迁移

使用 Prisma 进行数据库模式同步：

```bash
npx prisma migrate dev --name init
```

此命令将根据 `prisma/schema.prisma` 定义创建或更新数据库结构。

### 生成 Prisma 客户端

确保 Prisma 客户端代码是最新的：

```bash
npx prisma generate
```

### 填充种子数据（可选）

运行种子脚本以初始化测试用户和作品数据：

```bash
npx prisma db seed
```

该命令会执行 `prisma/seed.ts` 脚本，创建管理员账号（admin@yunqi.com / 123456）及示例作品。

```mermaid
flowchart TD
Start([开始]) --> CheckDB["检查数据库连接"]
CheckDB --> Migrate["运行 Prisma 迁移"]
Migrate --> Generate["生成 Prisma 客户端"]
Generate --> Seed["执行种子脚本"]
Seed --> End([数据库初始化完成])
```

**Diagram sources**
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [prisma/seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json#L10-L12)

**Section sources**
- [README.md](file://README.md#L92-L103)
- [package.json](file://package.json#L10-L12)

## 启动开发服务器

完成上述步骤后，启动本地开发服务器：

```bash
npm run dev
```

服务将在 `http://localhost:3000` 启动。打开浏览器访问该地址即可查看应用。

如需使用 PM2 管理进程，可运行：

```bash
pm2 start ecosystem.config.js --only yunqi-platform-dev
```

**Section sources**
- [package.json](file://package.json#L5)
- [ecosystem.config.js](file://ecosystem.config.js)

## 构建生产版本

当需要部署时，构建生产优化版本：

```bash
npm run build
```

构建完成后，可通过以下命令启动生产服务器：

```bash
npm start
```

**Section sources**
- [package.json](file://package.json#L6-L7)

## 常见问题排查

### 数据库连接失败

**症状**：Prisma 报错 `P1001` 或连接超时。

**解决方案**：
1. 检查 `DATABASE_URL` 是否正确（用户名、密码、主机、端口）
2. 确认 PostgreSQL 服务正在运行
3. 使用 `npx prisma db pull` 测试连接
4. 查看 `verify-database.ts` 脚本进行诊断：

```bash
npx tsx verify-database.ts
```

**Section sources**
- [verify-database.ts](file://verify-database.ts)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)

### 环境变量缺失

**症状**：应用启动时报错 `env is not defined` 或认证失败。

**解决方案**：
1. 确保 `.env.local` 文件存在且命名正确
2. 检查变量名拼写是否与代码中一致（如 `NEXTAUTH_SECRET`）
3. 重启开发服务器使环境变量生效

### 种子数据执行失败

**症状**：`prisma db seed` 报错或用户未创建。

**解决方案**：
1. 确保已运行 `prisma generate`
2. 检查 `prisma/seed.ts` 是否有语法错误
3. 确认数据库已迁移至最新状态

```mermaid
flowchart LR
A[问题] --> B{数据库连接失败?}
B --> |是| C[检查DATABASE_URL和PostgreSQL服务]
B --> |否| D{环境变量缺失?}
D --> |是| E[检查.env.local文件配置]
D --> |否| F{种子失败?}
F --> |是| G[确认迁移完成并检查seed.ts]
F --> |否| H[查看日志定位具体错误]
```

**Diagram sources**
- [verify-database.ts](file://verify-database.ts)
- [prisma/seed.ts](file://prisma/seed.ts)

## 附录

### 测试账号信息

初始化后可用的测试账号如下：

| 角色 | 邮箱 | 密码 |
|------|------|------|
| 管理员 | admin@yunqi.com | 123456 |
| 副管理员 | admin2@yunqi.com | 123456 |
| 普通用户 | user1@yunqi.com | 123456 |
| 艺术家 | artist1@yunqi.com | 123456 |

**Section sources**
- [prisma/seed.ts](file://prisma/seed.ts#L10-L50)

### 参考文档

- [数字化作品互动展示平台 - 开发文档.md](file://src/数字化作品互动展示平台 - 开发文档.md)
- [测试脚本登陆方式.md](file://src/测试脚本登陆方式.md)
- [nextjs15-type-fixes-report.md](file://src/nextjs15-type-fixes-report.md)