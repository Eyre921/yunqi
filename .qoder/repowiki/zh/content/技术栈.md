# 技术栈

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [next.config.ts](file://next.config.ts)
- [tailwind.config.js](file://tailwind.config.js)
- [ecosystem.config.js](file://ecosystem.config.js)
- [prisma.ts](file://src/lib/prisma.ts)
- [auth.ts](file://src/lib/auth.ts)
- [ThemeContext.tsx](file://src/contexts/ThemeContext.tsx)
- [tsconfig.json](file://tsconfig.json)
- [middleware.ts](file://middleware.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心框架](#核心框架)
3. [状态管理](#状态管理)
4. [样式方案](#样式方案)
5. [数据库ORM](#数据库orm)
6. [身份认证](#身份认证)
7. [编程语言](#编程语言)
8. [构建与部署工具](#构建与部署工具)
9. [其他关键依赖](#其他关键依赖)
10. [本地开发环境搭建指南](#本地开发环境搭建指南)

## 简介
本项目“数字化作品互动展示平台”采用现代化全栈技术栈构建，旨在提供一个高性能、可扩展且易于维护的Web应用架构。技术选型围绕Next.js生态展开，结合TypeScript、Prisma、NextAuth.js等主流工具，确保开发效率与系统稳定性。本文档详细记录各技术组件的版本、配置要点及在项目中的角色，帮助新开发者快速理解架构并搭建本地开发环境。

## 核心框架

### Next.js 15
作为项目的核心框架，Next.js 15 提供了服务端渲染（SSR）、静态生成（SSG）和API路由等关键功能，极大提升了应用性能和SEO能力。其App Router架构支持嵌套路由、并行路由和流式渲染，为复杂页面结构提供了灵活的组织方式。

项目通过 `next.config.ts` 进行定制化配置，包括图片优化、CORS头设置、缓存策略等。例如，配置了WebP和AVIF格式支持，并通过 `remotePatterns` 允许加载任意远程图片资源。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L68)
- [package.json](file://package.json#L10-L11)

### React 19
项目采用 React 19，利用其最新的并发渲染能力提升用户体验。React Server Components（RSC）在App Router中被广泛使用，减少了客户端JavaScript负载，加快了首屏加载速度。同时，客户端组件通过 `'use client'` 显式声明，确保交互逻辑正常运行。

**Section sources**
- [package.json](file://package.json#L12-L13)

## 状态管理

### Context API
项目使用 React 的 Context API 实现全局状态管理，特别是在主题切换功能中。`ThemeContext` 封装了主题状态（light/dark）及其变更逻辑，并通过 `ThemeProvider` 组件提供给整个应用使用。该方案避免了状态提升的复杂性，同时保持轻量级。

状态持久化通过 `localStorage` 实现，系统偏好通过 `matchMedia` 监听，确保用户体验一致。

```mermaid
classDiagram
class ThemeContext {
+theme : 'light' | 'dark'
+toggleTheme() : void
+setTheme(theme) : void
}
ThemeProvider --> ThemeContext : 提供
Component --> ThemeContext : 消费
```

**Diagram sources**
- [ThemeContext.tsx](file://src/contexts/ThemeContext.tsx#L1-L77)

**Section sources**
- [ThemeContext.tsx](file://src/contexts/ThemeContext.tsx#L1-L77)

## 样式方案

### Tailwind CSS
项目采用 Tailwind CSS 作为原子化CSS框架，结合PostCSS和Autoprefixer实现高效的样式开发。通过 `tailwind.config.js` 扩展了动画功能，实现了作品滚动展示的 `marquee` 动画效果。

配置中启用了 `@tailwindcss/line-clamp` 插件，用于文本截断处理，并通过 `darkMode: 'class'` 支持暗色主题切换。

**Section sources**
- [tailwind.config.js](file://tailwind.config.js#L1-L25)
- [package.json](file://package.json#L38-L39)

## 数据库ORM

### Prisma
Prisma 作为数据库ORM，提供类型安全的数据库访问接口。项目使用 `@prisma/client` 与PostgreSQL数据库交互，并通过 `PrismaClient` 单例模式管理连接，避免开发环境下的内存泄漏问题。

`prisma.ts` 文件中通过全局变量缓存实例，确保热重载时不会创建多个客户端。数据库连接URL通过环境变量注入，支持连接池配置。

```mermaid
sequenceDiagram
participant App as 应用
participant Prisma as PrismaClient
participant DB as 数据库
App->>Prisma : 查询用户
Prisma->>DB : 执行SQL
DB-->>Prisma : 返回结果
Prisma-->>App : 返回类型安全对象
```

**Diagram sources**
- [prisma.ts](file://src/lib/prisma.ts#L6-L17)

**Section sources**
- [prisma.ts](file://src/lib/prisma.ts#L1-L19)
- [package.json](file://package.json#L14-L15)

## 身份认证

### NextAuth.js
NextAuth.js 提供完整的身份认证解决方案，集成Prisma适配器实现用户数据持久化。项目采用凭证登录（Credentials Provider），通过bcrypt哈希验证密码，并在JWT令牌中携带用户角色（role）信息，用于权限控制。

认证配置通过 `authOptions` 导出，包含会话策略、回调函数和登录页面重定向等设置。中间件（middleware.ts）基于认证状态实现路由保护，如管理员页面访问控制。

```mermaid
sequenceDiagram
participant User as 用户
participant Auth as NextAuth
participant DB as 数据库
User->>Auth : 提交邮箱密码
Auth->>DB : 查询用户
DB-->>Auth : 返回用户数据
Auth->>Auth : bcrypt验证密码
Auth-->>User : 返回JWT令牌
```

**Diagram sources**
- [auth.ts](file://src/lib/auth.ts#L7-L71)

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L1-L71)
- [middleware.ts](file://middleware.ts#L1-L50)

## 编程语言

### TypeScript
项目全程使用 TypeScript 开发，确保类型安全并提升代码可维护性。通过 `tsconfig.json` 配置严格模式（strict: true），启用ES模块解析，并设置路径别名 `@/*` 指向 `src` 目录，简化模块导入。

类型定义文件（如 `next-auth.d.ts`）用于扩展第三方库类型，确保类型系统完整。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L1-L41)
- [package.json](file://package.json#L32-L37)

## 构建与部署工具

### PM2（通过ecosystem.config.js）
PM2 作为进程管理工具，通过 `ecosystem.config.js` 配置生产与开发环境的应用启动参数。生产环境使用 `npm start` 启动构建后的应用，开发环境使用 `npm run dev` 并启用文件监听。

配置包含日志路径、内存限制、自动重启策略，并支持集群模式部署。部署脚本集成Git推送后的自动安装、构建与重启流程。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L109)
- [package.json](file://package.json#L5-L6)

## 其他关键依赖

| 依赖包 | 版本 | 用途说明 |
|--------|------|----------|
| ali-oss | ^6.23.0 | 阿里云OSS SDK，用于图片上传与管理 |
| bcryptjs | ^2.4.3 | 用户密码哈希加密 |
| axios | ^1.11.0 | HTTP客户端，用于API调用 |
| react-hot-toast | ^2.6.0 | 轻量级通知提示组件 |
| zod | ^4.1.5 | 数据验证与解析库 |
| dotenv | ^17.2.2 | 环境变量加载 |

**Section sources**
- [package.json](file://package.json#L16-L31)

## 本地开发环境搭建指南

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd yunqi
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **配置环境变量**
   创建 `.env` 文件，包含：
   ```
   DATABASE_URL=postgresql://user:password@localhost:5432/yunqi
   NEXTAUTH_SECRET=your-secret-key
   NEXTAUTH_URL=http://localhost:3000
   ALI_OSS_REGION=your-region
   ALI_OSS_ACCESS_KEY_ID=your-key
   ALI_OSS_ACCESS_KEY_SECRET=your-secret
   ```

4. **数据库初始化**
   ```bash
   npx prisma db push
   npx prisma db seed
   ```

5. **启动开发服务器**
   ```bash
   npm run dev
   ```

6. **（可选）使用PM2启动**
   ```bash
   npm install -g pm2
   pm2 start ecosystem.config.js --only yunqi-platform-dev
   ```

访问 `http://localhost:3001` 查看应用。

**Section sources**
- [package.json](file://package.json#L5-L11)
- [.env.example](file://.env.example) （未在结构中列出，但通常存在）