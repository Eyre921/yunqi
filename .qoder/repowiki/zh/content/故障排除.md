# 故障排除

<cite>
**本文档中引用的文件**   
- [nextjs15-build-error.md](file://log/nextjs15-build-error.md)
- [online-counter-issue.md](file://log/online-counter-issue.md)
- [random-likes-feature.md](file://log/random-likes-feature.md)
- [debug-form-init.js](file://scripts/debug-form-init.js) - *重构调试脚本，替代旧的数据库验证功能*
- [signin/page.tsx](file://src/app/auth/signin/page.tsx)
- [upload/page.tsx](file://src/app/upload/page.tsx)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx)
- [route.ts](file://src/app/api/online-counter/route.ts)
- [route.ts](file://src/app/api/admin/works/[id]/route.ts)
- [edit/route.ts](file://src/app/api/admin/works/[id]/edit/route.ts)
</cite>

## 更新摘要
**变更内容**   
- 更新“数据库验证脚本使用说明”部分，反映`verify-database.ts`已被移除，其功能由`debug-form-init.js`等新脚本替代
- 在“随机点赞功能异常”部分补充审核通过时添加随机点赞数的具体实现逻辑
- 新增“表单初始化问题调试”章节，介绍`debug-form-init.js`的用途和使用方法
- 移除对已删除文件`verify-database.ts`的引用和说明
- 更新相关文件引用路径和来源标注

## 目录
1. [引言](#引言)
2. [系统性诊断流程](#系统性诊断流程)
3. [常见故障与解决方案](#常见故障与解决方案)
4. [调试脚本使用说明](#调试脚本使用说明)
5. [附录](#附录)

## 引言
本文档旨在为开发和运维人员提供一份应急手册，基于项目日志中的实际问题记录，汇总常见故障及其解决方案。内容涵盖Next.js 15构建错误、在线人数统计组件问题、随机点赞功能异常等典型场景，并提供调试脚本的使用方法，帮助快速定位和解决问题。

## 系统性诊断流程
当系统出现异常时，建议按照以下步骤进行系统性排查：

1. **检查日志文件**：首先查看`log/`目录下的相关日志文件，确认问题类型和发生时间。
2. **验证数据库状态**：运行相关调试脚本（如`debug-form-init.js`），检查数据库连接和数据一致性。
3. **测试API端点**：使用工具（如curl或Postman）直接调用相关API接口，验证其响应是否正常。
4. **分析前端行为**：检查浏览器控制台日志，确认是否存在JavaScript错误或网络请求失败。
5. **复现问题场景**：根据用户反馈或日志描述，尝试在本地环境中复现问题。

此流程可确保问题得到全面排查，避免遗漏关键环节。

## 常见故障与解决方案

### Next.js 15 构建错误
#### 问题描述
在执行`npm run build`时，`/auth/signin`和`/upload`页面出现`useSearchParams()`未被`Suspense`边界包裹的错误，同时存在多个React Hook依赖警告。

#### 根本原因
Next.js 15要求在预渲染时使用`useSearchParams()`必须被`Suspense`边界包裹，否则会导致构建失败。

#### 解决方案
将使用`useSearchParams()`的逻辑提取到独立子组件中，并用`Suspense`包裹该子组件。

```tsx
// 示例：signin页面修复
function SignInForm() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get('callbackUrl');
  // ... 其他逻辑
}

export default function SignInPage() {
  return (
    <Suspense fallback={<div>加载中...</div>}>
      <SignInForm />
    </Suspense>
  );
}
```

#### 实际应用
- `src/app/auth/signin/page.tsx`已按此方案修复（见[SPEC SYMBOL](file://src/app/auth/signin/page.tsx#L1-L153)）
- `src/app/upload/page.tsx`同样采用该模式（见[SPEC SYMBOL](file://src/app/upload/page.tsx#L1-L644)）

**Section sources**
- [nextjs15-build-error.md](file://log/nextjs15-build-error.md#L1-L57)
- [signin/page.tsx](file://src/app/auth/signin/page.tsx#L1-L153)
- [upload/page.tsx](file://src/app/upload/page.tsx#L1-L644)

### 在线人数统计组件问题
#### 问题描述
用户要求在主页添加一个模拟在线人数计数器组件，显示"xxx人正在云栖大会创作"，并作为大横幅显示在顶栏位置。

#### 技术实现
- 组件位置：`src/components/OnlineCounter.tsx`
- 核心逻辑：从基数1075开始，每10秒通过API获取最新数据并随机增长
- 样式设计：橙红色渐变背景，包含火箭emoji和动画效果

#### 集成方案
1. 创建`OnlineCounter`组件（见[SPEC SYMBOL](file://src/components/OnlineCounter.tsx#L15-L157)）
2. 在`Header.tsx`中集成，作为顶栏下方的大横幅（见[SPEC SYMBOL](file://src/components/Header.tsx#L1-L118)）
3. 移除`page.tsx`中的重复引用，解决双横幅问题

#### API支持
- `GET /api/online-counter`：获取当前在线人数（见[SPEC SYMBOL](file://src/app/api/online-counter/route.ts#L1-L189)）
- 支持手动增加人数的POST接口（可选功能）

#### 潜在问题与优化
- **缓存失效风险**：当前实现依赖数据库存储配置，若数据库连接中断可能导致数据丢失
- **并发更新问题**：多个实例同时更新时可能出现竞态条件
- **优化建议**：
  - 引入Redis缓存层，提高读取性能
  - 使用分布式锁机制防止并发更新冲突
  - 增加本地缓存降级策略，保证数据库不可用时仍能提供基本服务

**Section sources**
- [online-counter-issue.md](file://log/online-counter-issue.md#L1-L32)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx#L15-L157)
- [route.ts](file://src/app/api/online-counter/route.ts#L1-L189)
- [Header.tsx](file://src/components/Header.tsx#L1-L118)

### 随机点赞功能异常
#### 问题描述
点赞功能可能出现重复计数或异常行为，特别是在高并发场景下。

#### 功能需求
在作品审核通过时，为新作品自动赋予10-50之间的随机初始点赞数。

#### 实现方案
修改`src/app/api/admin/works/[id]/route.ts`中的审核逻辑：

```typescript
if (validatedData.status === 'APPROVED' && existingWork.status !== 'APPROVED') {
  const initialLikes = Math.floor(Math.random() * 41) + 10; // 10-50之间的随机数
  updateData.likeCount = initialLikes;
}
```

#### 调试方法
1. **检查状态变更逻辑**：确保只在作品首次被批准时添加随机点赞数
2. **验证随机数范围**：确认生成的随机数在10-50之间
3. **测试并发场景**：模拟多个管理员同时审核作品，观察点赞数是否正确
4. **查看数据库记录**：通过调试脚本检查作品的`likeCount`字段

#### 常见问题
- **重复审核重置点赞数**：当前逻辑已避免此问题，仅在状态从非APPROVED变为APPROVED时添加
- **随机数分布不均**：使用`Math.random()`可能导致分布不够均匀，可考虑使用更高质量的随机数生成器

**Section sources**
- [random-likes-feature.md](file://log/random-likes-feature.md#L1-L37)
- [route.ts](file://src/app/api/admin/works/[id]/route.ts#L1-L252)

### 表单初始化问题调试
#### 问题描述
在管理员编辑作品时，表单中的`prompt`字段可能无法正确显示已有内容，导致信息丢失。

#### 根本原因
前端表单初始化逻辑未能正确处理`prompt`字段的`null`或空字符串值，导致默认值覆盖了数据库中的实际内容。

#### 解决方案
使用`debug-form-init.js`脚本模拟API响应和表单初始化过程，验证字段值的传递和处理。

```javascript
// 模拟API响应
const apiResponse = {
  success: true,
  data: worksWithPrompt[0]
};

// 表单初始化
const editForm = {
  name: workData.name || '',
  author: workData.author || '',
  prompt: workData.prompt || ''
};
```

#### 调试步骤
1. 运行`debug-form-init.js`脚本，检查输出结果
2. 验证`prompt`字段的类型和内容
3. 确认前端是否正确处理了`null`和空字符串情况
4. 根据调试结果调整表单初始化逻辑

**Section sources**
- [debug-form-init.js](file://scripts/debug-form-init.js#L1-L87)
- [edit/route.ts](file://src/app/api/admin/works/[id]/edit/route.ts#L1-L181)

## 调试脚本使用说明
随着项目重构，原有的`verify-database.ts`脚本已被移除，其功能由一系列专用调试脚本替代，用于检查数据库连接和数据一致性。

### 使用方法
```bash
# 调试表单初始化问题
npx ts-node scripts/debug-form-init.js

# 其他专用调试脚本
npx ts-node scripts/performance-test.js
npx ts-node scripts/test-oss.ts
```

### 功能特性
- 测试数据库连接
- 模拟API响应数据结构
- 验证表单字段初始化逻辑
- 检查特定字段（如`prompt`）的值和类型
- 输出详细的调试信息供排查

### 错误处理
脚本包含完善的错误处理机制：
- 数据库连接失败：检查连接字符串和网络状态
- 查询结果为空：验证数据库中是否存在预期数据
- 字段值异常：检查`null`、空字符串和`undefined`的处理逻辑

### 输出示例
```
=== 调试表单初始化问题 ===

1. 查询有prompt数据的作品:
找到的作品: [
  {
    id: '1',
    name: 'AI绘画作品',
    author: '张三',
    prompt: '一个美丽的风景画'
  }
]

2. 模拟API /api/admin/works/1/edit 的返回数据:
API响应: {
  "success": true,
  "data": {
    "id": "1",
    "name": "AI绘画作品",
    "author": "张三",
    "prompt": "一个美丽的风景画"
  }
}

3. 模拟前端表单初始化逻辑:
表单初始化结果: {
  "name": "AI绘画作品",
  "author": "张三",
  "prompt": "一个美丽的风景画"
}

✅ prompt字段有内容，应该能正确显示在表单中
```

**Section sources**
- [debug-form-init.js](file://scripts/debug-form-init.js#L1-L87)

## 附录
### 相关文件路径
- 日志文件：`log/`目录下
- 核心组件：`src/components/`目录下
- API路由：`src/app/api/`目录下
- 调试脚本：`scripts/`目录下

### 推荐排查工具
- `npx ts-node scripts/debug-form-init.js`：表单初始化问题调试
- 浏览器开发者工具：前端错误排查
- Postman/curl：API接口测试
- Prisma Studio：数据库可视化查看