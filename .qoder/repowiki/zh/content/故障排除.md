# 故障排除

<cite>
**本文档中引用的文件**   
- [nextjs15-build-error.md](file://log/nextjs15-build-error.md)
- [online-counter-issue.md](file://log/online-counter-issue.md)
- [random-likes-feature.md](file://log/random-likes-feature.md)
- [verify-database.ts](file://verify-database.ts)
- [signin/page.tsx](file://src/app/auth/signin/page.tsx)
- [upload/page.tsx](file://src/app/upload/page.tsx)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx)
- [route.ts](file://src/app/api/online-counter/route.ts)
- [route.ts](file://src/app/api/admin/works/[id]/route.ts)
</cite>

## 目录
1. [引言](#引言)
2. [系统性诊断流程](#系统性诊断流程)
3. [常见故障与解决方案](#常见故障与解决方案)
4. [数据库验证脚本使用说明](#数据库验证脚本使用说明)
5. [附录](#附录)

## 引言
本文档旨在为开发和运维人员提供一份应急手册，基于项目日志中的实际问题记录，汇总常见故障及其解决方案。内容涵盖Next.js 15构建错误、在线人数统计组件问题、随机点赞功能异常等典型场景，并提供数据库验证脚本的使用方法，帮助快速定位和解决问题。

## 系统性诊断流程
当系统出现异常时，建议按照以下步骤进行系统性排查：

1. **检查日志文件**：首先查看`log/`目录下的相关日志文件，确认问题类型和发生时间。
2. **验证数据库状态**：运行`verify-database.ts`脚本，检查数据库连接和数据一致性。
3. **测试API端点**：使用工具（如curl或Postman）直接调用相关API接口，验证其响应是否正常。
4. **分析前端行为**：检查浏览器控制台日志，确认是否存在JavaScript错误或网络请求失败。
5. **复现问题场景**：根据用户反馈或日志描述，尝试在本地环境中复现问题。

此流程可确保问题得到全面排查，避免遗漏关键环节。

## 常见故障与解决方案

### Next.js 15 构建错误
#### 问题描述
在执行`npm run build`时，`/auth/signin`和`/upload`页面出现`useSearchParams()`未被`Suspense`边界包裹的错误，同时存在多个React Hook依赖警告。

#### 根本原因
Next.js 15要求在预渲染时使用`useSearchParams()`必须被`Suspense`边界包裹，否则会导致构建失败。

#### 解决方案
将使用`useSearchParams()`的逻辑提取到独立子组件中，并用`Suspense`包裹该子组件。

```tsx
// 示例：signin页面修复
function SignInForm() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get('callbackUrl');
  // ... 其他逻辑
}

export default function SignInPage() {
  return (
    <Suspense fallback={<div>加载中...</div>}>
      <SignInForm />
    </Suspense>
  );
}
```

#### 实际应用
- `src/app/auth/signin/page.tsx`已按此方案修复（见[SPEC SYMBOL](file://src/app/auth/signin/page.tsx#L1-L153)）
- `src/app/upload/page.tsx`同样采用该模式（见[SPEC SYMBOL](file://src/app/upload/page.tsx#L1-L644)）

**Section sources**
- [nextjs15-build-error.md](file://log/nextjs15-build-error.md#L1-L57)
- [signin/page.tsx](file://src/app/auth/signin/page.tsx#L1-L153)
- [upload/page.tsx](file://src/app/upload/page.tsx#L1-L644)

### 在线人数统计组件问题
#### 问题描述
用户要求在主页添加一个模拟在线人数计数器组件，显示"xxx人正在云栖大会创作"，并作为大横幅显示在顶栏位置。

#### 技术实现
- 组件位置：`src/components/OnlineCounter.tsx`
- 核心逻辑：从基数1075开始，每10秒通过API获取最新数据并随机增长
- 样式设计：橙红色渐变背景，包含火箭emoji和动画效果

#### 集成方案
1. 创建`OnlineCounter`组件（见[SPEC SYMBOL](file://src/components/OnlineCounter.tsx#L15-L157)）
2. 在`Header.tsx`中集成，作为顶栏下方的大横幅（见[SPEC SYMBOL](file://src/components/Header.tsx#L1-L118)）
3. 移除`page.tsx`中的重复引用，解决双横幅问题

#### API支持
- `GET /api/online-counter`：获取当前在线人数（见[SPEC SYMBOL](file://src/app/api/online-counter/route.ts#L1-L189)）
- 支持手动增加人数的POST接口（可选功能）

#### 潜在问题与优化
- **缓存失效风险**：当前实现依赖数据库存储配置，若数据库连接中断可能导致数据丢失
- **并发更新问题**：多个实例同时更新时可能出现竞态条件
- **优化建议**：
  - 引入Redis缓存层，提高读取性能
  - 使用分布式锁机制防止并发更新冲突
  - 增加本地缓存降级策略，保证数据库不可用时仍能提供基本服务

**Section sources**
- [online-counter-issue.md](file://log/online-counter-issue.md#L1-L32)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx#L15-L157)
- [route.ts](file://src/app/api/online-counter/route.ts#L1-L189)
- [Header.tsx](file://src/components/Header.tsx#L1-L118)

### 随机点赞功能异常
#### 问题描述
点赞功能可能出现重复计数或异常行为，特别是在高并发场景下。

#### 功能需求
在作品审核通过时，为新作品自动赋予10-50之间的随机初始点赞数。

#### 实现方案
修改`src/app/api/admin/works/[id]/route.ts`中的审核逻辑：

```typescript
if (status === 'APPROVED' && existingWork.status !== 'APPROVED') {
  const randomLikes = Math.floor(Math.random() * 41) + 10;
  updateData.likeCount = randomLikes;
}
```

#### 调试方法
1. **检查状态变更逻辑**：确保只在作品首次被批准时添加随机点赞数
2. **验证随机数范围**：确认生成的随机数在10-50之间
3. **测试并发场景**：模拟多个管理员同时审核作品，观察点赞数是否正确
4. **查看数据库记录**：通过`verify-database.ts`脚本检查作品的`likeCount`字段

#### 常见问题
- **重复审核重置点赞数**：当前逻辑已避免此问题，仅在状态从非APPROVED变为APPROVED时添加
- **随机数分布不均**：使用`Math.random()`可能导致分布不够均匀，可考虑使用更高质量的随机数生成器

**Section sources**
- [random-likes-feature.md](file://log/random-likes-feature.md#L1-L37)
- [route.ts](file://src/app/api/admin/works/[id]/route.ts#L1-L252)

## 数据库验证脚本使用说明
`verify-database.ts`脚本用于检查数据库连接和数据一致性，是故障排查的重要工具。

### 使用方法
```bash
# 验证数据库状态
npx ts-node verify-database.ts

# 创建管理员用户（如果不存在）
npx ts-node verify-database.ts --create-admin
```

### 功能特性
- 测试数据库连接
- 统计用户总数和管理员用户
- 显示作品状态分布
- 检查最新5个作品
- 验证上传和平台配置

### 错误处理
脚本包含完善的错误处理机制：
- `P1001`错误：检查数据库连接字符串和网络连接
- `P2021`错误：数据库表不存在，需要运行迁移
- 其他错误：输出详细错误信息供排查

### 输出示例
```
🔍 开始验证数据库连接和数据...
✅ 数据库连接成功
👥 用户总数: 15
👑 管理员用户: [ { id: '1', email: 'admin@yunqi.com', name: '管理员', role: 'ADMIN' } ]
🎨 作品统计:
  APPROVED: 12 个
  PENDING: 3 个
⚙️ 上传配置: 已配置
🏠 平台配置: Qcoder和通义灵码 AI Coding 作品秀
✅ 数据库验证完成
```

**Section sources**
- [verify-database.ts](file://verify-database.ts#L1-L126)

## 附录
### 相关文件路径
- 日志文件：`log/`目录下
- 核心组件：`src/components/`目录下
- API路由：`src/app/api/`目录下
- 数据库脚本：项目根目录

### 推荐排查工具
- `npx ts-node verify-database.ts`：数据库状态检查
- 浏览器开发者工具：前端错误排查
- Postman/curl：API接口测试
- Prisma Studio：数据库可视化查看