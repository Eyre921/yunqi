# 故障排除

<cite>
**本文档中引用的文件**  
- [nextjs15-build-error.md](file://log/nextjs15-build-error.md)
- [online-counter-issue.md](file://log/online-counter-issue.md)
- [random-likes-feature.md](file://log/random-likes-feature.md)
- [spacing-adjustment-issue.md](file://log/spacing-adjustment-issue.md)
- [page.tsx](file://src/app/page.tsx)
- [Header.tsx](file://src/components/Header.tsx)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx)
- [route.ts](file://src/app/api/admin/works/[id]/route.ts)
- [signin/page.tsx](file://src/app/auth/signin/page.tsx)
- [upload/page.tsx](file://src/app/upload/page.tsx)
- [next.config.ts](file://next.config.ts)
- [nextjs15-type-fixes-report.md](file://src/nextjs15-type-fixes-report.md)
</cite>

## 目录
1. [简介](#简介)
2. [常见错误与解决方案](#常见错误与解决方案)
   - [Next.js 15 构建错误](#nextjs-15-构建错误)
   - [在线计数器功能异常](#在线计数器功能异常)
   - [随机点赞功能问题](#随机点赞功能问题)
   - [样式间距问题](#样式间距问题)
3. [调试技巧](#调试技巧)
4. [结论](#结论)

## 简介
本文档旨在为开发者和运维人员提供一份全面的故障排除指南，基于项目日志和已知问题报告。文档详细描述了在项目开发和维护过程中可能遇到的常见错误，包括Next.js 15构建错误、在线计数器功能异常、随机点赞功能问题和样式间距问题。每个问题都提供了详细的症状描述、根本原因分析、复现步骤和经过验证的解决方案或变通方法。此外，文档还包含了利用日志、调试器和数据库查询来诊断问题的调试技巧，以有效降低支持成本。

## 常见错误与解决方案

### Next.js 15 构建错误

#### 症状描述
在运行 `npm run build` 时出现以下错误：
- `/auth/signin` 页面：`useSearchParams()` 未被 `Suspense` 边界包裹
- `/upload` 页面：同样的 `useSearchParams()` 问题
- 多个 React Hook `useEffect` 的依赖警告

#### 根本原因分析
Next.js 15 要求在预渲染时使用 `useSearchParams()` 必须被 `Suspense` 边界包裹。这是因为 `useSearchParams()` 是一个异步 Hook，其值在服务器端渲染时不可用，必须通过 `Suspense` 来处理加载状态。

#### 复现步骤
1. 升级到 Next.js 15。
2. 在任何页面中使用 `useSearchParams()` 而不将其包裹在 `Suspense` 中。
3. 运行 `npm run build`。

#### 解决方案
将使用 `useSearchParams()` 的逻辑提取到单独的子组件中，并用 `Suspense` 包裹该子组件。

**修复 signin 页面**
```tsx
// 提取使用 useSearchParams 的逻辑到单独组件
function SignInForm() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get('callbackUrl');
  // ... 其他逻辑
}

// 主页面组件用 Suspense 包裹
export default function SignInPage() {
  return (
    <Suspense fallback={<div>加载中...</div>}>
      <SignInForm />
    </Suspense>
  );
}
```

**修复 upload 页面**
```tsx
// 同样的模式
function UploadForm() {
  const searchParams = useSearchParams();
  const editId = searchParams.get('edit');
  // ... 其他逻辑
}

export default function UploadPage() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <UploadForm />
    </Suspense>
  );
}
```

**技术要点**
- 将使用 `useSearchParams` 的逻辑提取到子组件
- 用 `Suspense` 包裹子组件
- 提供合适的 fallback 加载状态

**Section sources**
- [signin/page.tsx](file://src/app/auth/signin/page.tsx#L1-L153)
- [upload/page.tsx](file://src/app/upload/page.tsx#L1-L644)

### 在线计数器功能异常

#### 症状描述
用户要求在主页添加一个模拟在线人数计数器组件，显示"xxx人正在云栖大会创作"，并要求作为占据整行页面的大横幅显示在顶栏位置。初始实现时，页面出现了两个横幅的问题。

#### 根本原因分析
在线计数器组件最初在 `page.tsx` 中的 Header 下方被引用，后来又被集成到 `Header.tsx` 组件中，导致重复引用。

#### 复现步骤
1. 在 `page.tsx` 中引入 `OnlineCounter` 组件。
2. 在 `Header.tsx` 中也引入 `OnlineCounter` 组件。
3. 查看页面，发现有两个横幅。

#### 解决方案
将 `OnlineCounter` 组件集成到 `Header.tsx` 组件中，并移除 `page.tsx` 中的重复引用。

**创建 OnlineCounter 组件**
- 位置：`src/components/OnlineCounter.tsx`
- 功能：从基数1024开始，每10秒随机增加1-5人
- 样式：橙红色渐变背景，包含火箭emoji和动画效果

**组件集成**
- 初始位置：在 `page.tsx` 中的 Header 下方
- 最终位置：集成到 `Header.tsx` 组件中，作为紧接着顶栏的大横幅
- 修复：解决了页面出现两个横幅的问题（移除了 page.tsx 中的重复引用）

**技术实现**
```typescript
// 核心逻辑
const [onlineCount, setOnlineCount] = useState(1024);

useEffect(() => {
  const interval = setInterval(() => {
    setOnlineCount(prev => prev + Math.floor(Math.random() * 5) + 1);
  }, 10000);
  return () => clearInterval(interval);
}, []);
```

**Section sources**
- [page.tsx](file://src/app/page.tsx#L1-L386)
- [Header.tsx](file://src/components/Header.tsx#L1-L118)
- [OnlineCounter.tsx](file://src/components/OnlineCounter.tsx#L1-L157)

### 随机点赞功能问题

#### 症状描述
在作品审核通过时，需要为新作品自动赋予10-50之间的随机初始点赞数。初始实现时，随机点赞数在每次审核时都会重新生成，导致已审核作品的点赞数被重置。

#### 根本原因分析
随机点赞数的生成逻辑没有检查作品的当前状态，导致每次审核时都会重新生成随机数。

#### 复现步骤
1. 审核一个作品，使其状态变为 `APPROVED`。
2. 再次审核同一个作品，观察点赞数是否被重置。

#### 解决方案
修改 `src/app/api/admin/works/[id]/route.ts` 文件中的作品审核逻辑，确保只在作品首次从其他状态变为 `APPROVED` 时添加随机点赞数。

**实现方案**
```typescript
// 在作品首次被批准时添加随机点赞数
if (status === 'APPROVED' && existingWork.status !== 'APPROVED') {
  // 生成10-50之间的随机点赞数
  const randomLikes = Math.floor(Math.random() * 41) + 10;
  
  updateData.likes = randomLikes;
}

const updatedWork = await prisma.work.update({
  where: { id },
  data: updateData
});
```

**技术细节**
- 只在作品首次从其他状态变为 `APPROVED` 时添加随机点赞数
- 随机数范围：10-50
- 使用 `Math.floor(Math.random() * 41) + 10` 生成随机数
- 避免重复审核时重置点赞数

**业务逻辑**
1. 检查作品当前状态是否不是 `APPROVED`
2. 检查新状态是否为 `APPROVED`
3. 满足条件时生成随机点赞数
4. 更新作品数据

**Section sources**
- [route.ts](file://src/app/api/admin/works/[id]/route.ts#L1-L251)

### 样式间距问题

#### 症状描述
用户反馈主页中"最新作品"和"热门作品"与滚动条之间的间距过大，需要缩小间距。

#### 根本原因分析
通过检查 `page.tsx` 文件发现，"最新作品"区域使用了 `py-8` 的 padding，"热门作品"区域使用了 `py-12` 的 padding，多个区域的 padding 值累加导致间距过大。

#### 复现步骤
1. 查看 `page.tsx` 文件中的 Tailwind CSS 类。
2. 观察 `py-8` 和 `py-12` 的使用情况。
3. 查看页面，确认间距问题。

#### 解决方案
修改 `src/app/page.tsx` 中的 Tailwind CSS 类，将 `py-8` 和 `py-12` 调整为 `py-4`。

**调整前**
```tsx
<section className="py-8 mb-6">
  {/* 最新作品轮播 */}
</section>

<main className="py-8">
  <section className="py-12 mb-8">
    {/* 热门作品 */}
  </section>
</main>
```

**调整后**
```tsx
<section className="py-4 mb-4">
  {/* 最新作品轮播 */}
</section>

<main className="py-4">
  <section className="py-4 mb-6">
    {/* 热门作品 */}
  </section>
</main>
```

**具体修改**
- `py-8` → `py-4`
- `py-12` → `py-4`
- `mb-6` → `mb-4`
- `mb-8` → `mb-6`

**Section sources**
- [page.tsx](file://src/app/page.tsx#L1-L386)

## 调试技巧

### 利用日志
- **查看构建日志**：在运行 `npm run build` 时，查看控制台输出的日志，定位具体的错误信息。
- **查看运行时日志**：在开发服务器运行时，查看控制台输出的日志，特别是 `console.log` 和 `console.error` 的输出。

### 使用调试器
- **浏览器开发者工具**：使用浏览器的开发者工具，设置断点，逐步调试代码，查看变量的值和函数的调用栈。
- **VS Code 调试器**：配置 VS Code 的调试器，连接到 Node.js 进程，进行断点调试。

### 数据库查询
- **检查数据库状态**：使用 Prisma Studio 或直接查询数据库，检查数据是否符合预期。
- **验证数据变更**：在执行数据变更操作后，查询数据库，确认数据是否正确更新。

## 结论
本文档详细描述了项目中常见的错误及其解决方案，涵盖了Next.js 15构建错误、在线计数器功能异常、随机点赞功能问题和样式间距问题。通过遵循本文档中的解决方案和调试技巧，开发者和运维人员可以快速诊断和解决这些问题，有效降低支持成本。建议定期回顾和更新本文档，以应对新的挑战和变化。