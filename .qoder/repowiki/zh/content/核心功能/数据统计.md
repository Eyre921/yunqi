# 数据统计

<cite>
**本文档引用的文件**   
- [route.ts](file://src/app/api/admin/stats/route.ts)
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx)
- [db-utils.ts](file://src/lib/db-utils.ts)
</cite>

## 目录
1. [简介](#简介)
2. [统计API实现](#统计api实现)
3. [数据缓存策略](#数据缓存策略)
4. [前端图表渲染](#前端图表渲染)
5. [管理员面板布局](#管理员面板布局)
6. [性能分析与优化建议](#性能分析与优化建议)
7. [常见问题与解决方案](#常见问题与解决方案)

## 简介
本系统实现了全面的数据统计功能，涵盖作品数量、用户增长、互动趋势等核心指标。通过Prisma聚合查询获取数据，采用缓存策略提升性能，并在管理员面板中以可视化方式展示。系统支持实时数据刷新和历史趋势分析，为平台运营提供决策支持。

## 统计API实现
统计API通过Prisma客户端实现聚合查询，获取多维度的运营数据。

```mermaid
sequenceDiagram
participant 前端 as 前端组件
participant API as 统计API
participant 数据库 as 数据库
前端->>API : GET /api/admin/stats
API->>数据库 : 并行查询基础统计
数据库-->>API : 返回作品/用户总数
API->>数据库 : 查询最近7天数据
数据库-->>API : 返回近期统计
API->>数据库 : 原生SQL查询每日趋势
数据库-->>API : 返回30天趋势数据
API->>数据库 : 查询热门作品和活跃用户
数据库-->>API : 返回列表数据
API-->>前端 : 统一响应格式
```

**Diagram sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L1-L162)

**Section sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L1-L162)

## 数据缓存策略
系统采用多层缓存策略确保数据性能和实时性平衡。

```mermaid
flowchart TD
A[API请求] --> B{缓存命中?}
B --> |是| C[返回缓存数据]
B --> |否| D[执行数据库查询]
D --> E[聚合基础统计]
D --> F[查询趋势数据]
D --> G[获取列表数据]
E --> H[组合完整响应]
F --> H
G --> H
H --> I[设置缓存头]
I --> J[返回响应]
J --> K[CDN缓存300秒]
K --> L[客户端可再用600秒]
```

**Diagram sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L149-L155)

**Section sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L149-L155)

## 前端图表渲染
前端组件负责数据获取和可视化展示，采用响应式设计。

```mermaid
classDiagram
class AdminStats {
+stats : ApiStatsResponse | null
+loading : boolean
+error : string | null
-loadStats() : Promise~void~
+render() : JSX.Element
}
class ApiStatsResponse {
+overview : Overview
+charts : Charts
+lists : Lists
}
class Overview {
+totalUsers : number
+totalWorks : number
+pendingWorks : number
+approvedWorks : number
+rejectedWorks : number
+recentUsers : number
+recentWorks : number
}
class Charts {
+dailyWorks : {date : Date, count : number}[]
+dailyUsers : {date : Date, count : number}[]
}
class Lists {
+popularWorks : any[]
+activeUsers : any[]
}
AdminStats --> ApiStatsResponse : 使用
useApi --> AdminStats : 提供
LoadingSpinner --> AdminStats : 显示
ErrorMessage --> AdminStats : 显示
```

**Diagram sources**
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L8-L26)
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L28-L174)

**Section sources**
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L8-L174)

## 管理员面板布局
管理员面板采用卡片式布局展示统计信息，具有良好的用户体验。

```mermaid
flowchart TB
A[数据统计页面] --> B[标题区域]
A --> C[统计卡片网格]
A --> D[最近数据展示]
C --> C1[总作品数]
C --> C2[待审核]
C --> C3[已通过]
C --> C4[已拒绝]
C --> C5[总用户数]
C --> C6[最近用户]
C --> C7[最近作品]
D --> D1[最近7天新作品]
D --> D2[最近7天新用户]
B --> B1[数据统计]
B --> B2[平台整体运营数据概览]
style C1 fill:#blue-500
style C2 fill:#yellow-500
style C3 fill:#green-500
style C4 fill:#red-500
style C5 fill:#purple-500
style C6 fill:#indigo-500
style C7 fill:#pink-500
style D fill:#blue-500
```

**Diagram sources**
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L105-L174)

**Section sources**
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L105-L174)

## 性能分析与优化建议
针对大数据量场景，系统需要进行性能优化以确保响应速度。

### SQL查询模式分析
当前系统使用多种查询模式，性能特征如下：

| 查询类型 | SQL模式 | 复杂度 | 潜在问题 |
|---------|--------|-------|---------|
| 基础统计 | Prisma count() | O(1) | 无 |
| 分组统计 | groupBy + _count | O(n) | 大数据量时较慢 |
| 趋势分析 | 原生SQL + GROUP BY | O(n) | 需要索引优化 |
| 列表查询 | findMany + orderBy | O(n log n) | 排序性能问题 |

**Section sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L12-L120)

### 大数据量优化建议
```mermaid
flowchart TD
A[大数据量挑战] --> B[分表策略]
A --> C[物化视图]
A --> D[读写分离]
B --> B1[按时间分表]
B --> B2[按用户ID分表]
B --> B3[分片策略]
C --> C1[创建物化视图]
C --> C2[定时刷新]
C --> C3[查询重写]
D --> D1[主库写入]
D --> D2[从库读取]
D --> D3[负载均衡]
B --> E[性能提升]
C --> E
D --> E
```

**Diagram sources**
- [db-utils.ts](file://src/lib/db-utils.ts#L58-L67)
- [route.ts](file://src/app/api/admin/stats/route.ts#L53-L75)

**Section sources**
- [db-utils.ts](file://src/lib/db-utils.ts#L58-L67)
- [route.ts](file://src/app/api/admin/stats/route.ts#L53-L75)

## 常见问题与解决方案
系统运行中可能出现统计延迟和数据不一致问题，需要针对性解决。

```mermaid
stateDiagram-v2
[*] --> 正常状态
正常状态 --> 统计延迟 : 数据量大
正常状态 --> 数据不一致 : 缓存未更新
统计延迟 --> 解决方案1 : 优化查询
统计延迟 --> 解决方案2 : 使用物化视图
数据不一致 --> 解决方案3 : 缓存失效策略
数据不一致 --> 解决方案4 : 事件驱动更新
解决方案1 --> 性能提升
解决方案2 --> 性能提升
解决方案3 --> 数据一致
解决方案4 --> 数据一致
性能提升 --> 正常状态
数据一致 --> 正常状态
```

**Diagram sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L149-L155)
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L36-L50)

**Section sources**
- [route.ts](file://src/app/api/admin/stats/route.ts#L149-L155)
- [AdminStats.tsx](file://src/components/admin/AdminStats.tsx#L36-L50)