# 平台配置管理

<cite>
**本文档引用文件**  
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts)
- [platform-config/route.ts](file://src/app/api/platform-config/route.ts)
- [online-counter/route.ts](file://src/app/api/admin/online-counter/route.ts)
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx)
- [PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx)
- [OnlineCounterManagement.tsx](file://src/components/admin/OnlineCounterManagement.tsx)
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
</cite>

## 目录
1. [引言](#引言)
2. [上传配置子系统](#上传配置子系统)
3. [平台参数配置子系统](#平台参数配置子系统)
4. [在线计数器配置子系统](#在线计数器配置子系统)
5. [数据库表结构演变](#数据库表结构演变)
6. [前端可视化编辑实现](#前端可视化编辑实现)
7. [配置生效机制与权限控制](#配置生效机制与权限控制)
8. [配置回滚方案](#配置回滚方案)

## 引言
本系统为数字化作品互动展示平台提供三大核心配置功能：上传配置、平台参数配置和在线计数器配置。通过管理员界面实现对平台行为的精细化控制，涵盖文件上传限制、平台标题设置及在线人数动态展示等功能。所有配置均通过API接口进行数据验证与持久化存储，并结合Prisma迁移文件确保数据库结构的一致性与可追溯性。

## 上传配置子系统

该子系统管理用户上传作品的相关设置，包括功能开关、时间范围、数量与大小限制、允许格式及公告信息。

### 配置项用途说明
- **isEnabled**: 控制上传功能是否开启
- **startTime/endTime**: 设定上传功能的有效时间窗口
- **maxUploadsPerUser**: 限制单个用户可上传的作品数量
- **maxFileSize**: 定义单个文件的最大允许大小（1KB至100MB）
- **allowedFormats**: 指定允许上传的文件格式白名单
- **announcement**: 向用户展示的公告信息

### API接口与数据验证
`/api/admin/upload-config` 支持GET和POST方法：
- **GET**: 获取当前配置，若无记录则返回默认值
- **POST**: 创建新配置，需管理员权限

使用Zod进行严格的数据验证：
```ts
const UploadConfigSchema = z.object({
  isEnabled: z.boolean(),
  startTime: z.iso.datetime().optional().nullable(),
  endTime: z.iso.datetime().optional().nullable(),
  maxUploadsPerUser: z.number().int().min(1).max(100000),
  maxFileSize: z.number().int().min(1024).max(104857600),
  allowedFormats: z.array(z.string()).min(1),
  announcement: z.string().optional().nullable()
});
```
请求处理逻辑包含时间逻辑校验（开始时间必须早于结束时间）和权限验证（仅管理员可操作）。

**Section sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L7-L150)
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L5-L333)

## 平台参数配置子系统

此子系统用于管理平台全局参数，目前主要支持平台主标题的设置。

### 配置项用途说明
- **title**: 平台主标题，显示于页面头部

### API接口与数据验证
`/api/platform-config` 提供GET和POST接口：
- **GET**: 获取平台配置，若不存在则自动创建默认配置
- **POST**: 更新平台配置，需管理员权限

数据验证使用Zod模式：
```ts
const PlatformConfigSchema = z.object({
  title: z.string().min(1, '标题不能为空').max(100, '标题长度不能超过100个字符')
});
```
系统在首次访问时会初始化默认标题为“Qoder和通义灵码 AI Coding 作品秀”。

**Section sources**
- [platform-config/route.ts](file://src/app/api/platform-config/route.ts#L7-L113)
- [PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx#L5-L143)

## 在线计数器配置子系统

该子系统实现动态在线人数的模拟与展示功能。

### 配置项用途说明
- **currentCount**: 当前显示的人数
- **baseCount**: 重置时的基础人数
- **maxCount**: 自动增长的上限值
- **growthRate**: 每10秒随机增加的最大人数
- **isEnabled**: 是否启用在线人数显示
- **displayText**: 在线人数后的描述文本

### API接口与数据验证
`/api/admin/online-counter` 支持多种操作：
- **GET**: 获取配置（管理员权限）
- **PUT**: 更新配置（管理员权限）
- **POST**: 重置当前人数为baseCount值

Zod验证模式如下：
```ts
const OnlineCounterConfigSchema = z.object({
  currentCount: z.number().min(0).max(10000).optional(),
  baseCount: z.number().min(0).max(10000).optional(),
  maxCount: z.number().min(0).max(10000).optional(),
  growthRate: z.number().min(0).max(100).optional(),
  isEnabled: z.boolean().optional(),
  displayText: z.string().min(1).max(100).optional()
});
```

**Section sources**
- [online-counter/route.ts](file://src/app/api/admin/online-counter/route.ts#L7-L175)
- [OnlineCounterManagement.tsx](file://src/components/admin/OnlineCounterManagement.tsx#L5-L323)

## 数据库表结构演变

通过Prisma迁移文件追踪配置表的创建过程。

### 上传配置表
在 `20250831084947_add_featured_field` 迁移中创建：
```sql
CREATE TABLE "upload_configs" (
    "id" TEXT NOT NULL,
    "isEnabled" BOOLEAN NOT NULL DEFAULT false,
    "startTime" TIMESTAMP(3),
    "endTime" TIMESTAMP(3),
    "maxUploadsPerUser" INTEGER NOT NULL DEFAULT 1,
    "maxFileSize" INTEGER NOT NULL DEFAULT 10485760,
    "allowedFormats" TEXT[] DEFAULT ARRAY['jpg', 'jpeg', 'png', 'gif']::TEXT[],
    "announcement" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "createdBy" TEXT,
    CONSTRAINT "upload_configs_pkey" PRIMARY KEY ("id")
);
```

### 平台配置表
在 `20250905150839_add_platform_config` 迁移中创建：
```sql
CREATE TABLE "platform_configs" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL DEFAULT 'Qoder和通义灵码 AI Coding 作品秀',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "platform_configs_pkey" PRIMARY KEY ("id")
);
```

### 在线计数器配置表
在 `20250905143157_add_online_counter_config` 迁移中创建：
```sql
CREATE TABLE "online_counter_configs" (
    "id" TEXT NOT NULL,
    "currentCount" INTEGER NOT NULL DEFAULT 1075,
    "baseCount" INTEGER NOT NULL DEFAULT 1000,
    "maxCount" INTEGER NOT NULL DEFAULT 2000,
    "growthRate" DOUBLE PRECISION NOT NULL DEFAULT 0.5,
    "isEnabled" BOOLEAN NOT NULL DEFAULT true,
    "displayText" TEXT NOT NULL DEFAULT '人正在云栖大会创作',
    "lastUpdated" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "createdBy" TEXT,
    CONSTRAINT "online_counter_configs_pkey" PRIMARY KEY ("id")
);
```

**Diagram sources**
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql#L0-L122)
- [migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql#L0-L9)
- [migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql#L0-L19)

## 前端可视化编辑实现

管理员通过专用组件实现配置的可视化编辑与实时更新。

### 上传配置管理界面
`UploadConfigManagement.tsx` 组件提供表单化界面，支持：
- 开关控件管理功能启用状态
- 时间选择器设置起止时间
- 数值输入框与滑块调节上传限制
- 复选框选择允许的文件格式
- 文本域输入公告信息

### 平台参数管理界面
`PlatformConfigManagement.tsx` 组件提供简洁的标题编辑功能，包含字符计数提示与保存状态反馈。

### 在线计数器管理界面
`OnlineCounterManagement.tsx` 组件提供完整的配置管理，包含：
- 实时状态显示区
- 数值输入控件（含范围限制）
- 文本输入与复选框
- 操作按钮组（保存、重置、刷新）

所有组件均集成错误提示与加载状态处理，确保良好的用户体验。

**Section sources**
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L5-L333)
- [PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx#L5-L143)
- [OnlineCounterManagement.tsx](file://src/components/admin/OnlineCounterManagement.tsx#L5-L323)

## 配置生效机制与权限控制

### 配置生效机制
- **上传配置与在线计数器配置**：修改后立即生效，无需重启服务
- **平台参数配置**：修改后通过 `window.location.reload()` 刷新页面以更新Header显示

### 权限控制策略
所有管理接口均实施严格的权限验证：
- 使用 `getServerSession(authOptions)` 获取会话信息
- 验证用户角色是否为 `ADMIN`
- 未通过验证返回403状态码

例如在线计数器配置接口：
```ts
if (!session?.user || session.user.role !== 'ADMIN') {
  return NextResponse.json({ error: '权限不足' }, { status: 403 });
}
```

**Section sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L30-L35)
- [platform-config/route.ts](file://src/app/api/platform-config/route.ts#L32-L37)
- [online-counter/route.ts](file://src/app/api/admin/online-counter/route.ts#L18-L23)

## 配置回滚方案

系统通过以下机制支持配置回滚：

### 历史记录保留
- 所有配置表均包含 `createdAt` 和 `updatedAt` 字段
- `upload_configs` 和 `online_counter_configs` 表记录 `createdBy` 用户信息

### 重置功能
在线计数器提供专用重置接口：
- **POST /api/admin/online-counter**: 将 `currentCount` 重置为 `baseCount` 值
- 操作记录更新时间戳与最后更新人

### 默认值保障
当系统中无任何配置记录时：
- 上传配置返回预设默认值
- 平台配置自动创建默认标题
- 在线计数器生成默认配置

这些机制共同确保系统在异常情况下仍能维持基本运行状态。

**Section sources**
- [online-counter/route.ts](file://src/app/api/admin/online-counter/route.ts#L120-L175)
- [platform-config/route.ts](file://src/app/api/platform-config/route.ts#L15-L30)
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L18-L28)