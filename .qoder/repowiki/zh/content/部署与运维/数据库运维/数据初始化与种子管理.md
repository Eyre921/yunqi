# 数据初始化与种子管理

<cite>
**本文档引用的文件**   
- [seed.ts](file://prisma/seed.ts)
- [package.json](file://package.json)
- [prisma.ts](file://src/lib/prisma.ts)
</cite>

## 目录
1. [引言](#引言)
2. [数据种子实现逻辑](#数据种子实现逻辑)
3. [种子数据结构设计原则](#种子数据结构设计原则)
4. [执行数据播种命令](#执行数据播种命令)
5. [Docker初始化与测试环境集成](#docker初始化与测试环境集成)
6. [数据依赖顺序处理](#数据依赖顺序处理)
7. [幂等性保障机制](#幂等性保障机制)
8. [敏感数据脱敏策略](#敏感数据脱敏策略)
9. [总结](#总结)

## 引言
本项目通过Prisma ORM框架实现数据库的初始化和种子数据填充，旨在为开发与测试环境提供一致且丰富的初始数据。`prisma/seed.ts`脚本作为核心数据播种工具，负责创建用户、作品及平台配置等关键实体，并确保数据结构符合业务需求。该机制不仅提升了开发效率，还保证了测试环境的可重复性和稳定性。

## 数据种子实现逻辑
`prisma/seed.ts`文件定义了完整的数据初始化流程，包含用户创建、作品生成、状态分布模拟以及最终统计输出。整个过程以异步方式执行，确保数据库操作的高效性与可靠性。

脚本首先导入Prisma客户端和bcryptjs库，用于数据库交互和密码加密。随后定义`main`函数作为主执行入口，在其中按顺序处理用户和作品数据的插入。通过`upsert`操作实现用户的幂等性创建，避免重复数据问题。对于作品数据，则采用分批构造策略：先创建少量具有详细描述的示例作品，再批量生成更多随机作品以模拟真实使用场景。

在作品生成阶段，脚本根据预设权重（70%通过、20%待审核、10%拒绝）随机分配状态，并为不同状态设置相应的时间戳和拒绝原因。所有生成的数据均基于真实路径引用图片资源，确保前端展示一致性。

最后，脚本输出详细的统计信息，包括用户总数、各类作品数量及测试账号信息，便于开发者快速了解初始化结果。

**Section sources**
- [seed.ts](file://prisma/seed.ts#L1-L318)

## 种子数据结构设计原则
种子数据的设计遵循清晰性、代表性与可扩展性三大原则，确保既能满足基本功能测试需求，又能反映真实业务场景。

### 用户实体设计
用户数据涵盖管理员、普通用户、艺术家、设计师等多种角色，体现平台的多角色权限体系。每个用户包含邮箱、姓名、角色和密码字段，其中密码经bcrypt哈希处理后存储，符合安全规范。示例中明确区分了`ADMIN`与`USER`角色，支持后续权限控制逻辑验证。

### 作品实体设计
作品数据结构包含名称、标题、描述、作者、提示词、图片路径、状态、点赞数、浏览量等字段，全面覆盖作品展示所需信息。特别地，状态字段（`WorkStatus`）支持`APPROVED`、`PENDING`、`REJECTED`三种值，分别对应已通过、待审核和已拒绝状态，便于测试不同审核流程。

详细作品示例注重内容丰富性，如“梦幻星空下的未来城市”包含完整描述和Prompt信息，有助于测试AI生成相关内容的功能。批量生成部分则通过模板化标题、描述和作者名，结合随机算法生成多样化数据，提升测试覆盖率。

### 平台配置与关联关系
虽然当前种子脚本未直接初始化平台配置表，但其设计预留了扩展空间。用户与作品之间通过`userId`建立外键关联，确保数据一致性。此外，作品状态变化时间（如`approvedAt`、`rejectedAt`）的设置增强了时间维度测试能力。

**Section sources**
- [seed.ts](file://prisma/seed.ts#L25-L250)

## 执行数据播种命令
项目通过`package.json`中的脚本命令简化数据播种流程。开发者可通过以下命令一键执行种子脚本：

```bash
npx prisma db seed
```

该命令实际调用`tsx prisma/seed.ts`，利用TypeScript执行器直接运行TypeScript格式的种子文件，无需预先编译。此配置在`package.json`的`prisma`字段中声明：

```json
"prisma": {
  "seed": "tsx prisma/seed.ts"
}
```

执行过程中，脚本会连接数据库并依次执行用户和作品的创建逻辑。若数据库连接失败或数据写入异常，脚本将捕获错误并退出，确保不会留下部分初始化的脏数据。成功完成后，控制台将输出统计摘要和测试账号信息，方便快速验证。

**Section sources**
- [package.json](file://package.json#L10-L11)
- [seed.ts](file://prisma/seed.ts#L1-L318)

## Docker初始化与测试环境集成
在Docker化部署和CI/CD流程中，数据播种可作为容器启动后的重要初始化步骤。通过在Dockerfile或docker-compose.yml中添加执行命令，可实现自动化数据准备。

典型集成方式如下：

```yaml
services:
  app:
    build: .
    depends_on:
      - db
    command: >
      sh -c "npx prisma migrate deploy &&
             npx prisma db seed &&
             npm run dev"
```

上述配置确保在应用启动前完成数据库迁移和种子数据填充。对于测试环境，可在CI流水线中加入独立的数据播种阶段，确保每次测试运行前数据库处于已知状态。

此外，结合`verify-database.ts`脚本可进一步增强初始化验证能力，确认关键表和配置项是否存在，从而构建完整的初始化闭环。

**Section sources**
- [package.json](file://package.json#L10-L11)
- [seed.ts](file://prisma/seed.ts#L1-L318)

## 数据依赖顺序处理
种子脚本严格遵循数据依赖顺序，确保外键约束的完整性。具体体现在用户与作品的关系处理上：必须先创建用户，才能将作品关联到特定用户。

实现方式为：
1. 首先遍历用户数组，使用`prisma.user.upsert`创建所有测试用户
2. 将创建的用户对象缓存至`createdUsers`数组
3. 在创建作品时，通过邮箱查找对应用户的ID，作为`userId`字段值

例如，艺术家“陈艺术家”的作品会通过以下逻辑关联：

```ts
userId: createdUsers.find(u => u.email === 'artist1@yunqi.com')?.id
```

对于批量生成的作品，则随机选择已创建的用户ID进行关联，确保每条作品都有合法的拥有者。这种先用户后作品的顺序设计，有效避免了因外键缺失导致的数据库约束错误。

**Section sources**
- [seed.ts](file://prisma/seed.ts#L70-L150)

## 幂等性保障机制
为防止重复执行种子脚本造成数据冗余，系统采用了多种幂等性保障措施。

对于用户数据，使用Prisma的`upsert`方法实现“存在则更新，不存在则创建”的逻辑：

```ts
await prisma.user.upsert({
  where: { email: userData.email },
  update: { /* 更新字段 */ },
  create: { /* 创建字段 */ }
});
```

此操作基于唯一索引`email`判断是否已存在记录，确保同一邮箱不会创建多个用户。

对于作品数据，脚本在创建前先查询同名作品是否存在：

```ts
const existingWork = await prisma.work.findFirst({
  where: { name: work.name }
});
if (!existingWork) {
  await prisma.work.create({ data: work });
}
```

该检查机制防止了重复插入相同名称的作品。结合`upsert`与`find + create`模式，整体实现了高度幂等的数据初始化流程，支持安全重复执行。

**Section sources**
- [seed.ts](file://prisma/seed.ts#L70-L85)
- [seed.ts](file://prisma/seed.ts#L155-L160)

## 敏感数据脱敏策略
尽管种子数据用于开发和测试环境，但仍需遵循最小化暴露原则，防止敏感信息泄露。

当前实现中的敏感数据主要为用户密码。脚本采用bcrypt哈希算法对明文密码进行加密处理：

```ts
const hashedPassword = await bcrypt.hash(userData.password, 12);
```

即使数据库被意外导出，攻击者也无法直接获取原始密码。同时，所有测试账号使用统一弱密码`123456`，仅限内部测试使用，不涉及真实用户凭证。

对于拒绝作品的原因描述，使用通用反馈语句而非具体技术细节，避免暴露审核标准或系统漏洞。例如：

```ts
rejectReason: '作品质量需要进一步提升，建议优化构图和色彩搭配。'
```

此类信息既具指导性又不泄露内部规则。未来可进一步引入环境判断逻辑，在生产环境中禁用种子脚本执行，或自动跳过敏感数据生成。

**Section sources**
- [seed.ts](file://prisma/seed.ts#L75-L78)
- [seed.ts](file://prisma/seed.ts#L275-L277)

## 总结
`prisma/seed.ts`脚本作为项目数据初始化的核心组件，实现了高效、可靠且可重复的数据播种机制。通过合理的结构设计、严格的依赖顺序控制、完善的幂等性保障和基本的脱敏策略，为开发与测试环境提供了坚实的数据基础。结合Prisma CLI和Docker集成，该方案可无缝融入现代DevOps流程，显著提升团队协作效率和系统稳定性。