# 监控与日志

<cite>
**本文档引用的文件**   
- [health/route.ts](file://src/app/api/health/route.ts)
- [ecosystem.config.js](file://ecosystem.config.js)
- [prisma.ts](file://src/lib/prisma.ts)
- [oss.ts](file://src/lib/oss.ts)
</cite>

## 目录
1. [引言](#引言)
2. [健康检查机制设计](#健康检查机制设计)
3. [日志管理体系](#日志管理体系)
4. [结构化日志与监控集成](#结构化日志与监控集成)
5. [系统监控架构图](#系统监控架构图)
6. [健康检查API序列图](#健康检查api序列图)
7. [日志处理流程图](#日志处理流程图)
8. [依赖分析](#依赖分析)
9. [性能考虑](#性能考虑)
10. [故障排查指南](#故障排查指南)
11. [结论](#结论)

## 引言
本文档旨在为数字化作品互动展示平台制定完整的系统监控与日志管理方案。基于现有的健康检查API端点和PM2配置，设计全面的监控体系，确保系统稳定性与可观测性。方案涵盖健康检查机制、日志分类采集、结构化输出以及与主流监控工具的集成。

## 健康检查机制设计
健康检查API（`src/app/api/health/route.ts`）通过测试数据库连接来判断系统状态。当收到GET请求时，系统会执行一个简单的数据库查询（`SELECT 1`）来验证数据库连接。如果查询成功，返回包含"connected"状态的JSON响应；如果失败，则捕获异常并返回"disconnected"状态及错误信息。该机制可被Kubernetes或负载均衡器用于探活，确保只有健康的实例接收流量。

**Section sources**
- [health/route.ts](file://src/app/api/health/route.ts#L0-L25)

## 日志管理体系
PM2配置文件（`ecosystem.config.js`）定义了完善的日志管理策略。生产环境和开发环境分别配置了独立的日志文件：`./logs/combined.log`、`./logs/out.log`和`./logs/error.log`用于生产环境，而`./logs/dev-combined.log`、`./logs/dev-out.log`和`./logs/dev-error.log`用于开发环境。所有日志均按指定格式（YYYY-MM-DD HH:mm:ss Z）记录时间戳，并实现了日志轮转和进程异常重启（最大内存1G时重启）。该配置确保了应用日志的有效聚合与管理。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L0-L58)

## 结构化日志与监控集成
建议采用JSON格式的结构化日志，便于日志采集系统解析。可集成Prometheus进行性能指标采集，如API延迟、错误率和内存使用情况。通过暴露/metrics端点，Prometheus可定期抓取这些指标。Grafana可用于可视化这些指标，创建仪表板监控系统健康状况。对于OSS存储服务的监控，可利用`src/lib/oss.ts`中定义的`objectExists`等函数实现存储服务可达性检测。

**Section sources**
- [oss.ts](file://src/lib/oss.ts#L261-L302)
- [prisma.ts](file://src/lib/prisma.ts#L6-L17)

## 系统监控架构图
```mermaid
graph TB
subgraph "前端"
Client["客户端/浏览器"]
end
subgraph "API网关"
LB["负载均衡器/Kubernetes"]
HealthCheck["健康检查探针"]
end
subgraph "应用服务"
App["Next.js应用"]
PM2["PM2进程管理"]
end
subgraph "数据存储"
DB["PostgreSQL数据库"]
OSS["OSS对象存储"]
end
subgraph "监控系统"
Prometheus["Prometheus指标采集"]
Grafana["Grafana可视化"]
LogSystem["日志采集系统"]
end
Client --> LB
LB --> HealthCheck
HealthCheck --> App
App --> DB
App --> OSS
App --> PM2
PM2 --> LogSystem
App --> Prometheus
Prometheus --> Grafana
```

**Diagram sources **
- [health/route.ts](file://src/app/api/health/route.ts#L0-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L58)

## 健康检查API序列图
```mermaid
sequenceDiagram
participant LB as "负载均衡器"
participant API as "健康检查API"
participant DB as "数据库"
LB->>API : GET /api/health
API->>DB : 执行 SELECT 1 查询
alt 数据库连接正常
DB-->>API : 返回查询结果
API-->>LB : 200 OK {success : true, database : 'connected'}
else 数据库连接异常
DB--xAPI : 连接失败
API->>API : 记录错误日志
API-->>LB : 500 Internal Server Error {success : false, database : 'disconnected'}
end
```

**Diagram sources **
- [health/route.ts](file://src/app/api/health/route.ts#L0-L25)

## 日志处理流程图
```mermaid
flowchart TD
Start([应用启动]) --> PM2Config["加载PM2配置<br>ecosystem.config.js"]
PM2Config --> LogSetup["设置日志路径<br>./logs/*.log"]
LogSetup --> AppStart["启动应用进程"]
AppStart --> AppRunning["应用运行中"]
subgraph "日志生成"
AppRunning --> InfoLog["生成普通日志<br>输出到out.log"]
AppRunning --> ErrorLog["生成错误日志<br>输出到error.log"]
AppRunning --> CombinedLog["生成综合日志<br>输出到combined.log"]
end
InfoLog --> LogRotation["日志轮转机制"]
ErrorLog --> LogRotation
CombinedLog --> LogRotation
LogRotation --> LogArchive["归档旧日志"]
LogArchive --> LogCollection["日志采集系统<br>如ELK/Fluentd"]
LogCollection --> LogStorage["日志存储"]
LogStorage --> LogAnalysis["日志分析与告警"]
AppRunning --> MemoryCheck["内存监控"]
MemoryCheck --> MaxMemory{"内存 > 1G?"}
MaxMemory --> |是| RestartApp["PM2重启应用"]
MaxMemory --> |否| ContinueApp["继续运行"]
RestartApp --> AppStart
ContinueApp --> AppRunning
```

**Diagram sources **
- [ecosystem.config.js](file://ecosystem.config.js#L0-L58)

## 依赖分析
系统健康检查依赖于Prisma数据库客户端（`prisma.$queryRaw`）和Next.js的API路由功能。日志管理依赖PM2进程管理器及其配置文件。OSS存储服务的健康检查依赖`ali-oss`库和相关环境变量配置。这些依赖关系构成了系统监控的基础，任何依赖项的故障都可能影响监控结果的准确性。

**Section sources**
- [health/route.ts](file://src/app/api/health/route.ts#L0-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L58)
- [prisma.ts](file://src/lib/prisma.ts#L6-L17)
- [oss.ts](file://src/lib/oss.ts#L0-L302)

## 性能考虑
健康检查API应保持轻量，避免复杂的数据库查询以减少对生产数据库的压力。建议在健康检查中使用只读连接或连接池中的空闲连接。日志记录应避免在高频率的代码路径中记录大量调试信息，以免影响应用性能。PM2的`max_memory_restart`配置（1G）有助于防止内存泄漏导致的性能下降。

## 故障排查指南
当健康检查失败时，首先检查数据库连接配置和网络连通性。查看`./logs/error.log`中的详细错误信息，特别是"健康检查失败"相关的日志条目。对于日志文件问题，确认`./logs`目录存在且应用有写入权限。若PM2进程频繁重启，检查内存使用情况并分析`out.log`中的应用输出。

**Section sources**
- [health/route.ts](file://src/app/api/health/route.ts#L0-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L58)

## 结论
本方案基于现有代码基础，设计了完整的系统监控与日志管理架构。通过健康检查API、PM2日志管理和结构化监控集成，可有效提升系统的可观测性和稳定性。建议进一步实现OSS服务的健康检查，并建立完善的告警机制，以实现全面的系统监控。