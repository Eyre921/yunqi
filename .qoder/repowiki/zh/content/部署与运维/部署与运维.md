# 部署与运维

<cite>
**本文档引用的文件**  
- [ecosystem.config.js](file://ecosystem.config.js)
- [package.json](file://package.json)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [verify-database.ts](file://verify-database.ts)
- [prisma/schema.prisma](file://prisma/schema.prisma)
</cite>

## 目录
1. [构建流程](#构建流程)
2. [PM2进程管理](#pm2进程管理)
3. [环境变量最佳实践](#环境变量最佳实践)
4. [数据库迁移策略](#数据库迁移策略)
5. [健康检查机制](#健康检查机制)
6. [监控与日志管理](#监控与日志管理)
7. [灾难恢复与回滚计划](#灾难恢复与回滚计划)

## 构建流程

本项目基于Next.js框架，生产环境构建使用`next build`命令。该命令会预编译所有页面和资源，生成优化后的静态文件和服务器端代码，输出至`.next`目录。

构建过程包括：
- TypeScript类型检查与编译
- 页面和服务端路由的静态生成（SSG）或服务端渲染（SSR）预处理
- 资源压缩与代码分割
- 样式表（Tailwind CSS）的生成与优化

执行构建命令：
```bash
npm run build
```

构建成功后，可通过`npm start`启动生产服务器。

**Section sources**
- [package.json](file://package.json#L5-L7)

## PM2进程管理

项目使用PM2作为Node.js进程管理器，通过`ecosystem.config.js`配置文件定义应用运行参数。

### 生产环境应用配置
- **应用名称**: `yunqi-platform`
- **启动脚本**: `npm start`
- **工作目录**: 项目根目录
- **实例数量**: 1（可选集群模式）
- **自动重启**: 启用
- **内存限制重启**: 当内存使用超过1GB时自动重启
- **环境变量**: 定义`NODE_ENV`和`PORT`，支持`production`、`development`等环境

### 开发环境应用配置
- **应用名称**: `yunqi-platform-dev`
- **启动脚本**: `npm run dev`
- **文件监听**: 启用，自动重启
- **忽略监听目录**: `node_modules`, `.next`, `logs`, `.git`, `public/uploads`
- **端口**: 3001

### PM2常用命令
| 命令 | 说明 |
|------|------|
| `pm2 start ecosystem.config.js --env production` | 启动生产环境应用 |
| `pm2 start ecosystem.config.js --only yunqi-platform-dev` | 启动开发环境应用 |
| `pm2 status` | 查看进程状态 |
| `pm2 logs` | 查看实时日志 |
| `pm2 monit` | 进入监控界面 |
| `pm2 restart yunqi-platform` | 重启应用 |
| `pm2 stop yunqi-platform` | 停止应用 |
| `pm2 delete yunqi-platform` | 删除应用 |
| `pm2 save && pm2 startup` | 保存配置并设置开机自启 |

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L109)

## 环境变量最佳实践

项目通过`.env`或`.env.local`文件管理环境变量，使用`dotenv`库加载。

### 核心环境变量
- `DATABASE_URL`: 数据库连接字符串，格式为`postgresql://user:password@host:port/dbname`
- `ALI_OSS_REGION`: 阿里云OSS区域
- `ALI_OSS_ACCESS_KEY_ID`: 阿里云OSS访问密钥ID
- `ALI_OSS_ACCESS_KEY_SECRET`: 阿里云OSS访问密钥
- `ALI_OSS_BUCKET`: 阿里云OSS存储桶名称
- `ALI_OSS_ENDPOINT`: 阿里云OSS自定义域名或内网地址
- `ADMIN_DEFAULT_PASSWORD`: 管理员默认密码（用于初始化）

### 最佳实践建议
1. **敏感信息保护**: 将`.env.local`加入`.gitignore`，避免泄露密钥
2. **环境隔离**: 使用不同`.env`文件区分开发、测试、生产环境
3. **默认值设置**: 在代码中为环境变量提供安全的默认值
4. **运行时验证**: 启动时验证必要环境变量是否存在（如`run-oss-test.js`中的验证逻辑）

**Section sources**
- [package.json](file://package.json#L34-L35)
- [run-oss-test.js](file://run-oss-test.js#L12-L23)

## 数据库迁移策略

项目使用Prisma ORM进行数据库迁移管理。

### 生产环境迁移命令
```bash
npx prisma migrate deploy
```
此命令会应用所有未在数据库中执行的迁移文件，适用于生产环境部署。

### 迁移流程
1. 开发阶段通过`prisma migrate dev`创建并应用迁移
2. 提交迁移文件至版本控制系统
3. 生产部署时执行`prisma migrate deploy`同步数据库结构

### 数据库验证与初始化
项目提供`verify-database.ts`脚本用于验证数据库连接和表结构完整性。同时支持通过`--create-admin`参数创建管理员用户。

执行管理员创建：
```bash
node verify-database.js --create-admin
```

**Section sources**
- [package.json](file://package.json#L10-L13)
- [prisma/schema.prisma](file://prisma/schema.prisma#L6-L10)
- [verify-database.ts](file://verify-database.ts#L73-L125)

## 健康检查机制

系统提供健康检查API端点，用于监控服务状态和数据库连接。

### 健康检查API
- **路径**: `/api/health`
- **方法**: GET
- **功能**: 
  - 测试数据库连接（执行`SELECT 1`查询）
  - 返回服务状态、数据库连接状态和时间戳

### 响应示例
```json
{
  "success": true,
  "message": "API服务正常",
  "timestamp": "2025-09-20T10:00:00.000Z",
  "database": "connected"
}
```

该端点可用于Kubernetes存活探针、负载均衡健康检查等场景。

**Section sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L1-L25)
- [src/lib/prisma.ts](file://src/lib/prisma.ts#L1-L19)

## 监控与日志管理

### 关键监控指标
| 指标 | 说明 | 采集方式 |
|------|------|----------|
| API延迟 | 各端点响应时间 | 应用内埋点或APM工具 |
| 数据库连接数 | 当前活跃连接数 | 数据库监控或Prisma日志 |
| 错误率 | HTTP 5xx错误比例 | 日志分析或监控系统 |
| 内存使用 | Node.js进程内存占用 | PM2监控或系统工具 |
| CPU使用率 | 进程CPU占用 | PM2监控或系统工具 |

### 日志管理
- **日志位置**: `./logs/`目录
- **日志文件**:
  - `combined.log`: 综合日志
  - `out.log`: 标准输出
  - `error.log`: 错误输出
- **日志格式**: 包含时间戳（`YYYY-MM-DD HH:mm:ss Z`格式）
- **日志轮转**: 建议配置外部日志轮转工具（如logrotate）

建议集成集中式日志系统（如ELK、Graylog）进行日志收集与分析。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L25-L31)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L10-L12)

## 灾难恢复与回滚计划

### 备份策略
1. **数据库备份**: 定期备份PostgreSQL数据库，建议每日全量备份+WAL归档
2. **OSS存储备份**: 配置阿里云OSS跨区域复制或版本控制
3. **配置备份**: 将`.env`等配置文件进行加密备份

### 回滚计划
1. **代码回滚**:
   - 使用Git回退到稳定版本
   - 重新执行`npm run build`和PM2部署
2. **数据库回滚**:
   - 使用Prisma迁移历史，执行反向迁移（需手动编写）
   - 或从备份恢复数据库
3. **应急措施**:
   - 通过PM2快速切换到上一个稳定实例
   - 启用备用服务器或回滚到上一个Docker镜像版本

### 高可用建议
- 配置PM2集群模式（`instances: 'max'`）
- 使用负载均衡部署多个实例
- 数据库配置主从复制

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L50-L58)
- [package.json](file://package.json#L6-L7)