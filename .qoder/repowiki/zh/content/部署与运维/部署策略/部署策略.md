# 部署策略

<cite>
**本文档引用文件**  
- [ecosystem.config.js](file://ecosystem.config.js)
- [middleware.ts](file://middleware.ts)
- [next.config.ts](file://next.config.ts)
- [package.json](file://package.json)
</cite>

## 目录
1. [引言](#引言)
2. [PM2进程管理部署](#pm2进程管理部署)
3. [Docker容器化部署](#docker容器化部署)
4. [中间件与请求预处理](#中间件与请求预处理)
5. [生产级部署实践](#生产级部署实践)
6. [部署方式对比与适用场景](#部署方式对比与适用场景)
7. [结论](#结论)

## 引言
本文档全面介绍“数字化作品互动展示平台”的部署方案，涵盖PM2进程管理与Docker容器化两种主流部署模式。基于项目实际配置文件，详细说明多环境配置、进程守护、负载均衡、自动重启策略、镜像构建优化、请求拦截机制及生产环境最佳实践，为系统稳定运行提供技术保障。

## PM2进程管理部署

`ecosystem.config.js` 文件定义了基于PM2的进程管理配置，支持多环境（development、production）部署，具备进程守护、自动重启和日志管理能力。

### 多环境配置
PM2通过 `env_*` 前缀的配置项实现多环境管理：
- `env_development`：开发环境配置，端口3001，启用文件监听
- `env_production`：生产环境配置，端口3000，禁用监听，优化性能
- `env`：默认环境变量，被具体环境覆盖

### 进程守护与自动重启
- `autorestart: true`：进程异常退出后自动重启
- `max_memory_restart: '1G'`：内存超过1GB时自动重启，防止内存泄漏
- `min_uptime: '10s'` 和 `max_restarts: 10`：10秒内重启超过10次则停止，避免无限重启循环

### 负载均衡（集群模式）
配置中注释的 `instances: 'max'` 和 `exec_mode: 'cluster'` 表明支持Node.js集群模式，可利用多核CPU实现负载均衡，提升并发处理能力。

### 日志管理
配置了独立的输出日志、错误日志和合并日志，便于问题排查和监控：
- `out_file`：标准输出日志
- `error_file`：错误日志
- `log_file`：合并日志
- `log_date_format`：统一日志时间格式

### 部署自动化
`deploy` 配置定义了生产环境的自动化部署流程：
- `post-deploy`：拉取代码后自动执行 `npm install`、`npm run build` 和 `pm2 reload`
- 结合 `pm2 startup` 可实现开机自启，确保服务高可用

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L109)

## Docker容器化部署

尽管项目根目录未提供 `Dockerfile`，但基于 `package.json` 和 `next.config.ts` 可推断出标准的Docker构建策略。

### 镜像构建步骤
1. **基础镜像选择**：使用 `node:18-alpine` 或类似轻量级镜像
2. **依赖安装**：分层COPY `package.json` 和 `package-lock.json`，先安装生产依赖
3. **源码复制**：COPY 源码到容器
4. **构建应用**：执行 `npm run build` 生成静态资源
5. **启动服务**：使用 `npm start` 启动Next.js服务

### 多阶段构建优化
采用多阶段构建（multi-stage build）：
- **构建阶段**：包含完整Node.js环境和构建工具，执行 `npm run build`
- **运行阶段**：仅包含Node.js运行时和构建产物，显著减小镜像体积

### 依赖缓存技巧
通过分层COPY策略，利用Docker缓存机制：
- 先COPY `package*.json` 并安装依赖，此层在 `package.json` 未变更时可缓存复用
- 再COPY 源码，仅当源码变更时才重新构建，大幅提升CI/CD效率

### 容器启动命令
最终镜像使用 `npm start` 命令启动，对应 `package.json` 中的 `next start`，以生产模式运行Next.js应用。

**Section sources**
- [package.json](file://package.json#L1-L62)
- [next.config.ts](file://next.config.ts#L1-L69)

## 中间件与请求预处理

`middleware.ts` 实现了基于Next.js中间件的请求拦截与路由预处理，是生产环境安全与用户体验的关键组件。

### 路由拦截逻辑
中间件通过 `config.matcher` 定义了需要拦截的路由：
- `/admin/*`：管理后台
- `/upload/*`：上传页面
- `/auth/*`：认证页面
- `/profile/*`：个人中心

### 认证与重定向策略
- **已登录用户访问登录页**：根据角色重定向至 `/admin`（管理员）或 `/`（普通用户）
- **非管理员访问管理页**：重定向至首页，实现权限控制
- **未登录用户访问个人中心**：重定向至登录页
- **上传页面**：当前允许游客访问（代码中注释了登录验证）

### 生产环境作用
该中间件在请求到达具体页面前完成身份验证和路由控制，避免了在每个页面中重复编写权限逻辑，提升了代码复用性和安全性。

**Section sources**
- [middleware.ts](file://middleware.ts#L1-L51)

## 生产级部署实践

### 环境变量注入
通过 `.env` 文件或容器环境变量注入敏感信息（如数据库连接、OSS密钥），避免硬编码。`package.json` 中的 `test:oss` 脚本展示了如何从 `process.env` 读取OSS配置。

### 静态资源托管
`next.config.ts` 配置了静态资源缓存策略：
- `_next/static/*`：设置 `max-age=31536000`（一年）和 `immutable`，实现长期缓存
- `/images/*`：设置 `max-age=2592000`（30天），平衡更新与性能
- 其他页面：设置 `max-age=300`（5分钟），保证内容及时更新

### HTTPS与安全头
`next.config.ts` 中的 `headers` 配置了关键安全头：
- `Strict-Transport-Security`：强制HTTPS
- `X-Content-Type-Options: nosniff`：防止MIME类型嗅探
- API接口的CORS策略：仅允许 `https://yunqi.nfeyre.top` 跨域访问

### 外部依赖处理
`serverExternalPackages` 配置了 `bcryptjs` 和 `ali-oss` 作为外部包，避免Next.js在构建时尝试打包这些原生模块，防止构建失败。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L69)
- [package.json](file://package.json#L1-L62)

## 部署方式对比与适用场景

| 特性 | PM2部署 | Docker部署 |
| :--- | :--- | :--- |
| **复杂度** | 简单，直接在服务器运行 | 中等，需编写Dockerfile和管理容器 |
| **环境一致性** | 依赖服务器环境，易出现“在我机器上能运行”问题 | 高，镜像包含所有依赖，环境一致 |
| **资源占用** | 轻量，直接运行Node.js进程 | 稍高，有容器运行时开销 |
| **扩展性** | 手动管理多实例，较复杂 | 易于与Kubernetes等编排工具集成，支持自动扩缩容 |
| **CI/CD集成** | 需脚本配合，如 `post-deploy` | 天然适合CI/CD，构建即部署 |
| **适用场景** | 小型项目、快速部署、资源受限环境 | 微服务架构、云原生环境、需要高可移植性的场景 |

## 结论
本项目提供了灵活的部署方案。PM2部署适合快速上线和简单运维，而Docker容器化部署则更适合生产环境和云原生架构。结合 `middleware.ts` 的请求预处理和 `next.config.ts` 的生产优化，无论采用哪种部署方式，都能确保系统安全、高效、稳定地运行。建议在开发和测试阶段使用PM2简化流程，在生产环境采用Docker以保证环境一致性和可扩展性。