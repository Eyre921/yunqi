# 部署优化脚本

<cite>
**本文档引用的文件**  
- [optimize-server.sh](file://scripts/optimize-server.sh)
- [ecosystem.config.js](file://ecosystem.config.js)
- [package.json](file://package.json)
</cite>

## 目录
1. [环境检查](#环境检查)
2. [Node.js配置](#nodejs配置)
3. [PM2优化](#pm2优化)
4. [构建流程](#构建流程)
5. [开机自启设置](#开机自启设置)
6. [状态监控](#状态监控)
7. [执行示例](#执行示例)
8. [常见问题解决方案](#常见问题解决方案)

## 环境检查

部署优化脚本的第一步是检查运行环境是否满足基本要求。该脚本会验证Node.js和npm是否已正确安装，这是后续所有操作的基础。

脚本通过`node --version`和`npm --version`命令检查Node.js和npm的安装情况。如果任一工具未安装，脚本将终止执行并提示相应的错误信息。此步骤确保了应用运行环境的完整性，避免因缺少必要工具而导致后续步骤失败。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L10-L15)

## Node.js配置

在确认基础环境就绪后，脚本会进行Node.js应用的配置优化。这包括设置生产环境变量和内存限制，以确保应用在最佳状态下运行。

脚本将`NODE_ENV`环境变量设置为`production`，并配置`NODE_OPTIONS`参数，将最大旧生代内存大小限制为8192MB（8GB）。这些配置有助于提升Node.js应用的性能和稳定性，特别是在高负载情况下。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L20-L24)

## PM2优化

PM2是Node.js应用的进程管理器，用于保持应用常驻后台运行。脚本会检查PM2是否已安装，若未安装则自动通过npm进行全局安装。

脚本会验证`ecosystem.config.js`配置文件是否存在。该文件包含了应用的详细启动配置，包括进程名称、启动脚本、工作目录、实例数量、自动重启策略等。如果配置文件缺失，脚本将终止执行，确保部署过程的可靠性。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L27-L36)
- [ecosystem.config.js](file://ecosystem.config.js#L1-L257)

## 构建流程

构建步骤是将源代码编译为生产环境可用的静态文件。脚本通过执行`npm run build`命令来启动Next.js应用的生产构建流程。

此过程会根据`next.config.ts`中的配置，对代码进行优化、压缩和打包，生成高度优化的静态资源。构建完成后，应用将准备好在生产环境中启动，确保用户能够获得最佳的加载速度和性能体验。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L39-L41)
- [package.json](file://package.json#L5-L7)

## 开机自启设置

为了确保应用在服务器重启后能够自动恢复运行，脚本提供了设置PM2开机自启的功能。这是一个可选步骤，脚本会提示用户是否进行设置。

如果用户选择设置，脚本将执行`pm2 startup`生成系统启动脚本，并执行`pm2 save`保存当前的进程列表。这样，PM2守护进程会在系统启动时自动运行，并恢复之前保存的应用进程，实现应用的高可用性。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L44-L52)
- [ecosystem.config.js](file://ecosystem.config.js#L147-L168)

## 状态监控

部署完成后，脚本会显示应用的当前状态，帮助用户确认部署是否成功。通过`pm2 status`命令，用户可以查看所有由PM2管理的应用进程，包括其名称、状态（在线/离线）、CPU和内存使用情况、重启次数等关键信息。

此外，`ecosystem.config.js`文件中还包含了详细的PM2使用说明，提供了丰富的监控和管理命令，如`pm2 logs`查看日志、`pm2 monit`实时监控、`pm2 show`查看详细信息等，为后续的运维提供了便利。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L55-L57)
- [ecosystem.config.js](file://ecosystem.config.js#L170-L256)

## 执行示例

以下是一个完整的脚本执行示例：

```bash
$ ./scripts/optimize-server.sh
🚀 开始应用层性能优化...
📋 检查运行环境...
v18.17.0
10.8.2
📦 安装PM2...
/usr/local/bin/pm2 -> /usr/local/lib/node_modules/pm2/bin/pm2
...
✅ PM2开机自启已设置
📊 应用状态：
┌────┬─────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name            │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼─────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ yunqi-platform  │ default     │ 1.0.0   │ fork    │ 12345    │ 2m     │ 0    │ online    │ 0%       │ 80.2mb   │ user     │ disabled │
└────┴─────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
✅ 应用层优化完成！
```

## 常见问题解决方案

**问题1：Node.js或npm未安装**
- **解决方案**：根据系统环境安装Node.js。推荐使用Node版本管理器（如nvm）来安装和管理Node.js版本。

**问题2：ecosystem.config.js文件不存在**
- **解决方案**：检查文件路径是否正确，确保该文件位于项目根目录下。如果文件丢失，可以从版本控制系统中恢复或根据模板重新创建。

**问题3：PM2开机自启设置失败**
- **解决方案**：确保执行`pm2 startup`命令的用户具有足够的权限（通常需要sudo权限）。根据提示执行生成的命令。

**问题4：应用启动后立即崩溃**
- **解决方案**：使用`pm2 logs`命令查看详细的错误日志。常见原因包括环境变量未设置、数据库连接失败或端口被占用。检查`ecosystem.config.js`中的`env`配置和日志输出。

**问题5：内存使用率过高**
- **解决方案**：`ecosystem.config.js`中的`max_memory_restart`设置为'12G'，当应用内存使用超过此阈值时，PM2会自动重启应用。同时，`performance-monitor.ts`文件中实现了性能监控和告警功能，当CPU或内存使用率超过阈值时会触发告警。

**Section sources**
- [optimize-server.sh](file://scripts/optimize-server.sh#L10-L66)
- [ecosystem.config.js](file://ecosystem.config.js#L1-L257)
- [src/lib/performance-monitor.ts](file://src/lib/performance-monitor.ts#L1-L221)