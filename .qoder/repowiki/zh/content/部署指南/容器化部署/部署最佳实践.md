# éƒ¨ç½²æœ€ä½³å®è·µ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨æ–‡ä»¶**  
- [ecosystem.config.js](file://ecosystem.config.js)
- [middleware.ts](file://middleware.ts)
- [next.config.ts](file://next.config.ts)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts)
- [src/lib/performance-monitor.ts](file://src/lib/performance-monitor.ts)
- [src/app/api/platform-config/route.ts](file://src/app/api/platform-config/route.ts)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é•œåƒæ„å»ºä¸æ ‡ç­¾ç®¡ç†](#é•œåƒæ„å»ºä¸æ ‡ç­¾ç®¡ç†)
3. [å®¹å™¨è¿è¡Œå‚æ•°é…ç½®](#å®¹å™¨è¿è¡Œå‚æ•°é…ç½®)
4. [å¥åº·æ£€æŸ¥æœºåˆ¶](#å¥åº·æ£€æŸ¥æœºåˆ¶)
5. [ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†](#ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†)
6. [é™æ€èµ„æºç¼“å­˜ç­–ç•¥](#é™æ€èµ„æºç¼“å­˜ç­–ç•¥)
7. [ä¸­é—´ä»¶å…¼å®¹æ€§å¤„ç†](#ä¸­é—´ä»¶å…¼å®¹æ€§å¤„ç†)
8. [Kubernetes ä¸ Docker Swarm é›†æˆå»ºè®®](#kubernetes-ä¸-docker-swarm-é›†æˆå»ºè®®)
9. [å®Œæ•´éƒ¨ç½²è„šæœ¬ç¤ºä¾‹](#å®Œæ•´éƒ¨ç½²è„šæœ¬ç¤ºä¾‹)
10. [CI/CD é›†æˆæ€è·¯](#cicd-é›†æˆæ€è·¯)

## ç®€ä»‹
æœ¬æ–‡æ¡£æ€»ç»“äº†æ•°å­—åŒ–ä½œå“äº’åŠ¨å±•ç¤ºå¹³å°çš„å®¹å™¨åŒ–éƒ¨ç½²ç»¼åˆæœ€ä½³å®è·µã€‚åŸºäºé¡¹ç›®å®é™…æ¶æ„ï¼Œæ¶µç›–ä»é•œåƒæ„å»ºã€å®¹å™¨è¿è¡Œã€å¥åº·æ£€æŸ¥åˆ°é›†ç¾¤ç¼–æ’çš„å…¨æµç¨‹éƒ¨ç½²ç­–ç•¥ã€‚é‡ç‚¹åˆ†æäº† Next.js åº”ç”¨åœ¨å®¹å™¨ç¯å¢ƒä¸­çš„ç‰¹æ®Šéœ€æ±‚ï¼ŒåŒ…æ‹¬ä¸­é—´ä»¶è¡Œä¸ºã€é™æ€èµ„æºç¼“å­˜ã€æ€§èƒ½ç›‘æ§å’Œå®‰å…¨é…ç½®ï¼Œæä¾›å¯ç›´æ¥è½åœ°çš„éƒ¨ç½²æ–¹æ¡ˆã€‚

## é•œåƒæ„å»ºä¸æ ‡ç­¾ç®¡ç†
åœ¨æ„å»ºå®¹å™¨é•œåƒæ—¶ï¼Œåº”éµå¾ªæœ€å°åŒ–åŸåˆ™ï¼Œä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä»¥å‡å°æœ€ç»ˆé•œåƒä½“ç§¯ã€‚å»ºè®®ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ `v1.2.0`ï¼‰å’Œç¯å¢ƒæ ‡ç­¾ï¼ˆå¦‚ `latest`ã€`staging`ã€`production`ï¼‰è¿›è¡Œç®¡ç†ã€‚

```Dockerfile
# ç¤ºä¾‹ Dockerfile ç‰‡æ®µ
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM node:18-alpine AS runner
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package.json ./package.json
USER node
EXPOSE 3000
ENV NODE_ENV=production
CMD ["npm", "start"]
```

**Section sources**
- [package.json](file://package.json#L1-L20)
- [next.config.ts](file://next.config.ts#L1-L10)

## å®¹å™¨è¿è¡Œå‚æ•°é…ç½®
è¿è¡Œå®¹å™¨æ—¶åº”åˆç†é…ç½®å…³é”®å‚æ•°ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§å’Œèµ„æºåˆ©ç”¨ç‡ã€‚å‚è€ƒ `ecosystem.config.js` ä¸­çš„ PM2 é…ç½®ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š

```bash
docker run -d \
  --name yunqi-platform \
  -p 3000:3000 \
  --restart unless-stopped \
  --memory=3g \
  --cpus=2 \
  -e NODE_ENV=production \
  -e PORT=3000 \
  -e DATABASE_URL=postgresql://user:pass@db:5432/yunqi \
  yunqi-platform:v1.2.0
```

- `-d`ï¼šåå°è¿è¡Œå®¹å™¨
- `-p 3000:3000`ï¼šç«¯å£æ˜ å°„
- `--restart unless-stopped`ï¼šå®¹å™¨å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
- `--memory=3g`ï¼šé™åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢ OOM
- `--cpus=2`ï¼šé™åˆ¶ CPU èµ„æº

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)
- [package.json](file://package.json#L10-L15)

## å¥åº·æ£€æŸ¥æœºåˆ¶
å¥åº·æ£€æŸ¥æ˜¯ç¡®ä¿æœåŠ¡å¯ç”¨æ€§çš„å…³é”®ã€‚æœ¬é¡¹ç›®æä¾›äº† `/api/health` æ¥å£ç”¨äºå¥åº·æ£€æŸ¥ï¼Œåº”é…ç½®å®¹å™¨çº§å’Œç¼–æ’çº§åŒé‡å¥åº·æ£€æŸ¥ã€‚

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:3000/api/health || exit 1
```

æˆ–åœ¨ Docker Compose ä¸­é…ç½®ï¼š

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s
```

è¯¥å¥åº·æ£€æŸ¥ä¼šéªŒè¯åº”ç”¨æœåŠ¡å’Œæ•°æ®åº“è¿æ¥çŠ¶æ€ï¼Œç¡®ä¿æœåŠ¡å®Œå…¨å°±ç»ªã€‚

```mermaid
flowchart TD
Start([å¥åº·æ£€æŸ¥è¯·æ±‚]) --> APIHealth["è°ƒç”¨ /api/health"]
APIHealth --> DBCheck["æµ‹è¯•æ•°æ®åº“è¿æ¥"]
DBCheck --> DBSuccess{"è¿æ¥æˆåŠŸ?"}
DBSuccess --> |æ˜¯| ReturnOK["è¿”å› 200 OK"]
DBSuccess --> |å¦| ReturnError["è¿”å› 500 Error"]
ReturnOK --> End([å¥åº·çŠ¶æ€æ­£å¸¸])
ReturnError --> End
```

**Diagram sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L0-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)

**Section sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L0-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)

## ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†
ç¯å¢ƒå˜é‡æ˜¯é…ç½®åº”ç”¨è¡Œä¸ºçš„å…³é”®ï¼Œå¿…é¡»å®‰å…¨ä¼ é€’ã€‚æ•æ„Ÿä¿¡æ¯å¦‚æ•°æ®åº“å‡­è¯ã€API å¯†é’¥ç­‰åº”é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œé¿å…ç¡¬ç¼–ç ã€‚

### ç¯å¢ƒå˜é‡é…ç½®
```env
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://user:pass@db:5432/yunqi
NEXTAUTH_SECRET=your-secret-here
REDIS_URL=redis://redis:6379
```

### æ•æ„Ÿä¿¡æ¯éš”ç¦»ç­–ç•¥
1. **ä½¿ç”¨ .env æ–‡ä»¶**ï¼šåœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ `.env.local`ï¼Œå¹¶ç¡®ä¿å…¶åœ¨ `.gitignore` ä¸­
2. **å®¹å™¨ç¯å¢ƒå˜é‡**ï¼šåœ¨ `docker run` æˆ–ç¼–æ’æ–‡ä»¶ä¸­é€šè¿‡ `-e` å‚æ•°ä¼ é€’
3. **å¯†é’¥ç®¡ç†æœåŠ¡**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Kubernetes Secrets æˆ– Hashicorp Vault
4. **è¿è¡Œæ—¶æ³¨å…¥**ï¼šé€šè¿‡ init å®¹å™¨æˆ– sidecar å®¹å™¨æ³¨å…¥æ•æ„Ÿé…ç½®

```mermaid
flowchart LR
Secrets["å¯†é’¥ç®¡ç†ç³»ç»Ÿ<br/>(Kubernetes Secrets/Vault)"] --> |æ³¨å…¥| Env["ç¯å¢ƒå˜é‡"]
Env --> App["Next.js åº”ç”¨"]
App --> DB["æ•°æ®åº“"]
App --> OSS["å¯¹è±¡å­˜å‚¨"]
App --> Auth["è®¤è¯æœåŠ¡"]
```

**Diagram sources**
- [src/lib/auth.ts](file://src/lib/auth.ts#L0-L72)
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L20)

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)
- [src/lib/auth.ts](file://src/lib/auth.ts#L0-L72)

## é™æ€èµ„æºç¼“å­˜ç­–ç•¥
åŸºäº `next.config.ts` ä¸­çš„é…ç½®ï¼Œå®æ–½åˆ†å±‚ç¼“å­˜ç­–ç•¥ä»¥æå‡æ€§èƒ½ï¼š

```typescript
// next.config.ts ç¼“å­˜é…ç½®
headers: [
  {
    source: '/_next/static/:path*',
    headers: [
      { key: 'Cache-Control', value: 'public, max-age=31536000, immutable' }
    ]
  },
  {
    source: '/images/:path*',
    headers: [
      { key: 'Cache-Control', value: 'public, max-age=2592000' }
    ]
  },
  {
    source: '/api/:path*',
    headers: [
      { key: 'Cache-Control', value: 'no-cache' }
    ]
  }
]
```

### ç¼“å­˜ç­–ç•¥åˆ†çº§
| èµ„æºç±»å‹ | ç¼“å­˜ç­–ç•¥ | è¯´æ˜ |
|---------|---------|------|
| é™æ€èµ„æº | `max-age=31536000, immutable` | æ„å»ºæ—¶å“ˆå¸Œæ–‡ä»¶åï¼Œæ°¸ä¹…ç¼“å­˜ |
| å›¾ç‰‡èµ„æº | `max-age=2592000` | 30å¤©ç¼“å­˜ï¼Œæ”¯æŒCDNåˆ·æ–° |
| API æ¥å£ | `no-cache` | ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®å®æ—¶æ€§ |
| é¡µé¢å†…å®¹ | `s-maxage=3600` | 1å°æ—¶CDNç¼“å­˜ï¼Œæ”¯æŒstale-while-revalidate |

**Section sources**
- [next.config.ts](file://next.config.ts#L45-L102)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L0-L25)

## ä¸­é—´ä»¶å…¼å®¹æ€§å¤„ç†
Next.js ä¸­é—´ä»¶åœ¨å®¹å™¨ç¯å¢ƒä¸­éœ€ç‰¹åˆ«æ³¨æ„è·¯å¾„åŒ¹é…å’Œæƒé™æ§åˆ¶ã€‚æœ¬é¡¹ç›® `middleware.ts` å®ç°äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼š

```mermaid
flowchart TD
Start([è¯·æ±‚è¿›å…¥]) --> AuthCheck["æ£€æŸ¥è®¤è¯çŠ¶æ€"]
AuthCheck --> IsAuth{"å·²è®¤è¯?"}
IsAuth --> |å¦| RedirectLogin["é‡å®šå‘åˆ°ç™»å½•é¡µ"]
IsAuth --> |æ˜¯| PageType["åˆ¤æ–­é¡µé¢ç±»å‹"]
PageType --> IsAuthPage{"è®¤è¯é¡µé¢?"}
IsAuthPage --> |æ˜¯| RoleCheck["æ£€æŸ¥ç”¨æˆ·è§’è‰²"]
RoleCheck --> IsAdmin{"ç®¡ç†å‘˜?"}
IsAdmin --> |æ˜¯| RedirectAdmin["é‡å®šå‘åˆ°ç®¡ç†é¡µé¢"]
IsAdmin --> |å¦| RedirectHome["é‡å®šå‘åˆ°é¦–é¡µ"]
PageType --> IsAdminPage{"ç®¡ç†é¡µé¢?"}
IsAdminPage --> |æ˜¯| CheckAdminRole["éªŒè¯ç®¡ç†å‘˜æƒé™"]
CheckAdminRole --> |æ— æƒé™| RedirectHome
PageType --> IsProfilePage{"ä¸ªäººä¸­å¿ƒ?"}
IsProfilePage --> |æœªè®¤è¯| RedirectLogin
PageType --> IsUploadPage{"ä¸Šä¼ é¡µé¢?"}
IsUploadPage --> |æ¸¸å®¢å¯è®¿é—®| Continue["ç»§ç»­è¯·æ±‚"]
RedirectLogin --> End([å“åº”])
RedirectHome --> End
RedirectAdmin --> End
Continue --> End
```

**Diagram sources**
- [middleware.ts](file://middleware.ts#L0-L51)

**Section sources**
- [middleware.ts](file://middleware.ts#L0-L51)
- [src/lib/auth.ts](file://src/lib/auth.ts#L0-L72)

## Kubernetes ä¸ Docker Swarm é›†æˆå»ºè®®
### Kubernetes éƒ¨ç½²å»ºè®®
1. **Deployment é…ç½®**ï¼šè®¾ç½®åˆç†çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶
2. **Service é…ç½®**ï¼šä½¿ç”¨ ClusterIP æˆ– LoadBalancer ç±»å‹
3. **Ingress é…ç½®**ï¼šé…ç½®è·¯å¾„è·¯ç”±å’Œ TLS ç»ˆæ­¢
4. **Liveness/Readiness Probe**ï¼šå¯¹æ¥ `/api/health` æ¥å£
5. **Horizontal Pod Autoscaler**ï¼šåŸºäº CPU/å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨æ‰©ç¼©å®¹

### Docker Swarm éƒ¨ç½²å»ºè®®
1. **Service éƒ¨ç½²**ï¼šä½¿ç”¨ `--mode replicated` å’Œ `--replicas` æ§åˆ¶å®ä¾‹æ•°
2. **Config/Secret ç®¡ç†**ï¼šä½¿ç”¨ Swarm çš„ config å’Œ secret åŠŸèƒ½
3. **Overlay ç½‘ç»œ**ï¼šé…ç½®è·¨ä¸»æœºé€šä¿¡ç½‘ç»œ
4. **æ»šåŠ¨æ›´æ–°**ï¼šé…ç½® `--update-delay` å’Œ `--update-parallelism`

```bash
# Docker Swarm éƒ¨ç½²ç¤ºä¾‹
docker service create \
  --name yunqi-web \
  --replicas 4 \
  --publish 3000:3000 \
  --env NODE_ENV=production \
  --config source=app-config,target=/app/.env \
  --secret source=db-password,target=/run/secrets/db-password \
  --update-delay 10s \
  --update-parallelism 1 \
  yunqi-platform:v1.2.0
```

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)
- [next.config.ts](file://next.config.ts#L1-L10)

## å®Œæ•´éƒ¨ç½²è„šæœ¬ç¤ºä¾‹
```bash
#!/bin/bash

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½² yunqi-platform..."

# 1. æ„å»ºé•œåƒ
echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
docker build -t yunqi-platform:$(git rev-parse --short HEAD) .

# 2. æ¨é€é•œåƒ
echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
docker tag yunqi-platform:$(git rev-parse --short HEAD) registry.yunqi.com/yunqi-platform:$(git rev-parse --short HEAD)
docker push registry.yunqi.com/yunqi-platform:$(git rev-parse --short HEAD)

# 3. éƒ¨ç½²åˆ° Kubernetes
echo "â˜¸ï¸ éƒ¨ç½²åˆ° Kubernetes..."
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yunqi-platform
spec:
  replicas: 4
  selector:
    matchLabels:
      app: yunqi-platform
  template:
    metadata:
      labels:
        app: yunqi-platform
    spec:
      containers:
      - name: web
        image: registry.yunqi.com/yunqi-platform:$(git rev-parse --short HEAD)
        ports:
        - containerPort: 3000
        envFrom:
        - configMapRef:
            name: yunqi-config
        - secretRef:
            name: yunqi-secrets
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "3Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 10
EOF

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

**Section sources**
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L0-L66)
- [ecosystem.config.js](file://ecosystem.config.js#L0-L48)

## CI/CD é›†æˆæ€è·¯
### CI/CD æµç¨‹è®¾è®¡
```mermaid
flowchart LR
Commit["ä»£ç æäº¤"] --> CI["CI æµæ°´çº¿"]
CI --> Test["è¿è¡Œå•å…ƒæµ‹è¯•"]
Test --> Build["æ„å»º Docker é•œåƒ"]
Build --> Scan["å®‰å…¨æ‰«æ"]
Scan --> Push["æ¨é€é•œåƒåˆ°ä»“åº“"]
Push --> CD["CD æµæ°´çº¿"]
CD --> Staging["éƒ¨ç½²åˆ°é¢„å‘ç¯å¢ƒ"]
Staging --> Manual["äººå·¥å®¡æ‰¹"]
Manual --> Production["éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"]
Production --> Verify["å¥åº·æ£€æŸ¥éªŒè¯"]
Verify --> Done["éƒ¨ç½²å®Œæˆ"]
```

### å…³é”®é›†æˆç‚¹
1. **GitHub Actions/GitLab CI**ï¼šè§¦å‘æ„å»ºå’Œæµ‹è¯•
2. **Trivy/Clair**ï¼šé•œåƒå®‰å…¨æ‰«æ
3. **Argo CD/Flux**ï¼šGitOps é£æ ¼çš„æŒç»­éƒ¨ç½²
4. **Prometheus/Grafana**ï¼šéƒ¨ç½²åæ€§èƒ½ç›‘æ§
5. **Slack/é’‰é’‰**ï¼šéƒ¨ç½²çŠ¶æ€é€šçŸ¥

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L96-L127)
- [package.json](file://package.json#L1-L20)
- [next.config.ts](file://next.config.ts#L1-L10)