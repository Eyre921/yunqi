# 数据库迁移与初始化

<cite>
**本文档引用的文件**   
- [seed.ts](file://prisma/seed.ts)
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)
- [verify-database.ts](file://verify-database.ts)
- [prisma.ts](file://src/lib/prisma.ts)
- [package.json](file://package.json)
</cite>

## 目录
1. [引言](#引言)
2. [数据库迁移机制](#数据库迁移机制)
3. [迁移部署流程](#迁移部署流程)
4. [数据初始化](#数据初始化)
5. [数据库验证](#数据库验证)
6. [CI/CD集成建议](#cicd集成建议)
7. [最佳实践](#最佳实践)

## 引言
本文档详细说明了如何在生产环境中安全执行 Prisma 数据库迁移，包括迁移脚本的版本控制、数据种子的执行方法以及数据库连接测试脚本的使用。文档还提供了在 CI/CD 流程中集成迁移验证的建议，以防止部署时出现 schema 不一致问题。

## 数据库迁移机制

Prisma 迁移系统通过 `prisma/migrations` 目录下的 SQL 脚本实现数据库 schema 的版本控制。每个迁移脚本都有一个时间戳前缀，确保迁移按正确顺序执行。

```mermaid
flowchart TD
A[prisma/migrations] --> B[20250831084947_add_featured_field]
A --> C[20250905143157_add_online_counter_config]
A --> D[20250905150839_add_platform_config]
A --> E[20250917050212_add_missing_fields]
B --> F[migration.sql]
C --> G[migration.sql]
D --> H[migration.sql]
E --> I[migration.sql]
```

**图示来源**
- [20250831084947_add_featured_field/migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
- [20250905143157_add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [20250905150839_add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [20250917050212_add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)

**本节来源**
- [prisma/migrations](file://prisma/migrations)

## 迁移部署流程

使用 `prisma migrate deploy` 命令在生产环境中应用数据库迁移。该命令会按时间戳顺序执行所有未应用的迁移脚本。

```mermaid
sequenceDiagram
participant CLI as Prisma CLI
participant Migration as 迁移系统
participant Database as 数据库
CLI->>Migration : prisma migrate deploy
Migration->>Database : 检查已应用的迁移
Database-->>Migration : 返回已应用的迁移列表
Migration->>Migration : 计算需要应用的迁移
loop 每个未应用的迁移
Migration->>Database : 执行迁移脚本
Database-->>Migration : 返回执行结果
end
Migration-->>CLI : 迁移完成
```

**图示来源**
- [package.json](file://package.json#L10-L15)

**本节来源**
- [package.json](file://package.json#L10-L15)

## 数据初始化

数据种子脚本 `prisma/seed.ts` 用于初始化基础数据，包括管理员角色和默认配置。

```mermaid
flowchart TD
Start([开始]) --> CreateUsers["创建用户账号"]
CreateUsers --> CreateAdmin["创建管理员用户"]
CreateAdmin --> CreateRegular["创建普通用户"]
CreateRegular --> CreateWorks["创建作品数据"]
CreateWorks --> CreateDetailed["创建详细作品"]
CreateDetailed --> CreateBatch["批量创建作品"]
CreateBatch --> Statistics["统计信息"]
Statistics --> End([完成])
```

**图示来源**
- [seed.ts](file://prisma/seed.ts#L15-L300)

**本节来源**
- [seed.ts](file://prisma/seed.ts#L1-L318)

## 数据库验证

`verify-database.ts` 脚本用于测试数据库连接并验证数据完整性。

```mermaid
sequenceDiagram
participant Script as 验证脚本
participant Database as 数据库
participant Console as 控制台
Script->>Database : 测试数据库连接
Database-->>Script : 连接成功
Script->>Console : 显示连接成功
Script->>Database : 查询用户总数
Database-->>Script : 返回用户数
Script->>Console : 显示用户统计
Script->>Database : 查询管理员用户
Database-->>Script : 返回管理员列表
Script->>Console : 显示管理员信息
Script->>Database : 查询作品统计
Database-->>Script : 返回作品统计
Script->>Console : 显示作品统计
Script->>Console : 显示验证完成
```

**图示来源**
- [verify-database.ts](file://verify-database.ts#L5-L125)

**本节来源**
- [verify-database.ts](file://verify-database.ts#L1-L125)

## CI/CD集成建议

在 CI/CD 流程中集成迁移验证，确保部署时 schema 一致性。

```mermaid
flowchart LR
A[代码提交] --> B[运行单元测试]
B --> C[执行数据库验证]
C --> D{验证通过?}
D --> |是| E[构建镜像]
D --> |否| F[停止部署]
E --> G[部署到预发布环境]
G --> H[运行集成测试]
H --> I{测试通过?}
I --> |是| J[部署到生产环境]
I --> |否| K[回滚]
```

**图示来源**
- [package.json](file://package.json#L10-L15)
- [verify-database.ts](file://verify-database.ts#L1-L125)

**本节来源**
- [package.json](file://package.json#L10-L15)
- [verify-database.ts](file://verify-database.ts#L1-L125)

## 最佳实践

### 生产环境迁移
- 在部署前先在预发布环境测试迁移
- 备份数据库后再执行迁移
- 监控迁移过程中的错误

### 数据种子管理
- 种子数据应包含所有必需的基础数据
- 避免在种子数据中包含敏感信息
- 定期更新种子数据以反映最新需求

### 数据库验证
- 在每次部署后自动运行验证脚本
- 将验证结果集成到监控系统
- 设置验证失败的告警机制

**本节来源**
- [seed.ts](file://prisma/seed.ts#L1-L318)
- [verify-database.ts](file://verify-database.ts#L1-L125)
- [prisma.ts](file://src/lib/prisma.ts#L1-L50)