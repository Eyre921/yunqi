# 服务器配置与反向代理

<cite>
**本文档引用文件**  
- [ecosystem.config.js](file://ecosystem.config.js)
- [middleware.ts](file://middleware.ts)
- [next.config.ts](file://next.config.ts)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [PM2 进程管理配置](#pm2-进程管理配置)
3. [Next.js 中间件安全策略](#nextjs-中间件安全策略)
4. [Next.js 应用性能与安全头配置](#nextjs-应用性能与安全头配置)
5. [Nginx 反向代理配置示例](#nginx-反向代理配置示例)
6. [Caddy 反向代理配置示例](#caddy-反向代理配置示例)
7. [部署与维护建议](#部署与维护建议)

## 简介
本文档详细说明如何部署基于 Next.js 构建的“数字化作品互动展示平台”，并配置反向代理服务器（Nginx 或 Caddy）以提升性能、安全性和可用性。文档涵盖使用 PM2 管理 Node.js 服务进程、通过 `middleware.ts` 实现路由级安全控制，以及在应用层和代理层配置 HTTPS、缓存、压缩和跨域策略。

## PM2 进程管理配置

`ecosystem.config.js` 文件定义了使用 PM2 管理 Next.js 应用的生产与开发环境配置。

- **启动模式**：生产环境 (`yunqi-platform`) 使用 `cluster` 模式，通过 `instances: 4` 启动 4 个进程实例，充分利用多核 CPU 实现负载均衡。开发环境 (`yunqi-platform-dev`) 使用 `fork` 模式，仅启动单个实例。
- **自动重启与监控**：`autorestart: true` 和 `max_restarts: 10` 确保应用在崩溃后自动重启，`max_memory_restart: '3G'` 在内存超限时重启进程，防止内存泄漏。`pmx: true` 和 `monitoring: true` 启用 PM2 内置监控。
- **日志轮转**：配置了独立的 `out_file` 和 `error_file`，并设置 `merge_logs: true` 将所有实例日志合并，便于集中查看。
- **环境管理**：通过 `env_production` 和 `env_development` 分别定义生产与开发环境变量，如 `NODE_ENV` 和 `PORT`。
- **部署脚本**：`deploy.production` 中的 `post-deploy` 命令自动化了安装依赖、构建应用和重载 PM2 的流程。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L127)

## Next.js 中间件安全策略

`middleware.ts` 文件实现了基于 NextAuth.js 的全局路由控制和安全策略。

- **路由匹配**：`config.matcher` 指定中间件应用于 `/admin`、`/upload`、`/auth` 和 `/profile` 路径下的所有子路由。
- **认证与重定向**：
  - 已登录用户访问 `/auth` 页面时，根据其角色 (`token?.role`) 重定向至 `/admin` 或 `/`。
  - 非管理员用户访问 `/admin` 页面时，重定向至首页。
  - 未登录用户访问 `/profile` 个人中心时，重定向至登录页。
- **权限控制**：通过检查 JWT `token` 的存在性和角色，实现了细粒度的访问控制，确保了管理员后台和用户个人中心的安全性。
- **游客上传**：代码中注释掉的逻辑表明，上传页面 (`/upload`) 设计为允许游客访问，无需强制登录。

此中间件在生产环境中通过 Next.js 的中间件机制自动生效，无需额外配置。

**Section sources**
- [middleware.ts](file://middleware.ts#L1-L51)

## Next.js 应用性能与安全头配置

`next.config.ts` 文件中的 `headers()` 函数为不同类型的资源设置了 HTTP 响应头，优化性能并增强安全性。

- **跨域资源共享 (CORS)**：为 `/api/:path*` 路由设置 `Access-Control-Allow-Origin` 为 `https://yunqi.nfeyre.top`，允许特定域名的前端应用调用 API，同时指定允许的方法和头部。
- **静态资源缓存**：
  - `/_next/static/:path*`：设置 `Cache-Control: public, max-age=31536000, immutable`，实现一年的强缓存，适用于哈希化的 JS/CSS 文件。
  - `/images/:path*`：设置 `Cache-Control: public, max-age=86400, s-maxage=86400`，对图片进行 24 小时缓存。
  - 其他页面：设置 `stale-while-revalidate` 策略，允许在后台更新缓存的同时返回旧内容，提升用户体验。
- **Gzip 压缩**：`compress: true` 启用 Gzip 压缩，减小传输体积。
- **安全头**：
  - `X-Frame-Options: DENY` 防止点击劫持。
  - `X-Content-Type-Options: nosniff` 阻止 MIME 类型嗅探。
  - `Strict-Transport-Security` 强制使用 HTTPS。
  - `contentSecurityPolicy` 在图片配置中限制脚本执行。

**Section sources**
- [next.config.ts](file://next.config.ts#L45-L102)

## Nginx 反向代理配置示例

以下是一个针对该 Next.js 应用的 Nginx 配置示例，部署在 `yunqi.nfeyre.top` 域名下。

```nginx
server {
    listen 80;
    server_name yunqi.nfeyre.top;
    # 重定向HTTP到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yunqi.nfeyre.top;

    # SSL证书配置
    ssl_certificate /path/to/fullchain.pem;
    ssl_certificate_key /path/to/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        # 启用Brotli压缩（如果已安装）
        # brotli on;
        # brotli_types text/plain text/css application/json application/javascript text/xml application/xml;
    }

    # 图片缓存
    location /images/ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # API请求处理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # CORS头（如果Next.js未设置，可在此处补充）
        add_header Access-Control-Allow-Origin "https://yunqi.nfeyre.top" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # 请求限流（例如，限制每个IP每秒10个请求）
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 应用限流
        limit_req zone=api burst=20 nodelay;
    }
}
```

## Caddy 反向代理配置示例

Caddy 配置更为简洁，可自动处理 HTTPS 证书。

```caddy
yunqi.nfeyre.top {
    # 自动获取和续订HTTPS证书
    tls your-email@example.com

    # 反向代理到Next.js应用
    reverse_proxy localhost:3000 {
        # 传递真实IP
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # 静态资源缓存
    @static {
        path /_next/static/* /_next/image/*
    }
    handle @static {
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
        header X-Content-Type-Options "nosniff"
    }

    # 图片缓存
    @images path /images/*
    handle @images {
        file_server
        header Cache-Control "public, max-age=2592000"
    }

    # Gzip压缩（Caddy默认启用）
    encode zstd gzip

    # CORS头
    @api path /api/*
    handle @api {
        header Access-Control-Allow-Origin "https://yunqi.nfeyre.top"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        # 处理预检请求
        @options method OPTIONS
        handle @options {
            header Access-Control-Max-Age 86400
            respond "" 204
        }
        # 继续代理
        reverse_proxy localhost:3000
    }

    # 请求限流
    @all {
        not path /_next/static/* /_next/image/* /images/*
    }
    ratelimit @all {
        zone: 10m
        burst: 20
        period: 1s
        key: {remote_host}
        penalty: 1
    }
}
```

## 部署与维护建议

1. **PM2 启动**：在服务器上安装 PM2 (`npm install -g pm2`)，然后使用 `pm2 start ecosystem.config.js --env production` 启动应用。
2. **开机自启**：运行 `pm2 startup` 和 `pm2 save` 以配置 PM2 开机自启。
3. **日志监控**：使用 `pm2 logs yunqi-platform` 查看实时日志，`pm2 monit` 进入监控界面。
4. **证书管理**：若使用 Nginx，推荐使用 Let's Encrypt 的 Certbot 工具自动获取和续订 SSL 证书。Caddy 则自动完成此过程。
5. **健康检查**：利用 `next.config.ts` 中配置的 `/api/health` 路由作为 Nginx/Caddy 的健康检查端点。
6. **安全更新**：定期更新 Node.js、Next.js、PM2 和 Nginx/Caddy 到最新稳定版本，以修复安全漏洞。