# 环境变量与密钥管理

<cite>
**本文档引用的文件**  
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [src/lib/oss.ts](file://src/lib/oss.ts)
- [src/lib/auth.ts](file://src/lib/auth.ts)
- [ecosystem.config.js](file://ecosystem.config.js)
- [next.config.ts](file://next.config.ts)
</cite>

## 目录
1. [引言](#引言)
2. [环境变量分类与用途](#环境变量分类与用途)
3. [必需环境变量清单](#必需环境变量清单)
4. [环境变量注入方式](#环境变量注入方式)
5. [Docker 与 PM2 中的安全传递](#docker-与-pm2-中的安全传递)
6. [敏感信息加密存储建议](#敏感信息加密存储建议)
7. [禁止行为与最佳实践](#禁止行为与最佳实践)

## 引言

本规范旨在为“数字化作品互动展示平台”建立统一的环境变量与敏感信息管理机制，确保开发、测试和生产环境的配置安全隔离。通过明确环境变量的定义、注入方式和密钥管理策略，防止敏感信息泄露，提升系统安全性与可维护性。

## 环境变量分类与用途

根据部署环境的不同，环境变量分为以下三类：

- **开发环境**：用于本地开发，配置如 `NODE_ENV=development` 和 `PORT=3001`，允许热重载和详细日志输出。
- **测试环境**：用于集成测试，配置接近生产环境但使用独立数据库，便于验证功能。
- **生产环境**：用于线上部署，配置如 `NODE_ENV=production` 和 `PORT=3000`，启用性能优化和安全策略。

不同环境通过 `ecosystem.config.js` 中的 `env`、`env_development` 和 `env_production` 配置项进行区分，确保配置隔离。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)

## 必需环境变量清单

以下是系统运行所必需的环境变量，必须在各环境中正确配置。

### 数据库连接
- **DATABASE_URL**：数据库连接字符串，格式为 `sqlite://./prisma/dev.db` 或 `postgresql://user:password@host:port/dbname`。该变量用于 Prisma ORM 初始化数据库连接。

### 认证与安全
- **NEXTAUTH_SECRET**：NextAuth.js 用于签名 JWT 令牌的密钥，必须为高强度随机字符串。
- **ALI_OSS_ACCESS_KEY_ID**：阿里云 OSS 访问密钥 ID，用于身份验证。
- **ALI_OSS_ACCESS_KEY_SECRET**：阿里云 OSS 访问密钥，必须严格保密。
- **ALI_OSS_REGION**：OSS 存储区域，如 `oss-cn-hangzhou`。
- **ALI_OSS_BUCKET**：OSS 存储桶名称。
- **ALI_OSS_ENDPOINT**：OSS 自定义访问域名（可选）。

### 平台配置
- **PORT**：应用监听端口，默认为 3000。
- **NODE_ENV**：运行环境，取值为 `development`、`test` 或 `production`。
- **UV_THREADPOOL_SIZE**：Node.js 线程池大小，用于优化 I/O 性能。
- **NODE_OPTIONS**：Node.js 启动参数，如 `--max-old-space-size=3072` 用于限制内存使用。

**Section sources**
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L164)
- [src/lib/prisma.ts](file://src/lib/prisma.ts#L1-L51)
- [src/lib/oss.ts](file://src/lib/oss.ts#L1-L303)
- [src/lib/auth.ts](file://src/lib/auth.ts#L1-L72)

## 环境变量注入方式

### 使用 .env.local 文件
在开发环境中，推荐使用 `.env.local` 文件存储环境变量。该文件应被 `.gitignore` 忽略，防止密钥提交至代码仓库。Next.js 会自动加载该文件中的变量。

### CI/CD 环境变量注入
在 CI/CD 流程中（如 GitHub Actions、GitLab CI），应通过平台提供的环境变量功能注入敏感信息。例如，在 `ecosystem.config.js` 的部署脚本中：
```bash
post-deploy: 'npm install && npm run build && pm2 reload ecosystem.config.js --env production'
```
此时，所有环境变量应预先在 CI/CD 系统中配置，避免硬编码。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)
- [next.config.ts](file://next.config.ts#L1-L103)

## Docker 与 PM2 中的安全传递

### Docker
在 Docker 部署时，应使用 `--env-file` 参数加载环境变量文件，或通过 `docker-compose.yml` 的 `environment` 字段注入：
```yaml
environment:
  - DATABASE_URL=${DATABASE_URL}
  - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
```
确保 `.env` 文件不包含在镜像中，仅在运行时挂载。

### PM2
PM2 支持通过 `ecosystem.config.js` 配置环境变量。生产环境配置如下：
```js
env_production: {
  NODE_ENV: 'production',
  PORT: 3000,
  UV_THREADPOOL_SIZE: 16,
  NODE_OPTIONS: '--max-old-space-size=3072'
}
```
启动命令为 `pm2 start ecosystem.config.js --env production`，确保变量在进程启动时注入。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)

## 敏感信息加密存储建议

对于生产环境的敏感信息（如数据库密码、OSS 密钥），建议使用云服务商的密钥管理服务（KMS）进行加密存储。例如，阿里云 KMS 可用于加密 `ALI_OSS_ACCESS_KEY_SECRET`，在应用启动时通过 API 动态解密。避免将明文密钥存储在配置文件或环境变量中，降低泄露风险。

## 禁止行为与最佳实践

- **禁止在代码中硬编码密钥**：所有敏感信息必须通过环境变量注入，严禁在源码中出现明文密钥。
- **禁止提交 .env 文件至版本控制**：确保 `.env`、`.env.local` 等文件在 `.gitignore` 中被忽略。
- **最小权限原则**：数据库账号和 OSS 密钥应遵循最小权限原则，仅授予必要权限。
- **定期轮换密钥**：定期更新 `NEXTAUTH_SECRET` 和 OSS 密钥，减少长期暴露风险。

**Section sources**
- [src/lib/oss.ts](file://src/lib/oss.ts#L1-L303)
- [src/lib/auth.ts](file://src/lib/auth.ts#L1-L72)
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L164)