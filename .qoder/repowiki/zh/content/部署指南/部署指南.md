# 部署指南

<cite>
**本文档引用文件**  
- [package.json](file://package.json)
- [ecosystem.config.js](file://ecosystem.config.js)
- [next.config.ts](file://next.config.ts)
- [prisma/migrations/20250917050212_add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql)
- [src/lib/oss.ts](file://src/lib/oss.ts)
- [src/lib/db-utils.ts](file://src/lib/db-utils.ts)
- [.env.example](file://.env.example)
- [README.md](file://README.md)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh)
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [构建与静态资源生成](#构建与静态资源生成)
4. [PM2进程管理](#pm2进程管理)
5. [Nginx反向代理配置](#nginx反向代理配置)
6. [环境变量与配置管理](#环境变量与配置管理)
7. [数据库迁移自动化](#数据库迁移自动化)
8. [日志收集与监控告警](#日志收集与监控告警)
9. [高可用部署拓扑](#高可用部署拓扑)
10. [性能调优建议](#性能调优建议)
11. [容器化与PaaS部署](#容器化与paas部署)

## 简介
本部署指南详细说明了数字化作品互动展示平台从构建到上线的全流程。涵盖使用`next build`生成静态资源、通过PM2管理Node.js进程、配置Nginx反向代理与静态文件服务等核心部署环节。同时提供环境变量管理、数据库迁移自动化、日志收集与监控告警的配置要点，并包含性能调优建议与高可用部署拓扑。

## 项目结构
项目采用Next.js 15 App Router架构，主要目录结构如下：
```
yunqi/
├── src/
│   ├── app/                 # Next.js 13+ App Router
│   │   ├── api/             # API 路由
│   │   ├── admin/           # 管理员页面
│   │   ├── auth/            # 认证页面
│   │   └── ...
│   ├── components/          # React 组件
│   ├── lib/                 # 工具库
│   └── types/               # TypeScript 类型定义
├── prisma/                  # 数据库相关
├── public/                  # 静态资源
└── ...
```

**Section sources**
- [README.md](file://README.md#L100-L150)

## 构建与静态资源生成
使用Next.js内置的构建命令生成生产环境静态资源。

### 构建命令
```bash
npm run build
```

### 构建优化配置
- 启用增量静态再生(ISR)，内存缓存50MB
- 生产环境移除console.log（保留error和warn）
- 图片格式支持WebP和AVIF
- 静态资源设置一年缓存，内容不可变

```mermaid
flowchart TD
A["执行 npm run build"] --> B["编译TypeScript"]
B --> C["优化打包"]
C --> D["生成静态资源"]
D --> E["输出到 .next 目录"]
E --> F["准备生产环境部署"]
```

**Diagram sources**
- [next.config.ts](file://next.config.ts#L1-L50)
- [package.json](file://package.json#L6-L8)

## PM2进程管理
使用PM2进行Node.js应用的进程管理，确保应用高可用。

### PM2配置要点
- 集群模式运行6个实例（8核服务器）
- 每个实例最大内存2GB
- 自动重启机制
- JSON格式日志输出
- 性能监控集成

### 常用PM2命令
```bash
# 启动生产环境
pm2 start ecosystem.config.js --env production

# 查看进程状态
pm2 status

# 查看实时日志
pm2 logs yunqi-platform --lines 100

# 重启应用
pm2 restart yunqi-platform

# 设置开机自启
pm2 save
pm2 startup
```

```mermaid
classDiagram
class PM2Config {
+string name
+string script
+string args
+number instances
+string exec_mode
+boolean autorestart
+string max_memory_restart
+object env
+object env_production
+object env_development
+string log_file
+string out_file
+string error_file
}
PM2Config --> "1" Environment : "包含"
Environment <|-- Production : "继承"
Environment <|-- Development : "继承"
```

**Diagram sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)

## Nginx反向代理配置
Nginx作为反向代理服务器，处理静态资源请求并转发API请求到Node.js应用。

### Nginx优化配置
- worker_processes设置为8（CPU核心数）
- 启用Gzip压缩，压缩级别6
- 静态资源缓存1年
- 图片文件缓存30天
- 连接超时30秒

### 代理配置示例
```nginx
upstream nextjs_backend {
    least_conn;
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location /_next/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    
    location / {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
```

```mermaid
graph TB
Client[客户端] --> Nginx[Nginx服务器]
Nginx --> Static[静态资源]
Nginx --> NextJS[Next.js应用]
NextJS --> DB[(数据库)]
subgraph "服务器"
Nginx
NextJS
DB
end
style Nginx fill:#f9f,stroke:#333
style NextJS fill:#bbf,stroke:#333
```

**Diagram sources**
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L139-L216)

## 环境变量与配置管理
通过环境变量实现不同环境的配置管理。

### 环境变量文件
- `.env.local` - 本地开发环境
- `.env.production` - 生产环境
- `.env.example` - 环境变量模板

### 核心环境变量
```env
# 数据库配置
DATABASE_URL="postgresql://username:password@localhost:5432/database_name"

# NextAuth 认证配置
NEXTAUTH_SECRET="your-nextauth-secret-key-here"
NEXTAUTH_URL="http://localhost:3000"

# 阿里云OSS配置
ALI_OSS_REGION="oss-cn-hangzhou"
ALI_OSS_ACCESS_KEY_ID="your-access-key-id"
ALI_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
ALI_OSS_BUCKET="your-bucket-name"
```

### 前端可访问的环境变量
以`NEXT_PUBLIC_`为前缀的环境变量可在前端访问：
```env
NEXT_PUBLIC_ALI_OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"
NEXT_PUBLIC_ALI_OSS_BUCKET="your-bucket-name"
```

**Section sources**
- [.env.example](file://.env.example#L1-L30)

## 数据库迁移自动化
使用Prisma进行数据库迁移管理，确保数据库结构与代码同步。

### 迁移流程
1. 修改Prisma Schema
2. 生成迁移文件
3. 应用迁移到数据库
4. 验证迁移结果

### 迁移命令
```bash
# 生成并应用迁移
npx prisma migrate dev --name migration-name

# 生成生产环境迁移
npx prisma migrate deploy

# 查看迁移状态
npx prisma migrate status

# 重置数据库（开发环境）
npx prisma migrate reset
```

### 示例迁移
```sql
-- AlterTable
ALTER TABLE "works" ADD COLUMN     "fileSize" BIGINT,
ADD COLUMN     "imagePath" TEXT,
ADD COLUMN     "mimeType" TEXT,
ADD COLUMN     "ossKey" TEXT,
ADD COLUMN     "ossUrl" TEXT,
ADD COLUMN     "tags" TEXT[] DEFAULT ARRAY[]::TEXT[];
```

```mermaid
sequenceDiagram
Developer->>Prisma : 修改 schema.prisma
Prisma->>Prisma : 生成迁移SQL
Prisma->>Database : 应用迁移
Database-->>Prisma : 返回结果
Prisma-->>Developer : 显示迁移状态
```

**Diagram sources**
- [prisma/migrations/20250917050212_add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql#L1-L8)

**Section sources**
- [prisma/migrations/20250917050212_add_missing_fields/migration.sql](file://prisma/migrations/20250917050212_add_missing_fields/migration.sql#L1-L8)

## 日志收集与监控告警
建立完整的日志收集与监控体系，确保系统稳定运行。

### 日志配置
- PM2日志：JSON格式，合并输出
- 应用日志：控制台输出，按级别过滤
- 错误日志：单独文件记录

### 监控指标
- CPU使用率
- 内存使用情况
- 磁盘空间
- 网络连接数
- 系统负载
- PM2进程状态
- 数据库连接数

### 健康检查API
```typescript
export async function GET(request: NextRequest) {
  try {
    await prisma.$queryRaw`SELECT 1`;
    
    return NextResponse.json({
      success: true,
      message: 'API服务正常',
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    return NextResponse.json({
      success: false,
      message: 'API服务异常',
      timestamp: new Date().toISOString(),
      database: 'disconnected'
    }, { status: 500 });
  }
}
```

```mermaid
flowchart TD
A[系统监控] --> B[CPU使用率]
A --> C[内存使用]
A --> D[磁盘空间]
A --> E[网络连接]
A --> F[PM2状态]
A --> G[数据库连接]
H[告警系统] --> I[阈值检测]
I --> J[邮件通知]
I --> K[短信通知]
I --> L[企业微信]
A --> H
```

**Section sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L1-L25)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L250-L332)

## 高可用部署拓扑
设计高可用的部署架构，确保系统稳定可靠。

### 部署架构
```mermaid
graph TB
subgraph "用户层"
User[用户]
end
subgraph "接入层"
DNS[DNS解析]
CDN[CDN加速]
LB[负载均衡]
end
subgraph "应用层"
Nginx1[Nginx实例1]
Nginx2[Nginx实例2]
Nginx3[Nginx实例3]
end
subgraph "服务层"
Node1[Node.js实例1]
Node2[Node.js实例2]
Node3[Node.js实例3]
Node4[Node.js实例4]
Node5[Node.js实例5]
Node6[Node.js实例6]
end
subgraph "数据层"
DB[(PostgreSQL)]
OSS[(OSS对象存储)]
end
User --> DNS
DNS --> CDN
CDN --> LB
LB --> Nginx1
LB --> Nginx2
LB --> Nginx3
Nginx1 --> Node1
Nginx1 --> Node2
Nginx2 --> Node3
Nginx2 --> Node4
Nginx3 --> Node5
Nginx3 --> Node6
Node1 --> DB
Node2 --> DB
Node3 --> DB
Node4 --> DB
Node5 --> DB
Node6 --> DB
Node1 --> OSS
Node2 --> OSS
Node3 --> OSS
Node4 --> OSS
Node5 --> OSS
Node6 --> OSS
style DB fill:#f96,stroke:#333
style OSS fill:#69f,stroke:#333
```

### 高可用特性
- 多实例部署，避免单点故障
- 负载均衡，分发请求压力
- 数据库主从复制，数据冗余
- 对象存储持久化，防止数据丢失
- CDN加速，提升访问速度
- 健康检查，自动剔除异常实例

**Diagram sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L139-L216)

## 性能调优建议
针对系统性能进行全方位优化，提升用户体验。

### 数据库优化
- 连接池配置：20个连接
- shared_buffers：4GB（内存25%）
- effective_cache_size：12GB（内存75%）
- work_mem：64MB（每查询操作）

### 缓存策略
- 静态资源：1年缓存，immutable
- API响应：1小时缓存，支持stale-while-revalidate
- 图片文件：30天缓存
- ISR缓存：50MB内存缓存

### CDN集成
- 静态资源托管到CDN
- 图片文件CDN加速
- 全球节点分发
- 智能路由选择

### 代码优化
- 移除生产环境console.log
- 优化打包，减少bundle大小
- 启用并发特性
- 图片格式优化（WebP/AVIF）

```mermaid
flowchart LR
A[性能调优] --> B[数据库优化]
A --> C[缓存策略]
A --> D[CDN集成]
A --> E[代码优化]
B --> B1[连接池]
B --> B2[内存配置]
B --> B3[查询优化]
C --> C1[静态资源]
C --> C2[API响应]
C --> C3[图片文件]
D --> D1[静态资源]
D --> D2[图片加速]
D --> D3[全球分发]
E --> E1[移除console]
E --> E2[优化打包]
E --> E3[图片格式]
```

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L102)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L200-L250)

## 容器化与PaaS部署
提供容器化部署方案及PaaS平台部署指引。

### Docker容器化
虽然项目未提供Dockerfile，但可基于以下配置创建：
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

### PaaS平台部署
#### Vercel部署
1. 连接GitHub仓库
2. 配置环境变量
3. 设置构建命令：`npm run build`
4. 设置输出目录：`.next`
5. 部署应用

#### 阿里云部署
1. 使用ECS实例部署
2. 配置Nginx反向代理
3. 使用RDS托管PostgreSQL
4. 使用OSS存储静态资源
5. 配置SLB负载均衡

### 部署脚本
```bash
#!/bin/bash
# 服务器性能优化脚本
# 包含系统内核参数优化、文件描述符限制、PostgreSQL优化等
```

**Section sources**
- [package.json](file://package.json#L1-L61)
- [ecosystem.config.js](file://ecosystem.config.js#L1-L128)
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L1-L332)