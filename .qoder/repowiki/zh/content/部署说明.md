# 部署说明

<cite>
**本文档中引用的文件**  
- [next.config.ts](file://next.config.ts) - *生产环境优化配置*
- [ecosystem.config.js](file://ecosystem.config.js) - *PM2进程管理配置（已更新）*
- [package.json](file://package.json) - *项目依赖与脚本定义*
- [README.md](file://README.md) - *基础部署说明*
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts) - *健康检查接口实现*
- [prisma/schema.prisma](file://prisma/schema.prisma) - *数据库模式定义*
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh) - *服务器性能优化脚本（新增）*
</cite>

## 更新摘要
**变更内容**  
- 更新 **PM2 配置说明** 以反映 `ecosystem.config.js` 的最新优化（内存、线程池、日志等）
- 新增 **服务器性能优化脚本** (`optimize-server.sh`) 的使用说明
- 增强 **PM2 启动命令** 的详细指导，包括系统级优化建议
- 更新 **进程管理配置** 的具体参数（最小运行时间、重启次数、优先级等）
- 新增 **高级配置建议** 和 **故障排查** 指南

## 目录
1. [环境准备](#环境准备)
2. [代码部署与依赖安装](#代码部署与依赖安装)
3. [环境变量配置](#环境变量配置)
4. [数据库迁移](#数据库迁移)
5. [构建应用](#构建应用)
6. [启动服务](#启动服务)
7. [反向代理与SSL配置](#反向代理与ssl配置)
8. [健康检查与监控](#健康检查与监控)

## 环境准备

在部署前，请确保生产服务器已正确配置以下环境：

### 服务器要求
- 操作系统：Linux（推荐 Ubuntu 20.04 LTS 或更高版本）
- CPU：至少 2 核
- 内存：至少 4GB（建议 8GB）
- 磁盘空间：至少 20GB

### PostgreSQL 数据库
安装 PostgreSQL 12 或更高版本：
```bash
# Ubuntu 示例
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

创建数据库和用户：
```sql
CREATE DATABASE yunqi;
CREATE USER yunqi_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE yunqi TO yunqi_user;
```

### Redis（可选）
如需使用 Redis 作为缓存，请安装 Redis 6.0 或更高版本：
```bash
sudo apt install redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

**Section sources**
- [README.md](file://README.md#L25-L35)

## 代码部署与依赖安装

### 获取代码
将代码部署到服务器：
```bash
# 克隆代码库
git clone https://github.com/your-repo/yunqi.git
cd yunqi

# 或使用已有代码，拉取最新版本
git pull origin main
```

### 安装依赖
安装 Node.js 18 或更高版本后，安装项目依赖：
```bash
npm install
```

**Section sources**
- [package.json](file://package.json#L1-L62)

## 环境变量配置

根据 `.env.example` 文件创建生产环境变量文件：

```bash
cp .env.example .env.local
```

配置以下关键环境变量：

```env
# 数据库连接
DATABASE_URL="postgresql://yunqi_user:your_secure_password@localhost:5432/yunqi"

# NextAuth 配置
NEXTAUTH_SECRET="生成一个安全的随机字符串"
NEXTAUTH_URL="https://your-domain.com"

# 生产环境配置
NODE_ENV=production
PORT=3000

# 文件上传配置
UPLOAD_DIR="./public/uploads"
MAX_FILE_SIZE=10485760 # 10MB

# 阿里云OSS配置（如使用）
ALI_OSS_REGION="oss-cn-hangzhou"
ALI_OSS_ACCESS_KEY_ID="your-access-key-id"
ALI_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
ALI_OSS_BUCKET="your-bucket-name"
ALI_OSS_ENDPOINT="https://your-bucket.oss-cn-hangzhou.aliyuncs.com"

# 管理员默认密码
ADMIN_DEFAULT_PASSWORD="admin123456"
```

**Section sources**
- [README.md](file://README.md#L55-L85)

## 数据库迁移

执行数据库迁移以同步模式变更：

```bash
# 执行生产环境迁移
npx prisma migrate deploy

# 生成 Prisma 客户端
npx prisma generate

# （可选）填充种子数据
npx prisma db seed
```

验证数据库连接：
```bash
node verify-database.ts
```

**Section sources**
- [package.json](file://package.json#L15-L18)
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L200)

## 构建应用

使用 `npm run build` 命令构建生产版本应用：

```bash
npm run build
```

### next.config.ts 生产优化配置

`next.config.ts` 文件中包含以下生产环境优化配置：

- **图片优化**：支持 WebP 和 AVIF 格式，配置了多种设备尺寸
- **外部包处理**：`serverExternalPackages` 配置确保 `bcryptjs` 和 `ali-oss` 正确打包
- **HTTP 头部安全配置**：
  - 为静态资源设置长期缓存（1年）
  - 启用 HSTS 安全策略
  - 配置 CORS 策略
- **TypeScript 和 ESLint**：构建时严格检查类型和代码规范

```mermaid
flowchart TD
A["构建开始"] --> B["编译 TypeScript"]
B --> C["优化图片资源"]
C --> D["处理外部依赖包"]
D --> E["生成静态资源"]
E --> F["应用HTTP头部安全策略"]
F --> G["构建完成"]
```

**Diagram sources**
- [next.config.ts](file://next.config.ts#L2-L66)

**Section sources**
- [next.config.ts](file://next.config.ts#L2-L66)
- [package.json](file://package.json#L10-L11)

## 启动服务

### 使用 PM2 进程管理器

#### ecosystem.config.js 配置说明

PM2 配置文件 `ecosystem.config.js` 包含以下关键配置，已针对 8 核 16GB 服务器进行深度优化：

- **进程名称**：`yunqi-platform` (生产环境), `yunqi-platform-dev` (开发环境)
- **启动脚本**：`npm start` (生产), `npm run dev` (开发)
- **实例数量**：`instances: 1`（单实例，高性能服务器建议通过 Nginx 负载均衡）
- **自动重启**：`autorestart: true`
- **内存限制**：超过 12GB 内存使用时自动重启 (`max_memory_restart: '12G'`)
- **Node.js 内存优化**：通过 `node_args` 设置 `--max-old-space-size=12288` (12GB)
- **环境变量**：配置生产环境变量，包括：
  - `UV_THREADPOOL_SIZE: 16` (针对 8 核 CPU 优化线程池)
  - `DATABASE_POOL_MIN: 5`, `DATABASE_POOL_MAX: 20` (数据库连接池优化)
- **日志配置**：
  - 综合日志：`./logs/combined.log`
  - 输出日志：`./logs/out.log`
  - 错误日志：`./logs/error.log`
  - 日志格式：JSON，带时间戳
- **进程管理**：
  - 最小正常运行时间：`30s` (防止频繁崩溃重启)
  - 最大重启次数：`15` 次
  - 重启延迟：`5000` 毫秒
  - 进程优先级：`nice: -10` (高优先级)
  - 文件描述符限制：`max_open_files: 65536`
- **性能监控**：`pmx: true` (启用 PM2 内置监控)

```mermaid
graph TD
A["PM2 进程管理"] --> B["启动应用"]
B --> C["监控进程状态"]
C --> D{"进程异常?"}
D --> |是| E["自动重启"]
D --> |否| F["持续监控"]
E --> G{"重启次数<15?"}
G --> |是| C
G --> |否| H["停止重启"]
F --> C
```

**Diagram sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L109)

#### PM2 操作命令

```bash
# 安装 PM2 及日志轮转插件
npm install -g pm2
npm install -g pm2-logrotate

# 系统级优化（建议在启动前执行）
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65535" >> /etc/sysctl.conf
sysctl -p

# 启动生产环境应用（推荐方式）
pm2 start ecosystem.config.js --only yunqi-platform --env production

# 设置日志轮转
pm2 set pm2-logrotate:max_size 100M
pm2 set pm2-logrotate:retain 30

# 查看进程状态
pm2 status
pm2 logs
pm2 monit

# 平滑重载（推荐）
pm2 reload yunqi-platform

# 重启应用
pm2 restart yunqi-platform

# 停止应用
pm2 stop yunqi-platform

# 设置开机自启
pm2 startup
pm2 save
```

### 使用 Docker 部署

#### Dockerfile 构建

创建 `Dockerfile`：
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

构建镜像：
```bash
docker build -t yunqi-platform .
```

运行容器：
```bash
docker run -d \
  -p 3000:3000 \
  -e DATABASE_URL="postgresql://..." \
  -e NEXTAUTH_SECRET="..." \
  --name yunqi-container \
  yunqi-platform
```

### 服务器性能优化脚本

新增 `scripts/optimize-server.sh` 脚本，用于一键执行应用层优化：

```bash
#!/bin/bash
# scripts/optimize-server.sh

# 检查并安装 PM2
pm2 --version || npm install -g pm2

# 设置 Node.js 环境变量
export NODE_ENV=production
export NODE_OPTIONS="--max-old-space-size=8192"

# 构建生产版本
npm run build

# 启动应用
pm2 start ecosystem.config.js --env production

# 设置开机自启（可选）
pm2 startup
pm2 save

# 显示状态
pm2 status
```

运行脚本：
```bash
chmod +x scripts/optimize-server.sh
./scripts/optimize-server.sh
```

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L257) - *已更新*
- [scripts/optimize-server.sh](file://scripts/optimize-server.sh#L1-L67) - *新增*
- [package.json](file://package.json#L5-L6)

## 反向代理与SSL配置

### Nginx 配置

配置 Nginx 作为反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # 反向代理到Next.js应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态资源缓存
    location /_next/static/ {
        alias /app/.next/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### SSL 证书获取

使用 Let's Encrypt 获取免费 SSL 证书：
```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

**Section sources**
- [next.config.ts](file://next.config.ts#L20-L45)

## 健康检查与监控

### 健康检查端点

系统提供健康检查 API 端点 `/api/health`：

```typescript
// src/app/api/health/route.ts
export async function GET(request: NextRequest) {
  try {
    // 测试数据库连接
    await prisma.$queryRaw`SELECT 1`;
    
    return NextResponse.json({
      success: true,
      message: 'API服务正常',
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    return NextResponse.json({
      success: false,
      message: 'API服务异常',
      database: 'disconnected'
    }, { status: 500 });
  }
}
```

可通过以下方式测试：
```bash
curl http://localhost:3000/api/health
```

### 监控建议

1. **应用监控**：
   - 使用 PM2 实时监控：`pm2 monit`
   - 设置日志轮转，防止日志文件过大

2. **系统监控**：
   - 监控 CPU、内存、磁盘使用率（建议 CPU < 70%, 内存 < 80%）
   - 监控数据库连接数和性能

3. **告警设置**：
   - 健康检查失败时发送告警
   - 应用进程异常退出时通知运维人员
   - 磁盘空间不足时预警

4. **日志分析**：
   - 定期检查错误日志 `./logs/error.log`
   - 分析访问日志以优化性能

5. **高级监控命令**：
   ```bash
   pm2 show yunqi-platform          # 详细进程信息
   pm2 describe yunqi-platform      # 进程描述
   pm2 jlist | jq ".[0].monit"     # JSON格式监控数据
   ```

6. **故障排查**：
   ```bash
   pm2 logs yunqi-platform --err   # 查看错误日志
   pm2 reset yunqi-platform        # 重置重启计数器
   pm2 ping                        # 检查PM2守护进程
   ```

```mermaid
graph LR
A["健康检查"] --> B["API服务"]
A --> C["数据库连接"]
B --> D{"服务正常?"}
C --> E{"数据库连接?"}
D --> |是| F["返回200"]
D --> |否| G["返回500"]
E --> |是| H["标记connected"]
E --> |否| I["标记disconnected"]
```

**Diagram sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L1-L25)

**Section sources**
- [src/app/api/health/route.ts](file://src/app/api/health/route.ts#L1-L25)
- [ecosystem.config.js](file://ecosystem.config.js#L1-L257)