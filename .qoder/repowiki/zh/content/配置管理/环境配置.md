# 环境配置

<cite>
**本文档中引用的文件**  
- [auth-utils.ts](file://src/lib/auth-utils.ts)
- [db-utils.ts](file://src/lib/db-utils.ts)
- [oss.ts](file://src/lib/oss.ts)
- [prisma.ts](file://src/lib/prisma.ts)
- [auth.ts](file://src/lib/auth.ts)
- [ecosystem.config.js](file://ecosystem.config.js)
- [test-oss.ts](file://test-oss.ts)
- [run-oss-test.js](file://run-oss-test.js)
- [schema.prisma](file://prisma/schema.prisma)
- [next-auth.d.ts](file://src/types/next-auth.d.ts)
- [platform-config\route.ts](file://src/app/api/platform-config/route.ts)
</cite>

## 目录
1. [环境变量总览](#环境变量总览)
2. [数据库连接配置](#数据库连接配置)
3. [身份认证配置](#身份认证配置)
4. [OSS存储服务配置](#oss存储服务配置)
5. [环境配置文件管理](#环境配置文件管理)
6. [模块中环境变量的使用方式](#模块中环境变量的使用方式)
7. [常见配置错误排查](#常见配置错误排查)
8. [敏感信息保护最佳实践](#敏感信息保护最佳实践)

## 环境变量总览

本项目依赖多个环境变量来配置数据库连接、身份认证、对象存储服务等核心功能。这些变量根据开发、测试、生产环境的不同而有所区分，确保系统在不同部署阶段的安全性和灵活性。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L116)
- [test-oss.ts](file://test-oss.ts#L295-L337)
- [run-oss-test.js](file://run-oss-test.js#L0-L41)

## 数据库连接配置

### DATABASE_URL
- **用途**：定义数据库连接字符串，用于Prisma ORM连接SQLite或PostgreSQL数据库。
- **取值格式**：`postgresql://user:password@host:port/dbname` 或 `file:./dev.db`（SQLite）。
- **安全建议**：生产环境中应使用强密码，并通过VPC或私有网络限制数据库访问。

```mermaid
flowchart TD
A["应用启动"] --> B["加载 .env 文件"]
B --> C["读取 DATABASE_URL"]
C --> D["初始化 Prisma Client"]
D --> E["建立数据库连接"]
E --> F["执行数据操作"]
```

**Diagram sources**
- [prisma.ts](file://src/lib/prisma.ts#L0-L19)
- [schema.prisma](file://prisma/schema.prisma#L4-L6)

**Section sources**
- [prisma.ts](file://src/lib/prisma.ts#L0-L19)
- [schema.prisma](file://prisma/schema.prisma#L4-L6)

## 身份认证配置

### NEXTAUTH_SECRET
- **用途**：NextAuth.js用于签名JWT令牌的密钥，确保会话安全。
- **取值格式**：随机生成的长字符串（推荐64字符以上）。
- **安全建议**：必须为每个环境生成唯一密钥，禁止使用默认值或明文共享。

### NEXTAUTH_URL
- **用途**：指定NextAuth.js服务的公开访问地址（如`https://yunqi.com`）。
- **取值格式**：完整的HTTPS URL。
- **安全建议**：生产环境必须使用HTTPS，避免中间人攻击。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Auth as "NextAuth"
participant DB as "数据库"
Client->>Auth : 登录请求
Auth->>DB : 验证用户凭证
DB-->>Auth : 用户数据
Auth->>Auth : 生成JWT使用NEXTAUTH_SECRET
Auth-->>Client : 返回会话令牌
```

**Diagram sources**
- [auth.ts](file://src/lib/auth.ts#L0-L71)
- [next-auth.d.ts](file://src/types/next-auth.d.ts#L0-L22)

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L0-L71)
- [next-auth.d.ts](file://src/types/next-auth.d.ts#L0-L22)

## OSS存储服务配置

### ALI_OSS_ACCESS_KEY_ID 与 ALI_OSS_ACCESS_KEY_SECRET
- **用途**：阿里云OSS服务的访问密钥对，用于身份验证。
- **取值格式**：由阿里云控制台生成的字符串。
- **安全建议**：使用最小权限原则创建专用子账号密钥，定期轮换。

### ALI_OSS_BUCKET 与 ALI_OSS_REGION
- **用途**：指定OSS存储桶名称和所在区域。
- **取值格式**：`bucket-name` 和 `oss-cn-hangzhou` 等标准区域标识。
- **安全建议**：存储桶应配置为私有读写，通过签名URL控制临时访问。

### ALI_OSS_ENDPOINT
- **用途**：OSS服务的自定义访问域名（可选）。
- **取值格式**：如 `https://oss-cn-hangzhou.aliyuncs.com`。
- **安全建议**：启用HTTPS，避免使用HTTP明文传输。

```mermaid
classDiagram
class OSSClient {
+region : string
+accessKeyId : string
+accessKeySecret : string
+bucket : string
+endpoint : string
+put(file, key)
+get(key)
+delete(key)
}
OSSClient --> "使用" env : "环境变量"
env : "环境变量" --> ALIOSSAccessKey
env : "环境变量" --> ALIOSSBucket
env : "环境变量" --> ALIOSSRegion
```

**Diagram sources**
- [oss.ts](file://src/lib/oss.ts#L0-L53)
- [test-oss.ts](file://test-oss.ts#L61-L103)

**Section sources**
- [oss.ts](file://src/lib/oss.ts#L0-L53)
- [test-oss.ts](file://test-oss.ts#L61-L103)

## 环境配置文件管理

项目支持多环境配置，通过`.env.local`、`.env.development`、`.env.production`等文件区分不同环境变量。

- **开发环境**：使用`.env.development`，可包含调试信息。
- **生产环境**：使用`.env.production`，所有敏感信息需加密管理。
- **PM2集成**：`ecosystem.config.js`中定义了`env_development`和`env_production`块，支持进程管理器直接注入环境变量。

```mermaid
flowchart LR
A[".env"] --> B["默认变量"]
C[".env.local"] --> D["本地覆盖"]
E[".env.development"] --> F["开发环境"]
G[".env.production"] --> H["生产环境"]
B --> App
D --> App
F --> App
H --> App
```

**Diagram sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L116)

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L1-L116)

## 模块中环境变量的使用方式

### 认证模块 (auth-utils.ts)
通过`getServerSession`结合`authOptions`读取`NEXTAUTH_SECRET`，实现服务端会话管理。

### 数据库模块 (db-utils.ts)
`prisma`客户端在初始化时自动读取`DATABASE_URL`，无需手动传参。

### OSS模块 (oss.ts)
`ossClient`在模块加载时从环境变量构建配置，所有上传、下载操作复用同一实例。

```mermaid
flowchart TB
subgraph "环境变量注入"
A[".env 文件"] --> B["Node.js process.env"]
end
subgraph "模块使用"
B --> C["prisma.ts: DATABASE_URL"]
B --> D["auth.ts: NEXTAUTH_SECRET"]
B --> E["oss.ts: ALI_OSS_*"]
end
```

**Diagram sources**
- [auth-utils.ts](file://src/lib/auth-utils.ts#L0-L23)
- [db-utils.ts](file://src/lib/db-utils.ts#L0-L67)
- [oss.ts](file://src/lib/oss.ts#L0-L53)

**Section sources**
- [auth-utils.ts](file://src/lib/auth-utils.ts#L0-L23)
- [db-utils.ts](file://src/lib/db-utils.ts#L0-L67)
- [oss.ts](file://src/lib/oss.ts#L0-L53)

## 常见配置错误排查

| 错误现象 | 可能原因 | 解决方案 |
|--------|--------|--------|
| 数据库连接失败 | DATABASE_URL格式错误或服务未启动 | 验证连接字符串，检查数据库服务状态 |
| 认证异常（401） | NEXTAUTH_SECRET不匹配或缺失 | 确保所有实例使用相同密钥 |
| OSS上传失败 | 凭证无效或存储桶权限不足 | 检查密钥有效性，确认RAM策略配置 |
| 签名URL无效 | ALI_OSS_REGION或ALI_OSS_BUCKET错误 | 核对区域和存储桶名称拼写 |

**Section sources**
- [test-oss.ts](file://test-oss.ts#L295-L337)
- [run-oss-test.js](file://run-oss-test.js#L0-L41)

## 敏感信息保护最佳实践

1. **禁止提交到版本控制**：`.env`文件必须加入`.gitignore`。
2. **使用密钥管理服务**：生产环境推荐使用AWS KMS、阿里云KMS等服务动态获取密钥。
3. **最小权限原则**：OSS访问密钥应仅授予必要权限（如仅上传、仅删除）。
4. **定期轮换密钥**：每90天更换一次`NEXTAUTH_SECRET`和OSS密钥。
5. **运行时注入**：通过CI/CD管道或容器编排平台（如Kubernetes Secrets）注入环境变量。

**Section sources**
- [run-oss-test.js](file://run-oss-test.js#L0-L41)
- [ecosystem.config.js](file://ecosystem.config.js#L1-L116)