# 配置管理

<cite>
**本文档引用文件**  
- [.env](file://.env)
- [ecosystem.config.js](file://ecosystem.config.js)
- [src/components/admin/UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx)
- [src/components/admin/PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx)
- [src/app/api/admin/upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts)
- [src/app/api/platform-config/route.ts](file://src/app/api/platform-config/route.ts)
- [prisma/migrations/20250905150839_add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)
- [prisma/migrations/20250905143157_add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)
- [src/lib/prisma.ts](file://src/lib/prisma.ts)
</cite>

## 目录
1. [环境配置](#环境配置)
2. [运行时配置](#运行时配置)
3. [PM2进程管理配置](#pm2进程管理配置)
4. [配置最佳实践](#配置最佳实践)
5. [系统部署与运维指引](#系统部署与运维指引)

## 环境配置

本项目通过 `.env` 文件管理环境变量，涵盖数据库连接、OSS 凭证和认证密钥等关键配置。这些变量在不同环境（开发/生产）中应分别设置，确保安全性和灵活性。

### 数据库连接配置
- **DATABASE_URL**: 数据库连接字符串，格式为 `postgresql://user:password@host:port/dbname`，用于 Prisma ORM 连接 PostgreSQL 数据库。
- **配置示例**: `postgresql://yunqi:password@localhost:5432/yunqi_db`

### OSS 凭证配置
- **ALI_OSS_REGION**: 阿里云 OSS 存储区域，如 `oss-cn-hangzhou`。
- **ALI_OSS_ACCESS_KEY_ID**: 阿里云访问密钥 ID，用于身份验证。
- **ALI_OSS_ACCESS_KEY_SECRET**: 阿里云访问密钥密钥，敏感信息需加密存储。
- **ALI_OSS_BUCKET**: OSS 存储桶名称，用于存放上传的文件。
- **ALI_OSS_ENDPOINT**: OSS 自定义域名或服务端点，用于访问存储资源。

### 认证密钥配置
- **NEXTAUTH_SECRET**: NextAuth.js 用于签名 JWT 和加密会话的密钥，必须为高强度随机字符串。
- **NEXTAUTH_URL**: 认证服务的完整 URL，如 `http://localhost:3000`。

**Section sources**
- [run-oss-test.js](file://run-oss-test.js#L0-L41)
- [test-oss.ts](file://test-oss.ts#L61-L103)
- [src/lib/prisma.ts](file://src/lib/prisma.ts#L0-L19)

## 运行时配置

运行时配置通过管理后台动态调整，存储在数据库中，由特定 API 管理，支持实时生效。

### 上传配置管理
上传限制（如文件大小、类型）通过 `UploadConfigManagement` 组件在管理后台进行动态调整。该配置存储在数据库的 `upload_configs` 表中。

#### 配置项说明
- **isEnabled**: 布尔值，控制上传功能是否开启。
- **startTime/endTime**: 时间戳，定义上传功能的开放时间段。
- **maxUploadsPerUser**: 整数，限制每个用户最大上传数量。
- **maxFileSize**: 整数，限制单个文件最大大小（字节）。
- **allowedFormats**: 字符串数组，定义允许上传的文件格式（如 jpg, png）。
- **announcement**: 字符串，可选，用于向用户展示公告信息。

#### API 管理
- **GET /api/admin/upload-config**: 获取当前上传配置。
- **POST /api/admin/upload-config**: 创建或更新上传配置，需管理员权限。

```mermaid
flowchart TD
A[管理后台] --> B[UploadConfigManagement 组件]
B --> C[调用 /api/admin/upload-config API]
C --> D{数据库操作}
D --> E[prisma.uploadConfig.create]
D --> F[prisma.uploadConfig.update]
E --> G[创建新配置记录]
F --> H[更新现有配置]
G --> I[返回成功响应]
H --> I
I --> J[前端刷新配置]
```

**Diagram sources**
- [src/components/admin/UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L0-L48)
- [src/app/api/admin/upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L0-L45)

**Section sources**
- [src/components/admin/UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L0-L48)
- [src/app/api/admin/upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L0-L45)
- [prisma/migrations/20250905143157_add_online_counter_config/migration.sql](file://prisma/migrations/20250905143157_add_online_counter_config/migration.sql)

### 平台配置管理
平台主标题等全局配置通过 `PlatformConfigManagement` 组件管理，存储在 `platform_configs` 表中。

#### 配置项说明
- **title**: 字符串，平台主标题，最长 100 个字符。
- **updatedAt**: 时间戳，记录最后更新时间。

#### API 管理
- **GET /api/platform-config**: 获取平台配置，若无配置则创建默认值。
- **POST /api/platform-config**: 更新平台配置，需管理员权限。

```mermaid
classDiagram
class PlatformConfig {
+id : string
+title : string
+updatedAt : string
}
class PlatformConfigManagement {
+fetchConfig() : Promise~void~
+saveConfig() : Promise~void~
}
class PlatformConfigAPI {
+GET() : NextResponse
+POST() : NextResponse
}
PlatformConfigManagement --> PlatformConfig : "显示"
PlatformConfigManagement --> PlatformConfigAPI : "调用"
PlatformConfigAPI --> PlatformConfig : "操作"
```

**Diagram sources**
- [src/components/admin/PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx#L5-L9)
- [src/app/api/platform-config/route.ts](file://src/app/api/platform-config/route.ts#L0-L42)
- [prisma/migrations/20250905150839_add_platform_config/migration.sql](file://prisma/migrations/20250905150839_add_platform_config/migration.sql)

**Section sources**
- [src/components/admin/PlatformConfigManagement.tsx](file://src/components/admin/PlatformConfigManagement.tsx#L0-L43)
- [src/app/api/platform-config/route.ts](file://src/app/api/platform-config/route.ts#L0-L42)

## PM2进程管理配置

生产环境使用 PM2 进行进程管理，配置文件为 `ecosystem.config.js`，确保应用高可用和自动重启。

### 应用配置
- **yunqi-platform**: 生产环境应用，运行 `npm start`，监听端口 3000。
- **yunqi-platform-dev**: 开发环境应用，运行 `npm run dev`，监听端口 3001。

### 进程管理参数
- **instances**: 实例数量，生产环境建议设为 `max` 以利用所有 CPU 核心。
- **autorestart**: 启用自动重启，当应用崩溃时自动恢复。
- **max_memory_restart**: 内存限制，达到 8GB 时重启应用。
- **watch**: 开发环境启用文件监听，代码变更时自动重启。

### 日志配置
- **log_file**: 综合日志文件路径 `./logs/combined.log`。
- **out_file**: 标准输出日志路径 `./logs/out.log`。
- **error_file**: 错误日志路径 `./logs/error.log`。
- **log_date_format**: 日志时间格式 `YYYY-MM-DD HH:mm:ss Z`。

### 部署配置
支持通过 Git 部署到远程服务器，包含预部署和后部署脚本，自动化安装依赖和重启服务。

**Section sources**
- [ecosystem.config.js](file://ecosystem.config.js#L0-L109)

## 配置最佳实践

### 敏感信息加密
所有敏感信息（如数据库密码、OSS 密钥、认证密钥）必须加密存储，避免明文暴露。建议使用环境变量管理，并在 `.env` 文件中使用高强度随机值。

### 环境配置分离
- **开发环境**: 使用 `.env.local` 文件，配置本地数据库和测试 OSS 账号。
- **生产环境**: 使用 `.env.production` 文件，配置生产数据库和正式 OSS 账号。
- **配置原则**: 不同环境使用不同配置，避免交叉污染。

### 配置验证
在应用启动时验证关键配置（如数据库连接、OSS 凭证），确保配置完整有效。可参考 `run-oss-test.js` 中的验证逻辑。

## 系统部署与运维指引

### 部署流程
1. 配置 `.env` 文件，确保所有环境变量正确设置。
2. 安装 PM2: `npm install -g pm2`。
3. 启动生产环境: `pm2 start ecosystem.config.js --env production`。
4. 保存 PM2 配置: `pm2 save`，并设置开机自启: `pm2 startup`。

### 运维操作
- **查看状态**: `pm2 status`
- **查看日志**: `pm2 logs yunqi-platform --lines 100`
- **重启应用**: `pm2 restart yunqi-platform`
- **停止应用**: `pm2 stop yunqi-platform`

### 故障排查
- 检查日志文件 `./logs/error.log` 定位错误。
- 验证环境变量是否完整，参考 `test-oss.ts` 的检查逻辑。
- 确保数据库连接正常，使用 `verify-database.ts` 脚本测试。