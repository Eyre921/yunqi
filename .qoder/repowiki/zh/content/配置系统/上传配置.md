# 上传配置

<cite>
**本文档中引用的文件**  
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts)
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx)
- [work.d.ts](file://src/types/work.d.ts)
- [upload/route.ts](file://src/app/api/upload/route.ts)
- [page.tsx](file://src/app/upload/page.tsx)
- [works/route.ts](file://src/app/api/works/route.ts)
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本系统实现了灵活且安全的上传配置管理机制，支持管理员通过管理后台动态设置上传限制，包括文件类型白名单、文件大小限制、上传时间窗口等。配置数据存储在数据库 `upload_configs` 表中，并通过 API 实时提供给前端和上传服务。系统采用 Zod 进行严格的请求体校验，确保数据完整性，并在上传时实时应用配置策略，无需重启服务即可生效。

## 项目结构
上传配置功能涉及多个模块，包括管理后台界面、API 接口、类型定义和数据库迁移。

```mermaid
graph TB
subgraph "前端"
A[UploadConfigManagement.tsx]
B[upload/page.tsx]
end
subgraph "API"
C[api/admin/upload-config/route.ts]
D[api/upload/route.ts]
E[api/works/route.ts]
end
subgraph "类型与数据"
F[types/work.d.ts]
G[prisma/migrations/migration.sql]
end
A --> C
B --> C
B --> D
D --> C
E --> C
F --> A
F --> C
G --> C
```

**Diagram sources**
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx)
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts)
- [work.d.ts](file://src/types/work.d.ts)

**Section sources**
- [src](file://src)
- [prisma](file://prisma)

## 核心组件
系统通过 `upload_configs` 数据表存储配置，由管理界面 `UploadConfigManagement` 提供可视化操作，API `upload-config/route.ts` 提供读写接口，多个上传相关 API 在处理请求时动态获取并应用当前配置。

**Section sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L1-L150)
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L1-L333)
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql#L93-L121)

## 架构概述
系统采用分层架构，前端管理界面通过 API 与后端交互，配置数据持久化存储于数据库。上传功能在运行时动态查询最新配置，实现策略的实时生效。

```mermaid
sequenceDiagram
participant Admin as 管理员
participant UI as 管理界面
participant API as 上传配置API
participant DB as 数据库
participant UploadAPI as 上传API
Admin->>UI : 打开配置页面
UI->>API : GET /api/admin/upload-config
API->>DB : 查询最新配置
DB-->>API : 返回配置数据
API-->>UI : 返回JSON响应
UI-->>Admin : 显示配置表单
Admin->>UI : 修改配置并保存
UI->>API : POST /api/admin/upload-config
API->>API : 使用Zod校验数据
API->>DB : 创建新配置记录
DB-->>API : 返回成功
API-->>UI : 返回成功响应
UI-->>Admin : 显示保存成功
Note over UploadAPI : 用户上传时
UploadAPI->>API : 查询当前配置
API->>DB : 获取最新配置
DB-->>API : 返回配置
API-->>UploadAPI : 返回配置数据
UploadAPI->>UploadAPI : 根据配置校验文件类型、大小等
```

**Diagram sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L1-L150)
- [upload/route.ts](file://src/app/api/upload/route.ts#L39-L76)

## 详细组件分析

### 上传配置管理界面分析
管理界面提供表单用于配置上传策略，包括功能开关、时间窗口、上传限制和文件格式等。

```mermaid
flowchart TD
Start([加载配置]) --> Fetch["fetch('/api/admin/upload-config')"]
Fetch --> CheckSuccess{"请求成功?"}
CheckSuccess --> |是| UpdateUI["更新表单状态"]
CheckSuccess --> |否| ShowError["显示错误信息"]
Save["点击保存按钮"] --> ValidateForm["前端基础验证"]
ValidateForm --> SendRequest["发送POST请求"]
SendRequest --> CheckResponse{"响应成功?"}
CheckResponse --> |是| ShowSuccess["显示成功提示"]
CheckResponse --> |否| ShowSaveError["显示保存失败"]
UpdateUI --> RenderForm["渲染配置表单"]
RenderForm --> EnableToggle["功能开关"]
RenderForm --> TimeRange["时间范围设置"]
RenderForm --> UploadLimit["上传数量限制"]
RenderForm --> FileSize["文件大小滑块"]
RenderForm --> FormatCheckboxes["文件格式复选框"]
RenderForm --> Announcement["公告输入框"]
EnableToggle --> Save
TimeRange --> Save
UploadLimit --> Save
FileSize --> Save
FormatCheckboxes --> Save
Announcement --> Save
```

**Diagram sources**
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L1-L333)

**Section sources**
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx#L1-L333)

### 上传配置API分析
API 提供 GET 和 POST 接口，分别用于获取当前配置和创建新配置。使用 Zod 进行请求体校验，并包含时间逻辑验证。

```mermaid
classDiagram
class UploadConfigSchema {
+isEnabled : boolean
+startTime : string | null
+endTime : string | null
+maxUploadsPerUser : number
+maxFileSize : number
+allowedFormats : string[]
+announcement : string | null
}
class UploadConfigAPI {
+GET() : 返回最新配置或默认值
+POST(request) : 创建新配置
-validateTimeLogic() : 验证开始时间早于结束时间
}
class UploadConfig {
+id : string
+isEnabled : boolean
+startTime : Date | null
+endTime : Date | null
+maxUploadsPerUser : number
+maxFileSize : number
+allowedFormats : string[]
+announcement : string | null
+createdAt : Date
+updatedAt : Date
+createdBy : string
}
UploadConfigAPI --> UploadConfigSchema : "使用"
UploadConfigAPI --> UploadConfig : "创建"
UploadConfig --> User : "外键 createdBy"
```

**Diagram sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L7-L150)
- [work.d.ts](file://src/types/work.d.ts#L52-L64)
- [migration.sql](file://prisma/migrations/20250831084947_add_featured_field/migration.sql#L93-L121)

**Section sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L1-L150)

### 上传功能安全策略分析
上传相关 API 在处理请求前，首先获取当前上传配置，并据此执行一系列安全校验。

```mermaid
flowchart TD
UploadRequest["收到上传请求"] --> GetConfig["获取当前上传配置"]
GetConfig --> CheckEnabled{"上传功能启用?"}
CheckEnabled --> |否| Return403["返回403 Forbidden"]
CheckEnabled --> |是| CheckTimeWindow["检查时间窗口"]
CheckTimeWindow --> TimeValid{"在有效期内?"}
TimeValid --> |否| ReturnTimeError["返回时间错误"]
TimeValid --> |是| CheckFileType["检查文件类型"]
CheckFileType --> TypeValid{"类型在白名单?"}
TypeValid --> |否| ReturnTypeError["返回类型错误"]
TypeValid --> |是| CheckFileSize["检查文件大小"]
CheckFileSize --> SizeValid{"大小符合限制?"}
SizeValid --> |否| ReturnSizeError["返回大小错误"]
SizeValid --> |是| ProcessUpload["继续处理上传"]
```

**Diagram sources**
- [upload/route.ts](file://src/app/api/upload/route.ts#L39-L76)
- [works/route.ts](file://src/app/api/works/route.ts#L130-L167)
- [page.tsx](file://src/app/upload/page.tsx#L115-L160)

**Section sources**
- [upload/route.ts](file://src/app/api/upload/route.ts#L1-L150)
- [works/route.ts](file://src/app/api/works/route.ts#L1-L200)
- [page.tsx](file://src/app/upload/page.tsx#L1-L300)

## 依赖分析
系统各组件间依赖关系清晰，前端组件依赖 API 接口，API 接口依赖数据库和类型定义。

```mermaid
graph LR
UploadConfigManagement --> upload-config-api
upload-page --> upload-config-api
upload-api --> upload-config-api
works-api --> upload-config-api
upload-config-api --> prisma
prisma --> upload_configs_table
types --> UploadConfigManagement
types --> upload-config-api
```

**Diagram sources**
- [UploadConfigManagement.tsx](file://src/components/admin/UploadConfigManagement.tsx)
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts)
- [upload/route.ts](file://src/app/api/upload/route.ts)
- [works/route.ts](file://src/app/api/works/route.ts)
- [work.d.ts](file://src/types/work.d.ts)

**Section sources**
- [src](file://src)
- [prisma](file://prisma)

## 性能考虑
配置数据在每次上传时动态查询，虽然保证了实时性，但可能增加数据库负载。建议在高并发场景下引入缓存机制，如 Redis，缓存最新配置，设置合理的过期时间或通过事件驱动更新缓存，避免频繁数据库查询。

## 故障排除指南
常见问题包括配置未生效、上传被拒绝等。检查日志中的错误信息，确认配置是否已成功保存，检查时间设置是否正确，验证文件类型和大小是否符合当前配置。开发环境下可查看详细的 Zod 校验错误信息。

**Section sources**
- [upload-config/route.ts](file://src/app/api/admin/upload-config/route.ts#L131-L150)
- [upload/route.ts](file://src/app/api/upload/route.ts#L39-L76)

## 结论
该上传配置模块设计合理，实现了动态、安全的上传策略管理。通过数据库存储配置，API 提供接口，前端实现管理，多处应用实时校验，形成了完整的闭环。未来可考虑引入缓存优化性能，并增加配置版本管理功能。