# 云栖平台压力测试工具使用说明

## 📋 目录
- [工具概述](#工具概述)
- [快速开始](#快速开始)
- [详细参数说明](#详细参数说明)
- [测试场景配置](#测试场景配置)
- [使用示例](#使用示例)
- [结果分析](#结果分析)
- [最佳实践](#最佳实践)
- [故障排查](#故障排查)
- [性能调优建议](#性能调优建议)

## 🎯 工具概述

本压力测试工具专为云栖平台 (`http://47.238.240.231:3000/`) 设计，支持多种测试模式和详细的性能分析。

### 主要特性
- ✅ 多种测试模式（时长模式、请求数模式）
- ✅ 可配置并发数和测试参数
- ✅ 实时进度显示和统计
- ✅ 详细的性能指标分析
- ✅ 支持配置文件批量测试
- ✅ 结果导出和报告生成
- ✅ 错误统计和分析
- ✅ 响应时间百分位数统计

## 🚀 快速开始

### 1. 基础测试
```powershell
# 最简单的测试（10并发，60秒）
.\stress-test.ps1

# 显示实时进度
.\stress-test.ps1 -ShowProgress
```

### 2. 自定义参数测试
```powershell
# 50并发，测试5分钟
.\stress-test.ps1 -Concurrent 50 -Duration 300 -ShowProgress

# 固定1000个请求，20并发
.\stress-test.ps1 -TestMode requests -Requests 1000 -Concurrent 20
```

### 3. 使用配置文件
```powershell
# 使用预定义的测试场景
.\stress-test.ps1 -ConfigFile "stress-test-config.json"
```

## 📖 详细参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `-Url` | String | `http://47.238.240.231:3000/` | 目标URL |
| `-Concurrent` | Int | 10 | 并发用户数 |
| `-Duration` | Int | 60 | 测试时长（秒） |
| `-Requests` | Int | 0 | 总请求数（请求模式） |
| `-Method` | String | GET | HTTP方法 |
| `-TestMode` | String | duration | 测试模式：duration/requests |
| `-ConfigFile` | String | - | 配置文件路径 |
| `-OutputFile` | String | - | 结果输出文件 |
| `-Verbose` | Switch | - | 显示详细日志 |
| `-ShowProgress` | Switch | - | 显示实时进度 |

### 测试模式说明

#### Duration 模式（时长模式）
- 在指定时间内持续发送请求
- 适合测试系统在特定时间段内的表现
- 参数：`-Duration` 指定测试时长（秒）

#### Requests 模式（请求数模式）
- 发送固定数量的请求后结束
- 适合测试特定负载下的系统响应
- 参数：`-Requests` 指定总请求数

## ⚙️ 测试场景配置

配置文件 `stress-test-config.json` 包含多种预定义场景：

### 内置测试场景

| 场景名称 | 并发数 | 时长/请求数 | 用途 |
|----------|--------|-------------|------|
| `light_load` | 5 | 30秒 | 轻负载基础验证 |
| `normal_load` | 20 | 120秒 | 正常业务负载 |
| `high_load` | 50 | 300秒 | 高峰期负载 |
| `stress_test` | 100 | 600秒 | 压力极限测试 |
| `spike_test` | 200 | 60秒 | 峰值冲击测试 |
| `endurance_test` | 30 | 1800秒 | 长期稳定性测试 |

### 自定义配置示例
```json
{
  "url": "http://47.238.240.231:3000/api/works",
  "concurrent": 25,
  "duration": 180,
  "method": "GET",
  "testMode": "duration"
}
```

## 💡 使用示例

### 1. 基础功能测试
```powershell
# 轻量级测试，验证基本功能
.\stress-test.ps1 -Concurrent 5 -Duration 30 -Verbose
```

### 2. 性能基准测试
```powershell
# 建立性能基准线
.\stress-test.ps1 -Concurrent 20 -Duration 120 -ShowProgress -OutputFile "baseline.json"
```

### 3. 高并发压力测试
```powershell
# 测试系统极限
.\stress-test.ps1 -Concurrent 100 -Duration 300 -ShowProgress -OutputFile "stress_result.json"
```

### 4. API接口专项测试
```powershell
# 测试特定API接口
.\stress-test.ps1 -Url "http://47.238.240.231:3000/api/works" -Concurrent 30 -Duration 180
```

### 5. 批量场景测试
```powershell
# 使用配置文件进行多场景测试
$scenarios = @("light_load", "normal_load", "high_load")
foreach ($scenario in $scenarios) {
    Write-Host "开始测试场景: $scenario"
    # 这里需要修改配置文件或使用不同的配置文件
    .\stress-test.ps1 -ConfigFile "config_$scenario.json" -OutputFile "result_$scenario.json"
    Start-Sleep -Seconds 30  # 场景间休息30秒
}
```

## 📊 结果分析

### 关键性能指标

#### 1. 吞吐量指标
- **RPS (Requests Per Second)**: 每秒请求数
- **总请求数**: 测试期间发送的总请求数
- **成功率**: 成功请求占总请求的百分比

#### 2. 响应时间指标
- **平均响应时间**: 所有请求的平均响应时间
- **最小/最大响应时间**: 响应时间的范围
- **中位数**: 50%的请求响应时间
- **95%分位数**: 95%的请求在此时间内完成
- **99%分位数**: 99%的请求在此时间内完成

#### 3. 错误分析
- **错误类型统计**: 不同错误的出现次数
- **错误率趋势**: 错误随时间的变化

### 性能评估标准

| 指标 | 优秀 | 良好 | 可接受 | 需优化 |
|------|------|------|--------|--------|
| 响应时间 | <200ms | <500ms | <1000ms | >1000ms |
| 成功率 | >99.9% | >99.5% | >99.0% | <99.0% |
| RPS | 根据业务需求 | - | - | - |

### 结果文件格式
```json
{
  "TestConfiguration": {
    "Url": "http://47.238.240.231:3000/",
    "Concurrent": 20,
    "Duration": 120
  },
  "Statistics": {
    "TotalRequests": 2400,
    "SuccessfulRequests": 2395,
    "FailedRequests": 5,
    "SuccessRate": 99.79,
    "RequestsPerSecond": 20.0,
    "AvgResponseTime": 245.6,
    "P95ResponseTime": 450,
    "P99ResponseTime": 680
  }
}
```

## 🎯 最佳实践

### 1. 测试前准备
- ✅ 确认目标服务器状态正常
- ✅ 检查网络连接稳定性
- ✅ 确保测试机器资源充足
- ✅ 通知相关人员测试时间

### 2. 测试策略
- 📈 **渐进式测试**: 从低并发开始，逐步增加
- ⏱️ **分阶段测试**: 短期→中期→长期
- 🎯 **场景化测试**: 模拟真实业务场景
- 📊 **基准对比**: 建立性能基准线

### 3. 测试执行
```powershell
# 推荐的测试序列
# 1. 连通性测试
.\stress-test.ps1 -Concurrent 1 -Duration 10

# 2. 轻负载测试
.\stress-test.ps1 -Concurrent 5 -Duration 60 -ShowProgress

# 3. 正常负载测试
.\stress-test.ps1 -Concurrent 20 -Duration 300 -ShowProgress -OutputFile "normal_load.json"

# 4. 高负载测试
.\stress-test.ps1 -Concurrent 50 -Duration 300 -ShowProgress -OutputFile "high_load.json"

# 5. 压力测试
.\stress-test.ps1 -Concurrent 100 -Duration 600 -ShowProgress -OutputFile "stress_test.json"
```

### 4. 监控要点
- 🖥️ **服务器资源**: CPU、内存、磁盘I/O
- 🌐 **网络状况**: 带宽使用、延迟
- 📊 **应用指标**: 响应时间、错误率
- 🗄️ **数据库性能**: 连接数、查询时间

## 🔧 故障排查

### 常见问题及解决方案

#### 1. 连接超时
**现象**: 大量连接超时错误
```
错误: 操作超时
```

**解决方案**:
- 检查网络连接
- 降低并发数
- 增加超时时间
- 检查服务器负载

#### 2. 内存不足
**现象**: PowerShell进程内存占用过高
```
错误: 内存不足
```

**解决方案**:
- 降低并发数
- 缩短测试时间
- 增加系统内存
- 分批次测试

#### 3. 权限问题
**现象**: 无法创建输出文件
```
错误: 拒绝访问
```

**解决方案**:
- 以管理员身份运行PowerShell
- 检查文件夹权限
- 更改输出路径

#### 4. 服务器过载
**现象**: 响应时间急剧增加，错误率上升
```
成功率: 85%
平均响应时间: 5000ms
```

**解决方案**:
- 立即停止测试（Ctrl+C）
- 检查服务器状态
- 降低测试强度
- 分析服务器瓶颈

### 调试技巧

#### 1. 启用详细日志
```powershell
.\stress-test.ps1 -Verbose -ShowProgress
```

#### 2. 小规模验证
```powershell
# 先用小并发验证
.\stress-test.ps1 -Concurrent 2 -Duration 10 -Verbose
```

#### 3. 分段测试
```powershell
# 分多个阶段测试
.\stress-test.ps1 -Concurrent 10 -Duration 60
.\stress-test.ps1 -Concurrent 20 -Duration 60
.\stress-test.ps1 -Concurrent 30 -Duration 60
```

## ⚡ 性能调优建议

### 1. 客户端优化
- 🖥️ **硬件配置**: 使用高性能测试机器
- 🌐 **网络环境**: 确保网络带宽充足
- ⚙️ **系统设置**: 调整系统连接数限制

### 2. 测试参数调优
```powershell
# 针对不同场景的推荐配置

# 响应时间测试（低并发，关注延迟）
.\stress-test.ps1 -Concurrent 5 -Duration 300

# 吞吐量测试（高并发，关注RPS）
.\stress-test.ps1 -Concurrent 100 -Duration 180

# 稳定性测试（中等并发，长时间）
.\stress-test.ps1 -Concurrent 30 -Duration 1800
```

### 3. 服务器监控
在测试期间，建议同时监控服务器指标：
- CPU使用率
- 内存使用率
- 网络I/O
- 磁盘I/O
- 数据库连接数

### 4. 结果对比分析
```powershell
# 建立基准
.\stress-test.ps1 -Concurrent 20 -Duration 120 -OutputFile "baseline.json"

# 优化后测试
.\stress-test.ps1 -Concurrent 20 -Duration 120 -OutputFile "optimized.json"

# 对比分析两次结果
```

## 📞 技术支持

如遇到问题，请检查：
1. PowerShell版本（建议5.0+）
2. 网络连接状态
3. 目标服务器状态
4. 系统资源使用情况

---

**注意事项**:
- ⚠️ 压力测试可能对目标服务器造成负载，请在合适的时间进行
- ⚠️ 建议先在测试环境验证脚本功能
- ⚠️ 生产环境测试需要提前通知相关人员
- ⚠️ 测试过程中密切监控服务器状态，必要时立即停止测试